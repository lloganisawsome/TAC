<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TAC Drawing - Collaborative</title>
  <style>
    :root {
      --bg: #0a0a0b;
      --panel: #111113;
      --panel-hover: #1a1a1c;
      --accent: #22c55e;
      --accent-600: #16a34a;
      --accent-dim: rgba(34, 197, 94, 0.1);
      --glass-border: rgba(255,255,255,0.06);
      --card: rgba(17, 17, 19, 0.95);
      --muted: #71717a;
      --border: rgba(255,255,255,0.06);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: white;
      overflow: hidden;
      height: 100vh;
    }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

    /* Sidebar - Exact from file2 */
    .sidebar {
      position: fixed;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 70px;
      background: var(--panel);
      border: 1px solid var(--accent);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 0;
      transition: all 0.3s ease;
      z-index: 1000;
      box-shadow: 0 0 20px var(--accent-dim);
    }

    .sidebar.collapsed {
      width: 0;
      padding: 0;
      border: none;
      margin-left: -10px;
      overflow: hidden;
    }

    .logo-container {
      margin-bottom: 16px;
      padding: 4px;
      transition: opacity 0.3s;
    }

    .sidebar.collapsed .logo-container {
      opacity: 0;
    }

    .logo {
      width: 62px;
      height: 62px;
      border-radius: 8px;
    }

    .nav-items {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      width: 100%;
      padding: 0 8px;
      transition: opacity 0.3s;
    }

    .sidebar.collapsed .nav-items {
      opacity: 0;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 54px;
      height: 54px;
      border-radius: 10px;
      text-decoration: none;
      color: var(--accent);
      transition: all 0.2s ease;
      cursor: pointer;
      background: transparent;
      border: none;
    }

    .nav-item:hover {
      background: var(--accent-dim);
    }

    .nav-item.active {
      background: var(--accent-dim);
      border: 1px solid var(--accent);
    }

    .nav-item svg {
      width: 24px;
      height: 24px;
      margin-bottom: 2px;
    }

    .nav-item span {
      font-size: 9px;
      font-weight: 500;
    }

    .toggle-btn {
      position: fixed;
      left: 90px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 36px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 1001;
    }

    .toggle-btn:hover {
      background: var(--panel-hover);
      border-color: var(--accent);
    }

    .toggle-btn svg {
      width: 14px;
      height: 14px;
      color: #fff;
      transition: transform 0.3s ease;
    }

    .toggle-btn.collapsed {
      left: 10px;
    }

    .toggle-btn.collapsed svg {
      transform: rotate(180deg);
    }
    
    /* Home Page */
    .home-page {
      min-height: 100vh;
      padding: 24px;
      overflow-y: auto;
      margin-left: 100px;
      transition: margin-left 0.3s ease;
    }

    .home-page.expanded {
      margin-left: 24px;
    }
    
    .home-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 1200px;
      margin: 0 auto 32px;
    }
    
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .brand h1 {
      font-size: 24px;
      font-weight: 700;
    }
    
    .btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.1s, box-shadow 0.2s;
      box-shadow: 0 4px 12px var(--accent-dim);
    }
    
    .btn:hover { transform: translateY(-2px); }
    .btn:active { transform: translateY(0); }
    
    .btn-ghost {
      background: var(--panel);
      box-shadow: none;
      border: 1px solid var(--glass-border);
    }
    
    .btn-icon {
      width: 40px;
      height: 40px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
    }
    
    .drawings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .drawing-card {
      background: var(--panel);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .drawing-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.4);
    }
    
    .drawing-thumbnail {
      aspect-ratio: 1;
      background: #0f0f1a;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .drawing-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .drawing-thumbnail svg {
      opacity: 0.3;
    }
    
    .drawing-info {
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .drawing-name {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .drawing-date {
      font-size: 12px;
      color: var(--muted);
    }
    
    .delete-btn {
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      opacity: 0;
      transition: opacity 0.2s, color 0.2s;
    }
    
    .drawing-card:hover .delete-btn { opacity: 1; }
    .delete-btn:hover { color: #ef4444; }
    
    .empty-state {
      text-align: center;
      padding: 80px 20px;
    }
    
    .empty-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      background: var(--panel);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .empty-state h2 {
      font-size: 20px;
      margin-bottom: 8px;
    }
    
    .empty-state p {
      color: var(--muted);
      margin-bottom: 24px;
    }
    
    /* Draw Page */
    .draw-page {
      position: fixed;
      inset: 0;
      display: none;
      margin-left: 100px;
      transition: margin-left 0.3s ease;
    }

    .draw-page.expanded {
      margin-left: 24px;
    }
    
    .draw-page.active { display: block; }
    .home-page.hidden { display: none; }
    
    #canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      cursor: crosshair;
      touch-action: none;
    }
    
    .top-bar {
      position: fixed;
      top: 16px;
      left: 116px;
      right: 16px;
      display: flex;
      justify-content: space-between;
      pointer-events: none;
      z-index: 10;
      transition: left 0.3s ease;
    }

    .draw-page.expanded .top-bar {
      left: 40px;
    }
    
    .top-bar > * { pointer-events: auto; }
    
    .drawing-title {
      background: var(--card);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(20px);
      padding: 8px 16px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .drawing-title input {
      background: transparent;
      border: none;
      color: white;
      font-size: 14px;
      font-weight: 500;
      width: 150px;
      outline: none;
    }
    
    .save-indicator {
      background: var(--card);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(20px);
      padding: 8px 12px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
    }
    
    .save-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .online-users {
      background: var(--card);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(20px);
      padding: 8px 12px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--accent);
    }
    
    /* Toolbar */
    .toolbar {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(20px);
      padding: 12px 16px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 20;
    }
    
    .toolbar-divider {
      width: 1px;
      height: 32px;
      background: var(--glass-border);
      margin: 0 4px;
    }
    
    .tool-btn {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, color 0.2s;
    }
    
    .tool-btn:hover { background: var(--panel); color: white; }
    .tool-btn.active { background: var(--accent); color: white; }
    .tool-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .tool-btn.danger:hover { color: #ef4444; }
    
    .color-preview {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.3);
    }
    
    .size-control {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 8px;
    }
    
    .size-control label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      font-weight: 600;
    }
    
    .size-slider {
      width: 100px;
      height: 4px;
      -webkit-appearance: none;
      background: var(--panel);
      border-radius: 2px;
      outline: none;
    }
    
    .size-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
    }
    
    .size-value {
      font-size: 12px;
      color: var(--muted);
      font-family: monospace;
      min-width: 20px;
    }
    
    /* Panels */
    .panel {
      position: absolute;
      bottom: 100%;
      margin-bottom: 12px;
      background: var(--card);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 12px;
      display: none;
      animation: fadeUp 0.2s ease;
    }
    
    .panel.active { display: block; }
    
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .panel-title {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 12px;
    }
    
    .brush-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      width: 280px;
    }
    
    .brush-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 12px 8px;
      border-radius: 12px;
      border: none;
      background: var(--panel);
      color: var(--muted);
      cursor: pointer;
      font-size: 10px;
      transition: all 0.2s;
    }
    
    .brush-btn:hover { background: rgba(255,255,255,0.1); color: white; }
    .brush-btn.active { background: var(--accent); color: white; }
    
    .color-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      width: 250px;
      margin-bottom: 12px;
    }
    
    .color-btn {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: transform 0.1s;
    }
    
    .color-btn:hover { transform: scale(1.15); }
    .color-btn.active { box-shadow: 0 0 0 2px var(--accent); transform: scale(1.1); }
    
    .color-custom {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .color-display {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: 1px solid var(--glass-border);
    }
    
    .color-input {
      flex: 1;
      background: var(--panel);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      padding: 10px;
      color: white;
      font-family: monospace;
      font-size: 14px;
      outline: none;
    }

    .bg-color-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      width: 200px;
    }

    .bg-color-btn {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }

    .bg-color-btn:hover {
      transform: scale(1.1);
      border-color: var(--accent);
    }

    .bg-color-btn.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-dim);
    }
    
    /* Mobile */
    .mobile-fab {
      display: none;
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      color: white;
      cursor: pointer;
      box-shadow: 0 6px 20px var(--accent-dim);
      z-index: 30;
    }
    
    .mobile-home {
      display: none;
      position: fixed;
      bottom: 24px;
      left: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--card);
      border: 1px solid var(--glass-border);
      color: var(--muted);
      cursor: pointer;
      z-index: 30;
    }
    
    .mobile-menu {
      display: none;
      position: fixed;
      bottom: 96px;
      right: 24px;
      width: 280px;
      background: var(--card);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 16px;
      z-index: 25;
      animation: fadeUp 0.2s ease;
      max-height: 70vh;
      overflow-y: auto;
    }
    
    .mobile-menu.active { display: block; }
    
    .mobile-section {
      margin-bottom: 16px;
    }
    
    .mobile-section:last-child { margin-bottom: 0; }
    
    .mobile-section-title {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .mobile-actions {
      display: flex;
      gap: 8px;
    }
    
    .mobile-actions .tool-btn {
      flex: 1;
      background: var(--panel);
    }
    
    .brush-indicator {
      position: fixed;
      bottom: 24px;
      left: 116px;
      background: var(--card);
      border: 1px solid var(--glass-border);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      color: var(--muted);
      text-transform: capitalize;
      z-index: 10;
      transition: left 0.3s ease;
    }

    .draw-page.expanded .brush-indicator {
      left: 40px;
    }
    
    @media (max-width: 768px) {
      .toolbar { display: none; }
      .brush-indicator { display: none; }
      .mobile-fab { display: flex; align-items: center; justify-content: center; }
      .mobile-home { display: flex; align-items: center; justify-content: center; }
      
      .drawings-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      
      .home-header {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
      }
      
      .brand { justify-content: center; }
      .btn { justify-content: center; }

      .home-page {
        margin-left: 24px;
      }

      .draw-page {
        margin-left: 24px;
      }

      .sidebar {
        display: none;
      }

      .toggle-btn {
        display: none;
      }

      .top-bar {
        left: 16px;
      }

      .brush-indicator {
        left: 24px;
      }
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    
    .modal-overlay.active { display: flex; }
    
    .modal {
      background: var(--panel);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 24px;
      max-width: 420px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal h3 {
      font-size: 18px;
      margin-bottom: 8px;
    }
    
    .modal p {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 20px;
    }
    
    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    .btn-danger {
      background: #dc2626;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }

    .user-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 16px;
    }

    .user-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      margin-bottom: 8px;
      border: 1px solid var(--border);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--accent-dim);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent);
      font-weight: 600;
      font-size: 14px;
    }

    .user-name {
      font-size: 14px;
      font-weight: 500;
    }

    .user-email {
      font-size: 12px;
      color: var(--muted);
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }

    .shared-users {
      margin-bottom: 20px;
    }

    .shared-users-title {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .empty-shared {
      text-align: center;
      padding: 20px;
      color: var(--muted);
      font-size: 13px;
    }
  </style>
</head>
<body>
  <!-- Sidebar - Exact from file2 -->
  <aside class="sidebar" id="sidebar">
    <div class="logo-container">
      <img src="taclogos/green.png" alt="Logo" class="logo" id="logoImg">
    </div>

    <nav class="nav-items">
      <a href="index.html" class="nav-item">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
        </svg>
        <span>Home</span>
      </a>

      <a href="chat.html" class="nav-item">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
          <circle cx="8" cy="10" r="1.5"/>
          <circle cx="12" cy="10" r="1.5"/>
          <circle cx="16" cy="10" r="1.5"/>
        </svg>
        <span>Chat</span>
      </a>



      <a href="notgames.html" class="nav-item">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M21.58 16.09l-1.09-7.66A3.996 3.996 0 0016.53 5H7.47a3.996 3.996 0 00-3.96 3.43l-1.09 7.66C2.2 17.63 3.39 19 4.94 19h0c.68 0 1.32-.27 1.8-.75L9 16h6l2.25 2.25c.48.48 1.13.75 1.8.75h0c1.55 0 2.75-1.37 2.53-2.91zM11 11H9v2H8v-2H6v-1h2V8h1v2h2v1zm4-1c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm2 3c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/>
        </svg>
        <span>Games</span>
      </a>

      <a href="phone.html" class="nav-item">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/>
        </svg>
        <span>Phone</span>
      </a>

      <a href="apps.html" class="nav-item">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z"/>
        </svg>
        <span>All Apps</span>
      </a>
    </nav>
  </aside>

  <button class="toggle-btn" id="toggleBtn">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="15 18 9 12 15 6"/>
    </svg>
  </button>

  <!-- Home Page -->
  <div class="home-page" id="homePage">
    <header class="home-header">
      <div class="brand">
        <h1>TAC Drawing</h1>
      </div>
      <button class="btn" onclick="createNewDrawing()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        New Drawing
      </button>
    </header>
    
    <div id="drawingsContainer"></div>
  </div>

  <!-- Draw Page -->
  <div class="draw-page" id="drawPage">
    <canvas id="canvas"></canvas>
    
    <div class="top-bar">
      <div class="drawing-title">
        <input type="text" id="drawingName" value="Untitled" onchange="updateDrawingName()">
      </div>
      <div style="display: flex; gap: 8px;">
        <div class="online-users" id="onlineUsers">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
          <span id="userCount">1</span>
        </div>
        <div class="save-indicator">
          <div class="save-dot"></div>
          Saved
        </div>
      </div>
    </div>
    
    <div class="brush-indicator" id="brushIndicator">pencil</div>
    
    <!-- Desktop Toolbar -->
    <div class="toolbar">
      <button class="tool-btn" onclick="goHome()" title="Home">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
      </button>
      
      <div class="toolbar-divider"></div>
      
      <div style="position: relative;">
        <button class="tool-btn" id="brushBtn" onclick="togglePanel('brush')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08"></path><path d="M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z"></path></svg>
        </button>
        <div class="panel" id="brushPanel">
          <div class="panel-title">Select Brush</div>
          <div class="brush-grid" id="brushGrid"></div>
        </div>
      </div>
      
      <div style="position: relative;">
        <button class="tool-btn" onclick="togglePanel('color')">
          <div class="color-preview" id="colorPreview" style="background: #ffffff;"></div>
        </button>
        <div class="panel" id="colorPanel">
          <div class="panel-title">Select Color</div>
          <div class="color-grid" id="colorGrid"></div>
          <div class="color-custom">
            <div class="color-display" id="colorDisplay" style="background: #ffffff;"></div>
            <input type="text" class="color-input" id="colorInput" value="#ffffff" oninput="updateColorFromInput()">
          </div>
        </div>
      </div>

      <div style="position: relative;">
        <button class="tool-btn" onclick="togglePanel('bgcolor')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/></svg>
        </button>
        <div class="panel" id="bgColorPanel">
          <div class="panel-title">Canvas Background</div>
          <div class="bg-color-grid" id="bgColorGrid"></div>
        </div>
      </div>
      
      <div class="toolbar-divider"></div>
      
      <div class="size-control">
        <label>Size</label>
        <input type="range" class="size-slider" id="sizeSlider" min="1" max="50" value="8" oninput="updateSize()">
        <span class="size-value" id="sizeValue">8</span>
      </div>
      
      <div class="toolbar-divider"></div>
      
      <button class="tool-btn" id="undoBtn" onclick="undo()" disabled title="Undo">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg>
      </button>
      <button class="tool-btn" id="redoBtn" onclick="redo()" disabled title="Redo">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7v6h-6"></path><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"></path></svg>
      </button>
      <button class="tool-btn danger" onclick="clearCanvas()" title="Clear">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
      </button>
      
      <div class="toolbar-divider"></div>
      
      <button class="btn" onclick="openShareModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
        Share
      </button>

      <button class="btn" onclick="exportPNG()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
        Export
      </button>
    </div>
    
    <!-- Mobile -->
    <button class="mobile-home" onclick="goHome()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
    </button>
    
    <button class="mobile-fab" id="mobileFab" onclick="toggleMobileMenu()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="12" x2="20" y2="12"></line><line x1="4" y1="6" x2="20" y2="6"></line><line x1="4" y1="18" x2="20" y2="18"></line></svg>
    </button>
    
    <div class="mobile-menu" id="mobileMenu">
      <div class="mobile-section">
        <div class="mobile-section-title">Brush</div>
        <div class="brush-grid" id="mobileBrushGrid"></div>
      </div>
      <div class="mobile-section">
        <div class="mobile-section-title">Color</div>
        <div class="color-grid" id="mobileColorGrid"></div>
      </div>
      <div class="mobile-section">
        <div class="mobile-section-title">Size: <span id="mobileSizeValue">8</span></div>
        <input type="range" class="size-slider" style="width: 100%;" id="mobileSizeSlider" min="1" max="50" value="8" oninput="updateSizeMobile()">
      </div>
      <div class="mobile-section">
        <div class="mobile-actions">
          <button class="tool-btn" id="mobileUndoBtn" onclick="undo()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg>
          </button>
          <button class="tool-btn" id="mobileRedoBtn" onclick="redo()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7v6h-6"></path><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"></path></svg>
          </button>
          <button class="tool-btn danger" onclick="clearCanvas()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
          </button>
        </div>
      </div>
      <button class="btn" style="width: 100%; margin-bottom: 8px;" onclick="openShareModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
        Share
      </button>
      <button class="btn" style="width: 100%;" onclick="exportPNG()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
        Export PNG
      </button>
    </div>
  </div>

  <!-- Delete Modal -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal">
      <h3>Delete Drawing?</h3>
      <p>This action cannot be undone. The drawing will be permanently deleted.</p>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Share Modal -->
  <div class="modal-overlay" id="shareModal">
    <div class="modal">
      <h3>Share Drawing</h3>
      <p>Add collaborators to draw together in real-time</p>
      
      <div class="shared-users" id="sharedUsersSection">
        <div class="shared-users-title">Current Collaborators</div>
        <div id="sharedUsersList"></div>
      </div>

      <div class="shared-users-title">Add Collaborators</div>
      <div class="user-list" id="userList">
        <div style="text-align: center; padding: 20px; color: var(--muted);">Loading users...</div>
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeShareModal()">Done</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBQslLAFRlIRJqsiJ2WWeTNslO067bzKYM",
      authDomain: "taclogin-ab38e.firebaseapp.com",
      databaseURL: "https://taclogin-ab38e-default-rtdb.firebaseio.com",
      projectId: "taclogin-ab38e",
      storageBucket: "taclogin-ab38e.firebasestorage.app",
      messagingSenderId: "937853298051",
      appId: "1:937853298051:web:119ccc7b5499514bd442b6"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Theme System
    const themeColors = {
      green: { primary: '#22c55e', dim: 'rgba(34, 197, 94, 0.1)' },
      blue: { primary: '#3b82f6', dim: 'rgba(59, 130, 246, 0.1)' },
      red: { primary: '#ef4444', dim: 'rgba(239, 68, 68, 0.1)' },
      cyan: { primary: '#06b6d4', dim: 'rgba(6, 182, 212, 0.1)' },
      pink: { primary: '#ec4899', dim: 'rgba(236, 72, 153, 0.1)' },
      purple: { primary: '#8b5cf6', dim: 'rgba(139, 92, 246, 0.1)' },
      yellow: { primary: '#eab308', dim: 'rgba(234, 179, 8, 0.1)' },
      orange: { primary: '#f97316', dim: 'rgba(249, 115, 22, 0.1)' }
    };

    function applyTheme() {
      const theme = localStorage.getItem('theme') || 'green';
      const colors = themeColors[theme] || themeColors.green;
      document.documentElement.style.setProperty('--accent', colors.primary);
      document.documentElement.style.setProperty('--accent-dim', colors.dim);
      const r = parseInt(colors.primary.slice(1, 3), 16);
      const g = parseInt(colors.primary.slice(3, 5), 16);
      const b = parseInt(colors.primary.slice(5, 7), 16);
      document.documentElement.style.setProperty('--accent-600', `rgb(${Math.floor(r*0.7)}, ${Math.floor(g*0.7)}, ${Math.floor(b*0.7)})`);
      
      const logoImg = document.getElementById('logoImg');
      if (logoImg) logoImg.src = `taclogos/${theme}.png`;
    }
    applyTheme();

    window.addEventListener('storage', (e) => {
      if (e.key === 'theme') applyTheme();
    });

    // Sidebar Toggle
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggleBtn');
    const homePage = document.getElementById('homePage');
    const drawPage = document.getElementById('drawPage');

    toggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      toggleBtn.classList.toggle('collapsed');
      homePage.classList.toggle('expanded');
      drawPage.classList.toggle('expanded');
    });

    // User Management
    const currentUser = localStorage.getItem('lastLoggedInUser') || 'Anonymous_' + Math.random().toString(36).substr(2, 9);
    if (!localStorage.getItem('lastLoggedInUser')) {
      localStorage.setItem('lastLoggedInUser', currentUser);
    }

    // Constants
    const DRAWINGS_KEY = 'artisan_drawings';
    const brushes = [
      { id: 'pencil', name: 'Pencil', icon: 'âœï¸' },
      { id: 'ink', name: 'Ink', icon: 'ðŸ–Šï¸' },
      { id: 'watercolor', name: 'Water', icon: 'ðŸ’§' },
      { id: 'spray', name: 'Spray', icon: 'ðŸŽ¨' },
      { id: 'neon', name: 'Neon', icon: 'âš¡' },
      { id: 'charcoal', name: 'Charcoal', icon: 'ðŸ”¥' },
      { id: 'marker', name: 'Marker', icon: 'ðŸ–ï¸' },
      { id: 'crayon', name: 'Crayon', icon: 'ðŸ–ï¸' },
      { id: 'calligraphy', name: 'Calli', icon: 'ðŸ–‹ï¸' },
      { id: 'pixel', name: 'Pixel', icon: 'â¬›' },
      { id: 'splatter', name: 'Splatter', icon: 'ðŸ’¥' },
      { id: 'fur', name: 'Fur', icon: 'ðŸŒŠ' },
      { id: 'ribbon', name: 'Ribbon', icon: 'ðŸŽ€' },
      { id: 'glow', name: 'Glow', icon: 'âœ¨' },
      { id: 'sketch', name: 'Sketch', icon: 'ðŸ“' },
      { id: 'oil', name: 'Oil', icon: 'ðŸŽ­' }
    ];
    
    const colors = [
      '#ffffff', '#e2e2e2', '#a3a3a3', '#737373', '#404040', '#171717', '#000000',
      '#fecaca', '#f87171', '#ef4444', '#dc2626', '#b91c1c', '#7f1d1d', '#450a0a',
      '#fed7aa', '#fb923c', '#f97316', '#ea580c', '#c2410c', '#7c2d12', '#431407',
      '#fef08a', '#facc15', '#eab308', '#ca8a04', '#a16207', '#713f12', '#422006',
      '#bbf7d0', '#4ade80', '#22c55e', '#16a34a', '#15803d', '#14532d', '#052e16',
      '#a5f3fc', '#22d3ee', '#06b6d4', '#0891b2', '#0e7490', '#164e63', '#083344',
      '#bfdbfe', '#60a5fa', '#3b82f6', '#2563eb', '#1d4ed8', '#1e3a8a', '#172554',
      '#e9d5ff', '#c084fc', '#a855f7', '#9333ea', '#7e22ce', '#581c87', '#3b0764',
      '#fbcfe8', '#f472b6', '#ec4899', '#db2777', '#be185d', '#831843', '#500724'
    ];

    const bgColors = [
      { color: '#0f0f1a', name: 'Dark' },
      { color: '#1a1a2e', name: 'Navy' },
      { color: '#0a0e27', name: 'Midnight' },
      { color: '#1c1c1c', name: 'Charcoal' },
      { color: '#ffffff', name: 'White' },
      { color: '#f5f5f5', name: 'Light' },
      { color: '#2d1b1b', name: 'Brown' },
      { color: '#1b2d1b', name: 'Forest' }
    ];

    // State
    let canvas, ctx;
    let currentDrawingId = null;
    let drawings = [];
    let isDrawing = false;
    let lastPoint = null;
    let points = [];
    let history = [];
    let historyIndex = -1;
    let currentColor = '#ffffff';
    let brushSize = 8;
    let selectedBrush = 'pencil';
    let deleteTargetId = null;
    let mobileMenuOpen = false;
    let canvasBgColor = '#0f0f1a';
    let registeredUsers = [];
    let userPresenceRef = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadDrawings();
      renderHome();
      initBrushGrids();
      initColorGrids();
      initBgColorGrid();
      loadRegisteredUsers();
    });

    // Load registered users from Firebase
    function loadRegisteredUsers() {
      database.ref('registeredUsers').on('value', (snapshot) => {
        const users = snapshot.val();
        registeredUsers = users ? Object.values(users) : [];
      });
    }

    // Storage
    function loadDrawings() {
      const data = localStorage.getItem(DRAWINGS_KEY);
      drawings = data ? JSON.parse(data) : [];
    }

    function saveDrawings() {
      localStorage.setItem(DRAWINGS_KEY, JSON.stringify(drawings));
    }

    // Home Page
    function renderHome() {
      const container = document.getElementById('drawingsContainer');
      
      if (drawings.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.4;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
            </div>
            <h2>No drawings yet</h2>
            <p>Create your first masterpiece</p>
            <button class="btn" onclick="createNewDrawing()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
              Create Drawing
            </button>
          </div>
        `;
        return;
      }
      
      container.innerHTML = `<div class="drawings-grid">${drawings.map(d => `
        <div class="drawing-card" onclick="openDrawing('${d.id}')">
          <div class="drawing-thumbnail">
            ${d.thumbnail ? `<img src="${d.thumbnail}" alt="${d.name}">` : `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path></svg>`}
          </div>
          <div class="drawing-info">
            <div>
              <div class="drawing-name">${d.name}</div>
              <div class="drawing-date">${formatDate(d.updatedAt)}</div>
            </div>
            <button class="delete-btn" onclick="event.stopPropagation(); showDeleteModal('${d.id}')">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
            </button>
          </div>
        </div>
      `).join('')}</div>`;
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function createNewDrawing() {
      const id = 'drawing_' + Date.now();
      const drawing = {
        id,
        name: 'Untitled ' + (drawings.length + 1),
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        thumbnail: null,
        sharedWith: []
      };
      drawings.unshift(drawing);
      saveDrawings();
      openDrawing(id);
    }

    function openDrawing(id) {
      currentDrawingId = id;
      const drawing = drawings.find(d => d.id === id);
      
      document.getElementById('homePage').classList.add('hidden');
      document.getElementById('drawPage').classList.add('active');
      document.getElementById('drawingName').value = drawing.name;
      
      initCanvas();
      loadCanvasData();
      setupRealtimeDrawing();
    }

    function setupRealtimeDrawing() {
      const drawing = drawings.find(d => d.id === currentDrawingId);
      if (!drawing || !drawing.sharedWith || drawing.sharedWith.length === 0) {
        document.getElementById('userCount').textContent = '1';
        return;
      }

      // User presence
      userPresenceRef = database.ref(`drawings/${currentDrawingId}/users/${currentUser}`);
      userPresenceRef.set({
        name: currentUser,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
      userPresenceRef.onDisconnect().remove();

      // Listen to user count
      database.ref(`drawings/${currentDrawingId}/users`).on('value', (snapshot) => {
        const users = snapshot.val();
        const count = users ? Object.keys(users).length : 1;
        document.getElementById('userCount').textContent = count;
      });

      // Listen to canvas data
      database.ref(`drawings/${currentDrawingId}/canvas`).on('value', (snapshot) => {
        const data = snapshot.val();
        if (data && data.imageData) {
          const img = new Image();
          img.onload = () => {
            const rect = canvas.getBoundingClientRect();
            ctx.clearRect(0, 0, rect.width, rect.height);
            ctx.fillStyle = data.bgColor || canvasBgColor;
            ctx.fillRect(0, 0, rect.width, rect.height);
            ctx.drawImage(img, 0, 0, rect.width, rect.height);
          };
          img.src = data.imageData;
        }
      });

      // Listen to strokes
      database.ref(`drawings/${currentDrawingId}/strokes`).limitToLast(1).on('child_added', (snapshot) => {
        const stroke = snapshot.val();
        if (stroke && stroke.user !== currentUser) {
          drawStroke(stroke);
        }
      });
    }

    function drawStroke(stroke) {
      if (!stroke || !stroke.points || stroke.points.length < 2) return;
      
      ctx.strokeStyle = stroke.color;
      ctx.lineWidth = stroke.size;
      ctx.globalAlpha = stroke.alpha || 1;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';

      ctx.beginPath();
      ctx.moveTo(stroke.points[0].x, stroke.points[0].y);
      for (let i = 1; i < stroke.points.length; i++) {
        ctx.lineTo(stroke.points[i].x, stroke.points[i].y);
      }
      ctx.stroke();
      ctx.globalAlpha = 1;
    }

    function saveStrokeToFirebase(points) {
      const drawing = drawings.find(d => d.id === currentDrawingId);
      if (!drawing || !drawing.sharedWith || drawing.sharedWith.length === 0 || points.length < 2) return;
      
      database.ref(`drawings/${currentDrawingId}/strokes`).push({
        user: currentUser,
        brush: selectedBrush,
        color: currentColor,
        size: brushSize,
        points: points,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
    }

    function saveCanvasToFirebase() {
      const drawing = drawings.find(d => d.id === currentDrawingId);
      if (!drawing || !drawing.sharedWith || drawing.sharedWith.length === 0) return;
      
      const data = canvas.toDataURL('image/jpeg', 0.7);
      database.ref(`drawings/${currentDrawingId}/canvas`).set({
        imageData: data,
        bgColor: canvasBgColor,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
    }

    function goHome() {
      if (userPresenceRef) {
        userPresenceRef.remove();
        database.ref(`drawings/${currentDrawingId}/users`).off();
        database.ref(`drawings/${currentDrawingId}/canvas`).off();
        database.ref(`drawings/${currentDrawingId}/strokes`).off();
      }
      
      saveCanvasData();
      document.getElementById('homePage').classList.remove('hidden');
      document.getElementById('drawPage').classList.remove('active');
      currentDrawingId = null;
      history = [];
      historyIndex = -1;
      renderHome();
    }

    function showDeleteModal(id) {
      deleteTargetId = id;
      document.getElementById('deleteModal').classList.add('active');
    }

    function closeDeleteModal() {
      deleteTargetId = null;
      document.getElementById('deleteModal').classList.remove('active');
    }

    function confirmDelete() {
      if (deleteTargetId) {
        drawings = drawings.filter(d => d.id !== deleteTargetId);
        localStorage.removeItem('canvas_' + deleteTargetId);
        database.ref(`drawings/${deleteTargetId}`).remove();
        saveDrawings();
        renderHome();
        closeDeleteModal();
      }
    }

    // Share Modal
    function openShareModal() {
      if (!currentDrawingId) return;
      
      const drawing = drawings.find(d => d.id === currentDrawingId);
      if (!drawing) return;

      renderSharedUsers(drawing);
      renderUserList(drawing);
      document.getElementById('shareModal').classList.add('active');
    }

    function closeShareModal() {
      document.getElementById('shareModal').classList.remove('active');
    }

    function renderSharedUsers(drawing) {
      const container = document.getElementById('sharedUsersList');
      const sharedUsers = drawing.sharedWith || [];
      
      if (sharedUsers.length === 0) {
        container.innerHTML = '<div class="empty-shared">No collaborators yet</div>';
        return;
      }

      container.innerHTML = sharedUsers.map(username => `
        <div class="user-item">
          <div class="user-info">
            <div class="user-avatar">${username.charAt(0).toUpperCase()}</div>
            <div>
              <div class="user-name">${username}</div>
            </div>
          </div>
          <button class="btn btn-ghost btn-small" onclick="removeUser('${username}')">Remove</button>
        </div>
      `).join('');
    }

    function renderUserList(drawing) {
      const container = document.getElementById('userList');
      const sharedWith = drawing.sharedWith || [];
      
      if (registeredUsers.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--muted);">No registered users found</div>';
        return;
      }

      const availableUsers = registeredUsers.filter(u => u.username !== currentUser && !sharedWith.includes(u.username));

      if (availableUsers.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--muted);">All users already added</div>';
        return;
      }

      container.innerHTML = availableUsers.map(user => `
        <div class="user-item">
          <div class="user-info">
            <div class="user-avatar">${user.username.charAt(0).toUpperCase()}</div>
            <div>
              <div class="user-name">${user.username}</div>
              ${user.email ? `<div class="user-email">${user.email}</div>` : ''}
            </div>
          </div>
          <button class="btn btn-small" onclick="addUser('${user.username}')">Add</button>
        </div>
      `).join('');
    }

    function addUser(username) {
      const drawing = drawings.find(d => d.id === currentDrawingId);
      if (!drawing) return;

      if (!drawing.sharedWith) drawing.sharedWith = [];
      if (!drawing.sharedWith.includes(username)) {
        drawing.sharedWith.push(username);
        saveDrawings();
        
        // Sync current canvas to Firebase
        saveCanvasToFirebase();
        
        // Setup realtime if this is the first user
        if (drawing.sharedWith.length === 1) {
          setupRealtimeDrawing();
        }

        renderSharedUsers(drawing);
        renderUserList(drawing);
      }
    }

    function removeUser(username) {
      const drawing = drawings.find(d => d.id === currentDrawingId);
      if (!drawing || !drawing.sharedWith) return;

      drawing.sharedWith = drawing.sharedWith.filter(u => u !== username);
      saveDrawings();

      // If no more shared users, cleanup Firebase listeners
      if (drawing.sharedWith.length === 0 && userPresenceRef) {
        userPresenceRef.remove();
        database.ref(`drawings/${currentDrawingId}/users`).off();
        database.ref(`drawings/${currentDrawingId}/canvas`).off();
        database.ref(`drawings/${currentDrawingId}/strokes`).off();
        document.getElementById('userCount').textContent = '1';
      }

      renderSharedUsers(drawing);
      renderUserList(drawing);
    }

    // Canvas
    function initCanvas() {
      canvas = document.getElementById('canvas');
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      
      ctx = canvas.getContext('2d');
      ctx.scale(dpr, dpr);
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      
      ctx.fillStyle = canvasBgColor;
      ctx.fillRect(0, 0, rect.width, rect.height);
      
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseleave', stopDrawing);
      canvas.addEventListener('touchstart', handleTouch);
      canvas.addEventListener('touchmove', handleTouch);
      canvas.addEventListener('touchend', stopDrawing);
      
      window.addEventListener('resize', handleResize);
    }

    function handleResize() {
      const imageData = canvas.toDataURL();
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      
      const img = new Image();
      img.onload = () => {
        ctx.drawImage(img, 0, 0, rect.width, rect.height);
      };
      img.src = imageData;
    }

    function loadCanvasData() {
      const data = localStorage.getItem('canvas_' + currentDrawingId);
      if (data) {
        const img = new Image();
        img.onload = () => {
          const rect = canvas.getBoundingClientRect();
          ctx.drawImage(img, 0, 0, rect.width, rect.height);
          saveToHistory();
        };
        img.src = data;
      } else {
        saveToHistory();
      }
    }

    function saveCanvasData() {
      if (!currentDrawingId) return;
      const data = canvas.toDataURL();
      localStorage.setItem('canvas_' + currentDrawingId, data);
      
      const idx = drawings.findIndex(d => d.id === currentDrawingId);
      if (idx !== -1) {
        const thumbCanvas = document.createElement('canvas');
        thumbCanvas.width = 200;
        thumbCanvas.height = 200;
        const thumbCtx = thumbCanvas.getContext('2d');
        const img = new Image();
        img.onload = () => {
          thumbCtx.drawImage(img, 0, 0, 200, 200);
          drawings[idx].thumbnail = thumbCanvas.toDataURL('image/jpeg', 0.6);
          drawings[idx].updatedAt = new Date().toISOString();
          saveDrawings();
        };
        img.src = data;
      }
    }

    function updateDrawingName() {
      const name = document.getElementById('drawingName').value;
      const idx = drawings.findIndex(d => d.id === currentDrawingId);
      if (idx !== -1) {
        drawings[idx].name = name;
        saveDrawings();
      }
    }

    // Drawing
    function handleTouch(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      
      if (e.type === 'touchstart') startDrawing(mouseEvent);
      else draw(mouseEvent);
    }

    function getCoords(e) {
      const rect = canvas.getBoundingClientRect();
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }

    function startDrawing(e) {
      isDrawing = true;
      lastPoint = getCoords(e);
      points = [lastPoint];
      brushFunctions[selectedBrush](ctx, lastPoint.x, lastPoint.y, lastPoint.x, lastPoint.y);
    }

    function draw(e) {
      if (!isDrawing) return;
      const point = getCoords(e);
      points.push(point);
      brushFunctions[selectedBrush](ctx, point.x, point.y, lastPoint.x, lastPoint.y);
      lastPoint = point;
    }

    function stopDrawing() {
      if (isDrawing) {
        isDrawing = false;
        
        const drawing = drawings.find(d => d.id === currentDrawingId);
        if (drawing && drawing.sharedWith && drawing.sharedWith.length > 0 && points.length > 0) {
          saveStrokeToFirebase(points);
          setTimeout(() => saveCanvasToFirebase(), 500);
        }
        
        lastPoint = null;
        points = [];
        ctx.globalAlpha = 1;
        ctx.shadowBlur = 0;
        saveToHistory();
        saveCanvasData();
      }
    }

    // Brush functions
    const brushFunctions = {
      pencil: (ctx, x, y, lx, ly) => {
        ctx.globalAlpha = 0.9;
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = brushSize * 0.5;
        ctx.beginPath();
        ctx.moveTo(lx, ly);
        ctx.lineTo(x, y);
        ctx.stroke();
        for (let i = 0; i < 3; i++) {
          ctx.beginPath();
          ctx.arc(x + (Math.random() - 0.5) * brushSize * 0.3, y + (Math.random() - 0.5) * brushSize * 0.3, 0.5, 0, Math.PI * 2);
          ctx.fillStyle = currentColor;
          ctx.fill();
        }
      },
      ink: (ctx, x, y, lx, ly) => {
        ctx.globalAlpha = 1;
        ctx.strokeStyle = currentColor;
        const dist = Math.sqrt((x - lx) ** 2 + (y - ly) ** 2);
        ctx.lineWidth = Math.max(1, brushSize - dist * 0.1);
        ctx.beginPath();
        ctx.moveTo(lx, ly);
        ctx.lineTo(x, y);
        ctx.stroke();
      },
      watercolor: (ctx, x, y) => {
        for (let i = 0; i < 5; i++) {
          ctx.globalAlpha = 0.02 + Math.random() * 0.03;
          ctx.beginPath();
          ctx.arc(x + (Math.random() - 0.5) * brushSize, y + (Math.random() - 0.5) * brushSize, brushSize * (0.5 + Math.random() * 0.5), 0, Math.PI * 2);
          ctx.fillStyle = currentColor;
          ctx.fill();
        }
      },
      spray: (ctx, x, y) => {
        const density = brushSize * 3;
        for (let i = 0; i < density; i++) {
          const angle = Math.random() * Math.PI * 2;
          const radius = Math.random() * brushSize;
          ctx.globalAlpha = Math.random() * 0.3;
          ctx.beginPath();
          ctx.arc(x + Math.cos(angle) * radius, y + Math.sin(angle) * radius, Math.random() * 1.5, 0, Math.PI * 2);
          ctx.fillStyle = currentColor;
          ctx.fill();
        }
      },
      neon: (ctx, x, y, lx, ly) => {
        ctx.globalAlpha = 0.1;
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = brushSize * 3;
        ctx.shadowColor = currentColor;
        ctx.shadowBlur = 20;
        ctx.beginPath();
        ctx.moveTo(lx, ly);
        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.globalAlpha = 1;
        ctx.lineWidth = brushSize * 0.5;
        ctx.strokeStyle = '#ffffff';
        ctx.beginPath();
        ctx.moveTo(lx, ly);
        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.shadowBlur = 0;
      },
      charcoal: (ctx, x, y, lx, ly) => {
        ctx.globalAlpha = 0.15;
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = brushSize;
        for (let i = 0; i < 4; i++) {
          ctx.beginPath();
          ctx.moveTo(lx + (Math.random() - 0.5) * brushSize * 0.5, ly + (Math.random() - 0.5) * brushSize * 0.5);
          ctx.lineTo(x + (Math.random() - 0.5) * brushSize * 0.5, y + (Math.random() - 0.5) * brushSize * 0.5);
          ctx.stroke();
        }
      },
      marker: (ctx, x, y, lx, ly) => {
        ctx.globalAlpha = 0.4;
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = brushSize * 1.5;
        ctx.beginPath();
        ctx.moveTo(lx, ly);
        ctx.lineTo(x, y);
        ctx.stroke();
      },
      crayon: (ctx, x, y, lx, ly) => {
        ctx.globalAlpha = 0.7;
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = brushSize;
        ctx.beginPath();
        ctx.moveTo(lx, ly);
        ctx.lineTo(x, y);
        ctx.stroke();
        for (let i = 0; i < 8; i++) {
          if (Math.random() > 0.5) {
            ctx.globalAlpha = Math.random() * 0.3;
            ctx.beginPath();
            ctx.arc(x + (Math.random() - 0.5) * brushSize, y + (Math.random() - 0.5) * brushSize, Math.random() * 2, 0, Math.PI * 2);
            ctx.fillStyle = canvasBgColor;
            ctx.fill();
          }
        }
      },
      calligraphy: (ctx, x, y, lx, ly) => {
        ctx.globalAlpha = 1;
        ctx.strokeStyle = currentColor;
        const angle = Math.atan2(y - ly, x - lx);
        ctx.lineWidth = brushSize * Math.abs(Math.sin(angle)) + 1;
        ctx.beginPath();
        ctx.moveTo(lx, ly);
        ctx.lineTo(x, y);
        ctx.stroke();
      },
      pixel: (ctx, x, y) => {
        ctx.globalAlpha = 1;
        ctx.fillStyle = currentColor;
        const pixelSize = Math.max(4, brushSize);
        const px = Math.floor(x / pixelSize) * pixelSize;
        const py = Math.floor(y / pixelSize) * pixelSize;
        ctx.fillRect(px, py, pixelSize, pixelSize);
      },
      splatter: (ctx, x, y) => {
        const splatters = Math.floor(brushSize / 2) + 3;
        for (let i = 0; i < splatters; i++) {
          ctx.globalAlpha = 0.3 + Math.random() * 0.5;
          const angle = Math.random() * Math.PI * 2;
          const dist = Math.random() * brushSize * 2;
          const size = Math.random() * brushSize * 0.5 + 1;
          ctx.beginPath();
          ctx.arc(x + Math.cos(angle) * dist, y + Math.sin(angle) * dist, size, 0, Math.PI * 2);
          ctx.fillStyle = currentColor;
          ctx.fill();
        }
      },
      fur: (ctx, x, y, lx, ly) => {
        ctx.globalAlpha = 0.8;
        ctx.strokeStyle = currentColor;
        const angle = Math.atan2(y - ly, x - lx);
        for (let i = 0; i < 6; i++) {
          const hairAngle = angle + (Math.random() - 0.5) * 1.5;
          const hairLength = brushSize * (0.5 + Math.random());
          ctx.lineWidth = 0.5 + Math.random();
          ctx.beginPath();
          ctx.moveTo(x, y);
          ctx.lineTo(x + Math.cos(hairAngle) * hairLength, y + Math.sin(hairAngle) * hairLength);
          ctx.stroke();
        }
      },
      ribbon: (ctx, x, y, lx, ly) => {
        points.push({ x, y });
        if (points.length > 20) points.shift();
        ctx.globalAlpha = 0.5;
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = brushSize;
        if (points.length > 2) {
          ctx.beginPath();
          ctx.moveTo(points[0].x, points[0].y);
          for (let i = 1; i < points.length - 1; i++) {
            const xc = (points[i].x + points[i + 1].x) / 2;
            const yc = (points[i].y + points[i + 1].y) / 2;
            ctx.quadraticCurveTo(points[i].x, points[i].y, xc, yc);
          }
          ctx.stroke();
        }
      },
      glow: (ctx, x, y, lx, ly) => {
        ctx.shadowColor = currentColor;
        ctx.shadowBlur = brushSize * 2;
        ctx.globalAlpha = 0.6;
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = brushSize;
        ctx.beginPath();
        ctx.moveTo(lx, ly);
        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.shadowBlur = 0;
      },
      sketch: (ctx, x, y, lx, ly) => {
        ctx.globalAlpha = 0.6;
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = brushSize * 0.3;
        for (let i = 0; i < 3; i++) {
          ctx.beginPath();
          ctx.moveTo(lx + (Math.random() - 0.5) * 2, ly + (Math.random() - 0.5) * 2);
          ctx.lineTo(x + (Math.random() - 0.5) * 2, y + (Math.random() - 0.5) * 2);
          ctx.stroke();
        }
      },
      oil: (ctx, x, y, lx, ly) => {
        ctx.globalAlpha = 0.8;
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = brushSize * 1.2;
        ctx.beginPath();
        ctx.moveTo(lx, ly);
        ctx.lineTo(x, y);
        ctx.stroke();
        for (let i = 0; i < 3; i++) {
          ctx.globalAlpha = 0.2;
          ctx.beginPath();
          ctx.arc(x + (Math.random() - 0.5) * brushSize, y + (Math.random() - 0.5) * brushSize, brushSize * 0.3, 0, Math.PI * 2);
          ctx.fillStyle = currentColor;
          ctx.fill();
        }
      }
    };

    // History
    function saveToHistory() {
      const data = canvas.toDataURL();
      history = history.slice(0, historyIndex + 1);
      history.push(data);
      if (history.length > 50) history.shift();
      historyIndex = history.length - 1;
      updateHistoryButtons();
    }

    function undo() {
      if (historyIndex > 0) {
        historyIndex--;
        loadHistoryState();
      }
    }

    function redo() {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        loadHistoryState();
      }
    }

    function loadHistoryState() {
      const img = new Image();
      img.onload = () => {
        const rect = canvas.getBoundingClientRect();
        ctx.clearRect(0, 0, rect.width, rect.height);
        ctx.drawImage(img, 0, 0, rect.width, rect.height);
        saveCanvasData();
        
        const drawing = drawings.find(d => d.id === currentDrawingId);
        if (drawing && drawing.sharedWith && drawing.sharedWith.length > 0) {
          saveCanvasToFirebase();
        }
        
        updateHistoryButtons();
      };
      img.src = history[historyIndex];
    }

    function updateHistoryButtons() {
      document.getElementById('undoBtn').disabled = historyIndex <= 0;
      document.getElementById('redoBtn').disabled = historyIndex >= history.length - 1;
      const mobileUndo = document.getElementById('mobileUndoBtn');
      const mobileRedo = document.getElementById('mobileRedoBtn');
      if (mobileUndo) mobileUndo.disabled = historyIndex <= 0;
      if (mobileRedo) mobileRedo.disabled = historyIndex >= history.length - 1;
    }

    function clearCanvas() {
      const rect = canvas.getBoundingClientRect();
      ctx.fillStyle = canvasBgColor;
      ctx.fillRect(0, 0, rect.width, rect.height);
      saveToHistory();
      saveCanvasData();
      
      const drawing = drawings.find(d => d.id === currentDrawingId);
      if (drawing && drawing.sharedWith && drawing.sharedWith.length > 0) {
        saveCanvasToFirebase();
      }
    }

    function exportPNG() {
      const drawing = drawings.find(d => d.id === currentDrawingId);
      const name = drawing ? drawing.name.replace(/\s+/g, '_') : 'artwork';
      const link = document.createElement('a');
      link.download = `${name}_${Date.now()}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    // UI
    function initBrushGrids() {
      const html = brushes.map(b => `
        <button class="brush-btn ${b.id === selectedBrush ? 'active' : ''}" data-brush="${b.id}" onclick="selectBrush('${b.id}')">
          <span style="font-size: 16px;">${b.icon}</span>
          <span>${b.name}</span>
        </button>
      `).join('');
      
      document.getElementById('brushGrid').innerHTML = html;
      document.getElementById('mobileBrushGrid').innerHTML = html;
    }

    function initColorGrids() {
      const html = colors.map(c => `
        <button class="color-btn ${c === currentColor ? 'active' : ''}" style="background: ${c};" data-color="${c}" onclick="selectColor('${c}')"></button>
      `).join('');
      
      document.getElementById('colorGrid').innerHTML = html;
      document.getElementById('mobileColorGrid').innerHTML = html;
    }

    function initBgColorGrid() {
      const html = bgColors.map(bg => `
        <button class="bg-color-btn ${bg.color === canvasBgColor ? 'active' : ''}" style="background: ${bg.color};" data-bgcolor="${bg.color}" onclick="selectBgColor('${bg.color}')" title="${bg.name}"></button>
      `).join('');
      
      document.getElementById('bgColorGrid').innerHTML = html;
    }

    function selectBrush(id) {
      selectedBrush = id;
      document.querySelectorAll('.brush-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.brush === id);
      });
      document.getElementById('brushIndicator').textContent = id;
      document.getElementById('brushBtn').classList.add('active');
    }

    function selectColor(c) {
      currentColor = c;
      document.querySelectorAll('.color-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.color === c);
      });
      document.getElementById('colorPreview').style.background = c;
      document.getElementById('colorDisplay').style.background = c;
      document.getElementById('colorInput').value = c;
    }

    function selectBgColor(color) {
      canvasBgColor = color;
      document.querySelectorAll('.bg-color-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.bgcolor === color);
      });
      
      const rect = canvas.getBoundingClientRect();
      const imageData = canvas.toDataURL();
      const img = new Image();
      img.onload = () => {
        ctx.fillStyle = canvasBgColor;
        ctx.fillRect(0, 0, rect.width, rect.height);
        ctx.drawImage(img, 0, 0, rect.width, rect.height);
        saveToHistory();
        saveCanvasData();
        
        const drawing = drawings.find(d => d.id === currentDrawingId);
        if (drawing && drawing.sharedWith && drawing.sharedWith.length > 0) {
          saveCanvasToFirebase();
        }
      };
      img.src = imageData;
    }

    function updateColorFromInput() {
      const val = document.getElementById('colorInput').value;
      if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
        selectColor(val);
      }
    }

    function updateSize() {
      brushSize = parseInt(document.getElementById('sizeSlider').value);
      document.getElementById('sizeValue').textContent = brushSize;
    }

    function updateSizeMobile() {
      brushSize = parseInt(document.getElementById('mobileSizeSlider').value);
      document.getElementById('mobileSizeValue').textContent = brushSize;
      document.getElementById('sizeSlider').value = brushSize;
      document.getElementById('sizeValue').textContent = brushSize;
    }

    function togglePanel(type) {
      const brushPanel = document.getElementById('brushPanel');
      const colorPanel = document.getElementById('colorPanel');
      const bgColorPanel = document.getElementById('bgColorPanel');
      
      if (type === 'brush') {
        brushPanel.classList.toggle('active');
        colorPanel.classList.remove('active');
        bgColorPanel.classList.remove('active');
      } else if (type === 'color') {
        colorPanel.classList.toggle('active');
        brushPanel.classList.remove('active');
        bgColorPanel.classList.remove('active');
      } else if (type === 'bgcolor') {
        bgColorPanel.classList.toggle('active');
        brushPanel.classList.remove('active');
        colorPanel.classList.remove('active');
      }
    }

    function toggleMobileMenu() {
      mobileMenuOpen = !mobileMenuOpen;
      document.getElementById('mobileMenu').classList.toggle('active', mobileMenuOpen);
      document.getElementById('mobileFab').innerHTML = mobileMenuOpen ? 
        '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>' :
        '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="12" x2="20" y2="12"></line><line x1="4" y1="6" x2="20" y2="6"></line><line x1="4" y1="18" x2="20" y2="18"></line></svg>';
    }

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.tool-btn') && !e.target.closest('.panel')) {
        document.getElementById('brushPanel').classList.remove('active');
        document.getElementById('colorPanel').classList.remove('active');
        document.getElementById('bgColorPanel').classList.remove('active');
      }
    });
  </script>
<script src="guard.js"></script>
</body>
</html>