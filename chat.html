<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="rightclick.css">
    <link rel="stylesheet" href="custom-cursor.css">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TAC Chat - Moderation + DB-driven Profanity</title>
<link rel="icon" type="image/png" href="favicon.png" />
<style>
  :root{
    --bg:#0a0a0b;
    --panel:#111113;
    --panel-hover:#1a1a1c;
    --accent:#22c55e;
    --accent-dim:rgba(34, 197, 94, 0.1);
    --muted:#71717a;
    --border:rgba(255,255,255,0.06);
    --msg:#111317;
    --msgAlt:#14161b;
  }
  
  *{box-sizing:border-box;margin:0;padding:0}
  
  html,body{
    height:100%;
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
    background:var(--bg);
    color:#e8eaed;
    font-size:14px;
  }
  
  ::-webkit-scrollbar{width:6px;height:6px}
  ::-webkit-scrollbar-track{background:transparent}
  ::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px}
  
  /* Floating Sidebar */
  .sidebar{
    position:fixed;
    left:10px;
    top:50%;
    transform:translateY(-50%);
    width:70px;
    background:var(--panel);
    border:1px solid var(--accent);
    border-radius:16px;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:12px 0;
    transition:all 0.3s ease;
    z-index:1000;
    box-shadow:0 0 20px var(--accent-dim);
  }
  
  .sidebar.collapsed{
    width:0;
    padding:0;
    border:none;
    margin-left:-10px;
    overflow:hidden;
  }
  
  .sidebar.hidden{
    display:none;
  }
  
  .logo-container{
    margin-bottom:16px;
    padding:4px;
    transition:opacity 0.3s;
  }
  
  .sidebar.collapsed .logo-container{
    opacity:0;
  }
  
  .logo{
    width:62px;
    height:62px;
    border-radius:8px;
  }
  
  .nav-items{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
    width:100%;
    padding:0 8px;
    transition:opacity 0.3s;
    flex:1;
  }
  
  .sidebar.collapsed .nav-items{
    opacity:0;
  }
  
  .nav-item{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    width:54px;
    height:54px;
    border-radius:10px;
    text-decoration:none;
    color:var(--accent);
    transition:all 0.2s ease;
    cursor:pointer;
    border:none;
    background:transparent;
    padding:0;
  }
  
  .nav-item:hover{
    background:var(--accent-dim);
  }
  
  .nav-item.active{
    background:var(--accent-dim);
    border:1px solid var(--accent);
  }
  
  .nav-item svg{
    width:24px;
    height:24px;
    margin-bottom:2px;
  }
  
  .nav-item span{
    font-size:9px;
    font-weight:500;
  }
  
  .toggle-btn{
    position:fixed;
    left:90px;
    top:50%;
    transform:translateY(-50%);
    width:20px;
    height:36px;
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:6px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    transition:all 0.3s ease;
    z-index:1001;
  }
  
  .toggle-btn:hover{
    background:var(--panel-hover);
    border-color:var(--accent);
  }
  
  .toggle-btn svg{
    width:14px;
    height:14px;
    color:#fff;
    transition:transform 0.3s ease;
  }
  
  .toggle-btn.collapsed{
    left:10px;
  }
  
  .toggle-btn.collapsed svg{
    transform:rotate(180deg);
  }
  
  .toggle-btn.hidden{
    display:none;
  }
  
  /* Layout */
  .layout{
    display:grid;
    grid-template-columns:1fr 360px;
    height:100vh;
  }
  
  .layout.fullscreen{
    grid-template-columns:1fr;
  }
  
  .app{
    display:grid;
    grid-template-rows:auto 1fr auto;
    background:transparent;
    overflow:hidden;
    margin-left:100px;
    transition:margin-left 0.3s ease;
  }
  
  .app.expanded{
    margin-left:24px;
  }
  
  .app.fullscreen{
    margin-left:0;
  }
  
  .topbar{
    display:flex;
    align-items:center;
    gap:10px;
    padding:16px 20px;
    background:var(--panel);
    border-bottom:1px solid var(--border);
    box-shadow:0 2px 10px rgba(0,0,0,0.2);
  }
  
  .topbar .title{
    font-weight:700;
    font-size:18px;
    color:var(--accent);
  }
  
  .topbar .me{
    margin-left:auto;
    font-size:14px;
    color:var(--muted);
    display:flex;
    gap:12px;
    align-items:center;
  }
  
  .me-avatar{
    width:36px;
    height:36px;
    border-radius:50%;
    background:rgba(255,255,255,0.05);
    display:inline-flex;
    align-items:center;
    justify-content:center;
    color:#bbb;
    font-weight:700;
    cursor:pointer;
    overflow:hidden;
    border:2px solid var(--border);
    transition:all 0.2s;
  }
  
  .me-avatar:hover{
    border-color:var(--accent);
    transform:scale(1.05);
  }
  
  .me-avatar img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }
  
  .tag{
    display:inline-block;
    padding:4px 10px;
    border-radius:999px;
    background:rgba(255,255,255,0.05);
    color:#c9d1d9;
    font-size:11px;
    font-weight:600;
    border:1px solid var(--border);
  }
  
  .tag.dev{
    background:rgba(34,197,94,0.15);
    color:#22c55e;
    border-color:var(--accent);
  }
  
  .tag.mod{
    background:rgba(59,130,246,0.15);
    color:#3b82f6;
    border-color:#3b82f6;
  }
  
  /* Chat Selector Dropdown */
  .chat-selector{
    position:relative;
    display:flex;
    align-items:center;
    gap:8px;
  }
  
  .chat-selector-btn{
    display:flex;
    align-items:center;
    gap:8px;
    padding:8px 14px;
    background:var(--panel-hover);
    border:1px solid var(--border);
    border-radius:8px;
    cursor:pointer;
    transition:all 0.2s;
    color:#e8eaed;
    font-size:14px;
    font-weight:600;
  }
  
  .chat-selector-btn:hover{
    background:var(--accent-dim);
    border-color:var(--accent);
  }
  
  .chat-selector-btn svg{
    width:16px;
    height:16px;
    transition:transform 0.2s;
  }
  
  .chat-selector-btn.open svg{
    transform:rotate(180deg);
  }
  
  .chat-dropdown{
    position:absolute;
    top:100%;
    left:0;
    margin-top:8px;
    min-width:280px;
    max-height:400px;
    overflow-y:auto;
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:12px;
    box-shadow:0 8px 32px rgba(0,0,0,0.4);
    z-index:100;
    display:none;
  }
  
  .chat-dropdown.visible{
    display:block;
  }
  
  .chat-dropdown-header{
    padding:12px 16px;
    border-bottom:1px solid var(--border);
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  
  .chat-dropdown-header h4{
    margin:0;
    font-size:12px;
    color:var(--muted);
    text-transform:uppercase;
    letter-spacing:0.5px;
  }
  
  .chat-dropdown-item{
    padding:12px 16px;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:12px;
    transition:all 0.2s;
    border-bottom:1px solid var(--border);
  }
  
  .chat-dropdown-item:last-child{
    border-bottom:none;
  }
  
  .chat-dropdown-item:hover{
    background:var(--panel-hover);
  }
  
  .chat-dropdown-item.active{
    background:var(--accent-dim);
    border-left:3px solid var(--accent);
  }
  
  .chat-dropdown-item .chat-icon{
    width:36px;
    height:36px;
    border-radius:50%;
    background:var(--accent-dim);
    display:flex;
    align-items:center;
    justify-content:center;
    color:var(--accent);
  }
  
  .chat-dropdown-item .chat-info{
    flex:1;
  }
  
  .chat-dropdown-item .chat-info h5{
    margin:0;
    font-size:14px;
    color:#e8eaed;
  }
  
  .chat-dropdown-item .chat-info span{
    font-size:12px;
    color:var(--muted);
  }
  
  .chat-dropdown-section{
    padding:8px 16px;
    background:rgba(255,255,255,0.02);
    border-bottom:1px solid var(--border);
  }
  
  .chat-dropdown-section h4{
    margin:0;
    font-size:11px;
    color:var(--muted);
    text-transform:uppercase;
    letter-spacing:0.5px;
  }
  
  .new-chat-btn{
    width:100%;
    padding:12px 16px;
    background:var(--accent);
    border:none;
    color:#000;
    font-size:14px;
    font-weight:700;
    cursor:pointer;
    transition:all 0.2s;
  }
  
  .new-chat-btn:hover{
    opacity:0.9;
  }
  
  .pinned{
    background:var(--accent-dim);
    padding:12px 16px;
    border-left:4px solid var(--accent);
    color:#cfeed0;
    border-radius:8px;
    margin:12px 16px;
  }
  
  .scroller{
    overflow-y:auto;
    padding:16px 12px;
    background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
  }
  
  .msg{
    display:grid;
    grid-template-columns:48px 1fr;
    gap:12px;
    padding:12px;
    background:var(--msg);
    border-radius:10px;
    margin:8px 0;
    border:1px solid var(--border);
    transition:all 0.2s;
  }
  
  .msg:hover{
    background:var(--msgAlt);
    border-color:rgba(255,255,255,0.1);
  }
  
  .msg.bot-private{
    background:rgba(59,130,246,0.1);
    border-color:rgba(59,130,246,0.3);
  }
  
  .avatar{
    width:44px;
    height:44px;
    border-radius:50%;
    background:rgba(255,255,255,0.05);
    display:flex;
    align-items:center;
    justify-content:center;
    color:#bbb;
    font-weight:700;
    overflow:hidden;
    border:2px solid var(--border);
  }
  
  .avatar img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }
  
  .meta{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  
  .name{
    font-weight:700;
    color:var(--accent);
  }
  
  .when{
    font-size:12px;
    color:var(--muted);
  }
  
  .text{
    white-space:pre-wrap;
    word-break:break-word;
    margin-top:6px;
    line-height:1.5;
  }
  
  .bubble-actions{
    margin-left:auto;
    display:flex;
    gap:6px;
    flex-wrap:wrap;
  }
  
  .btn{
    background:var(--panel);
    border:1px solid var(--border);
    color:#e8eaed;
    border-radius:8px;
    padding:8px 12px;
    font-size:12px;
    cursor:pointer;
    transition:all 0.2s;
    font-weight:600;
  }
  
  .btn:hover{
    background:var(--panel-hover);
    border-color:var(--accent);
    transform:translateY(-1px);
  }
  
  .btn.danger{
    background:#ef4444;
    border-color:#ff8a8a;
    color:#fff;
  }
  
  .btn.danger:hover{
    background:#dc2626;
  }
  
  .composer{
    display:flex;
    gap:8px;
    padding:16px;
    background:var(--panel);
    border-top:1px solid var(--border);
    align-items:center;
    box-shadow:0 -2px 10px rgba(0,0,0,0.2);
  }
  
  .composer input[type="text"]{
    flex:1;
    padding:12px 16px;
    border-radius:10px;
    border:1px solid var(--border);
    background:var(--bg);
    color:#fff;
    font-size:14px;
    transition:all 0.2s;
  }
  
  .composer input[type="text"]:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow:0 0 0 3px var(--accent-dim);
  }
  
  .composer .attachBtn{
    background:var(--panel-hover);
    border:1px solid var(--border);
    color:#fff;
    padding:10px 14px;
    border-radius:10px;
    cursor:pointer;
    transition:all 0.2s;
  }
  
  .composer .attachBtn:hover{
    background:var(--accent-dim);
    border-color:var(--accent);
  }
  
  .composer .send{
    background:var(--accent);
    border:none;
    color:#000;
    padding:12px 20px;
    border-radius:10px;
    cursor:pointer;
    font-weight:700;
    transition:all 0.2s;
  }
  
  .composer .send:hover{
    opacity:0.9;
    transform:translateY(-1px);
  }
  
  .composer .send:disabled{
    opacity:0.5;
    cursor:not-allowed;
  }
  
  .notice{
    margin:8px 16px;
    color:#ffb4b4;
    font-size:13px;
    padding:8px 12px;
    background:rgba(239,68,68,0.1);
    border-radius:8px;
    border:1px solid rgba(239,68,68,0.2);
  }
  
  .modpanel{
    background:var(--panel);
    padding:16px;
    overflow-y:auto;
    border-left:1px solid var(--border);
    display:none;
  }
  
  .modpanel.visible{
    display:block;
  }
  
  .modpanel h3{
    margin:0 0 16px 0;
    color:var(--accent);
    font-size:18px;
  }
  
  .modpanel h4{
    margin:16px 0 8px 0;
    color:#e8eaed;
    font-size:14px;
    font-weight:600;
  }
  
  .small{
    font-size:13px;
    color:var(--muted);
  }
  
  .list{
    max-height:200px;
    overflow-y:auto;
    padding:8px;
    border-radius:8px;
    background:rgba(255,255,255,0.02);
    border:1px solid var(--border);
  }
  
  .list div{
    padding:8px;
    border-bottom:1px solid var(--border);
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  
  .list div:last-child{
    border-bottom:none;
  }
  
  .poll{
    background:rgba(255,255,255,0.02);
    padding:12px;
    border-radius:8px;
    margin:8px 0;
    border:1px solid var(--border);
  }
  
  .attachment{
    max-width:280px;
    border-radius:8px;
    margin-top:8px;
    border:1px solid var(--border);
  }
  
  .badword-list-item{
    display:flex;
    justify-content:space-between;
    gap:8px;
    padding:8px;
    border-bottom:1px solid var(--border);
  }
  
  .badword-list-item:last-child{
    border-bottom:none;
  }
  
  .badword-input{
    display:flex;
    gap:6px;
    margin-top:8px;
    flex-wrap:wrap;
  }
  
  .badword-input input{
    flex:1;
    min-width:150px;
    padding:8px 12px;
    border-radius:8px;
    border:1px solid var(--border);
    background:var(--bg);
    color:#fff;
    font-size:13px;
  }
  
  .pending-pic-row{
    display:flex;
    gap:12px;
    align-items:center;
    padding:12px;
    border-bottom:1px solid var(--border);
    background:rgba(255,255,255,0.01);
    border-radius:8px;
    margin-bottom:8px;
  }
  
  .pending-pic-row img{
    width:64px;
    height:64px;
    border-radius:8px;
    object-fit:cover;
    border:2px solid var(--border);
  }
  
  .pending-pic-meta{
    flex:1;
  }
  
  .game-req-item,
  .mod-notif-item,
  .mod-chat-item{
    padding:10px;
    border-bottom:1px solid var(--border);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
  }
  
  .create-chat-dropdown{
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    background:var(--panel);
    padding:24px;
    border-radius:12px;
    box-shadow:0 8px 40px rgba(0,0,0,0.6);
    z-index:100;
    width:400px;
    max-width:90vw;
    max-height:80vh;
    overflow-y:auto;
    display:none;
    flex-direction:column;
    gap:16px;
    border:1px solid var(--border);
  }
  
  .create-chat-dropdown.visible{
    display:flex;
  }
  
  .create-chat-dropdown h4{
    margin:0;
    color:var(--accent);
    font-size:18px;
  }
  
  .create-chat-dropdown input{
    width:100%;
    padding:10px 14px;
    border:1px solid var(--border);
    background:var(--bg);
    color:#fff;
    border-radius:8px;
    font-size:14px;
  }
  
  .create-chat-dropdown input:focus{
    outline:none;
    border-color:var(--accent);
  }
  
  .create-chat-dropdown .user-list{
    max-height:300px;
    overflow-y:auto;
    border:1px solid var(--border);
    border-radius:8px;
    background:rgba(255,255,255,0.02);
  }
  
  .create-chat-dropdown .user-item{
    padding:10px 12px;
    cursor:pointer;
    display:flex;
    gap:10px;
    align-items:center;
    transition:all 0.2s;
  }
  
  .create-chat-dropdown .user-item:hover{
    background:var(--panel-hover);
  }
  
  .create-chat-dropdown .user-item.selected{
    background:var(--accent-dim);
    border-left:3px solid var(--accent);
  }
  
  /* Announcement Modal */
  .announcement-overlay{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.8);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
  }
  
  .announcement-overlay.visible{
    display:flex;
  }
  
  .announcement-modal{
    background:var(--panel);
    border:2px solid var(--accent);
    border-radius:16px;
    padding:32px;
    max-width:600px;
    width:90%;
    position:relative;
    box-shadow:0 0 40px var(--accent-dim);
  }
  
  .announcement-close{
    position:absolute;
    top:12px;
    right:12px;
    width:32px;
    height:32px;
    border-radius:50%;
    background:rgba(255,255,255,0.1);
    border:1px solid var(--border);
    color:#fff;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:20px;
    transition:all 0.2s;
  }
  
  .announcement-close:hover{
    background:var(--accent);
    color:#000;
  }
  
  .announcement-title{
    font-size:24px;
    font-weight:700;
    color:var(--accent);
    margin-bottom:16px;
  }
  
  .announcement-text{
    font-size:16px;
    line-height:1.6;
    color:#e8eaed;
    white-space:pre-wrap;
  }
  
  .mod-cmd-hint{
    color:var(--muted);
    font-size:12px;
    margin-left:4px;
  }

  @media(max-width:1200px){
    .layout{
      grid-template-columns:1fr 300px;
    }
    .layout.fullscreen{
      grid-template-columns:1fr;
    }
  }
  
  @media(max-width:900px){
    .layout{
      grid-template-columns:1fr;
    }
    .modpanel{
      display:none!important;
    }
  }
  
  @media(max-width:600px){
    .sidebar{
      display:none;
    }
    .toggle-btn{
      display:none;
    }
    .app{
      margin-left:0!important;
    }
  }
</style>
</head>
<body>
  <!-- Floating Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="logo-container">
      <img src="taclogos/green.png" alt="Logo" class="logo" id="logo">
    </div>
    
    <nav class="nav-items">
      <a href="index.html" class="nav-item">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
        </svg>
        <span>Home</span>
      </a>
      
      <button class="nav-item active" id="mainChatLink">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
          <circle cx="8" cy="10" r="1.5"/>
          <circle cx="12" cy="10" r="1.5"/>
          <circle cx="16" cy="10" r="1.5"/>
        </svg>
        <span>Chat</span>
      </button>
      
      <a href="notgames.html" class="nav-item">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M21.58 16.09l-1.09-7.66A3.996 3.996 0 0016.53 5H7.47a3.996 3.996 0 00-3.96 3.43l-1.09 7.66C2.2 17.63 3.39 19 4.94 19h0c.68 0 1.32-.27 1.8-.75L9 16h6l2.25 2.25c.48.48 1.13.75 1.8.75h0c1.55 0 2.75-1.37 2.53-2.91zM11 11H9v2H8v-2H6v-1h2V8h1v2h2v1zm4-1c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm2 3c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/>
        </svg>
        <span>Games</span>
      </a>
      
      <a href="apps.html" class="nav-item">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z"/>
        </svg>
        <span>Apps</span>
      </a>
    </nav>
  </aside>
  
  <button class="toggle-btn" id="toggleBtn">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="15 18 9 12 15 6"/>
    </svg>
  </button>

  <div class="layout" id="layout">
    <div class="app" id="app" role="main">
      <div class="topbar">
        <div class="chat-selector" id="chatSelector">
          <button class="chat-selector-btn" id="chatSelectorBtn">
            <span id="chatTitleText"># general</span>
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M7 10l5 5 5-5z"/>
            </svg>
          </button>
          <div class="chat-dropdown" id="chatDropdown">
            <div class="chat-dropdown-header">
              <h4>Channels</h4>
            </div>
            <div class="chat-dropdown-item active" id="mainChatOption" data-chat="main">
              <div class="chat-icon">
                <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/>
                </svg>
              </div>
              <div class="chat-info">
                <h5># general</h5>
                <span>Main chat room</span>
              </div>
            </div>
            <div class="chat-dropdown-item" id="questionsChatOption" data-chat="questions">
              <div class="chat-icon">
                <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                </svg>
              </div>
              <div class="chat-info">
                <h5># questions</h5>
                <span>Ask questions here</span>
              </div>
            </div>
            <div class="chat-dropdown-item" id="helpChatOption" data-chat="help">
              <div class="chat-icon">
                <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
              </div>
              <div class="chat-info">
                <h5># help</h5>
                <span>Get help from the community</span>
              </div>
            </div>
            <div class="chat-dropdown-section" id="privateChatsSection" style="display:none">
              <h4>Private Chats</h4>
            </div>
            <div id="privateChatOptions"></div>
            <button class="new-chat-btn" id="newChatBtn">+ New Private Chat</button>
          </div>
        </div>
        <div class="me">
          <div id="meAvatar" class="me-avatar" title="Click to upload profile picture"></div>
          <input id="profilePicInput" type="file" accept="image/*" style="display:none" />
          <span id="meName">—</span>
          <span id="meRole" class="tag">Member</span>
        </div>
      </div>

      <div id="scroller" class="scroller" aria-live="polite"></div>

      <div id="pinnedSlot" style="display:none">
        <div id="pinnedBox" class="pinned"></div>
      </div>
      
      <div class="composer">
        <div class="notice" style="display:none;width:100%;text-align:center;"></div>
        <input id="msgInput" type="text" placeholder="Message #general" maxlength="1000" />
        <label class="attachBtn btn" title="Attach image">
          Attach
          <input id="fileInput" type="file" accept="image/*" style="display:none">
        </label>
        <button class="send btn" id="sendBtn">Send</button>
      </div>
    </div>

    <div class="modpanel" id="modPanel">
      <h3>Moderation</h3>
      <div class="small">You: <span id="modName">—</span> <span id="modRole" class="tag">Member</span></div>
      
      <h4>Announcement</h4>
      <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px">
        <input id="announcementTitle" placeholder="Announcement title..." style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:#fff">
        <textarea id="announcementText" placeholder="Announcement text..." style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:#fff;resize:vertical;min-height:60px"></textarea>
        <button id="setAnnouncementBtn" class="btn">Set Announcement</button>
        <button id="clearAnnouncementBtn" class="btn danger">Clear Announcement</button>
      </div>
      
      <h4>Private Chat Monitoring</h4>
      <div id="modPrivateChatsList" class="list small">loading…</div>

      <h4>Game Requests</h4>
      <div id="gameRequestsList" class="list small">loading…</div>

      <h4>Mod Notifications</h4>
      <div id="modNotificationsList" class="list small">loading…</div>

      <h4>Mod Chat</h4>
      <div id="modChatList" class="list small" style="max-height:150px">loading…</div>
      <div class="badword-input">
        <input id="modChatInput" placeholder="Send to mods..." style="flex:1">
        <button id="modChatSendBtn" class="btn">Send</button>
      </div>

      <h4>Pause / Pins</h4>
      <button id="togglePause" class="btn" style="width:100%;margin-bottom:8px">Toggle Pause</button>

      <h4>Auto-ban Settings</h4>
      <div class="small" style="display:grid;gap:8px">
        <div>Threshold: <input id="abThreshold" type="number" min="1" value="3" style="width:60px;padding:4px;border-radius:4px;border:1px solid var(--border);background:var(--bg);color:#fff"></div>
        <div>Window (sec): <input id="abWindow" type="number" min="1" value="60" style="width:60px;padding:4px;border-radius:4px;border:1px solid var(--border);background:var(--bg);color:#fff"></div>
        <div>Duration (min): <input id="abDuration" type="number" min="1" value="60" style="width:60px;padding:4px;border-radius:4px;border:1px solid var(--border);background:var(--bg);color:#fff"></div>
        <button id="saveAb" class="btn">Save Settings</button>
      </div>

      <h4>Banned Users</h4>
      <div id="bannedList" class="list small">loading…</div>

      <h4>Timeouts</h4>
      <div id="timeoutList" class="list small">loading…</div>

      <h4>Offenses</h4>
      <div id="offensesList" class="list small">loading…</div>

      <h4>Profanity List</h4>
      <div id="badWordsList" class="list small">loading…</div>
      <div class="badword-input">
        <input id="badwordInput" placeholder="Add bad word..." style="flex:1">
        <button id="badwordAddBtn" class="btn">Add</button>
        <button id="resetBadwords" class="btn secondary">Reset</button>
      </div>

      <h4>Regex Filters</h4>
      <div id="regexList" class="list small">loading…</div>
      <div class="badword-input">
        <input id="regexInput" placeholder="Add regex (e.g. /test/i)" style="flex:1">
        <button id="regexAddBtn" class="btn">Add</button>
      </div>

      <h4>Custom Bot Responses</h4>
      <div id="botResponsesList" class="list small">loading…</div>
      <div class="badword-input">
        <input id="botCommandInput" placeholder="!command" style="flex:1">
        <input id="botResponseInput" placeholder="Response..." style="flex:1">
        <button id="botResponseAddBtn" class="btn">Add</button>
      </div>

      <h4>Profile Pic Approvals</h4>
      <div id="pendingPicsList" class="list small">loading…</div>

      <h4>Create Poll</h4>
      <div style="display:flex;flex-direction:column;gap:8px">
        <input id="pollQ" placeholder="Poll question..." style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:#fff">
        <input id="pollOptions" placeholder="Option1,Option2,Option3" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:#fff">
        <button id="createPoll" class="btn">Create Poll</button>
      </div>
    </div>
  </div>

  <div class="create-chat-dropdown" id="createChatDropdown">
    <h4>Create a New Chat</h4>
    <p class="small muted">Select up to 9 users for a private chat.</p>
    <input type="text" id="userSearch" placeholder="Search users...">
    <div class="user-list" id="userList"></div>
    <div style="display:flex;gap:8px;">
      <button class="btn" id="confirmCreateChatBtn" style="flex:1">Create</button>
      <button class="btn danger" id="cancelCreateChatBtn" style="flex:1">Cancel</button>
    </div>
  </div>
  
  <!-- Announcement Modal -->
  <div class="announcement-overlay" id="announcementOverlay">
    <div class="announcement-modal">
      <button class="announcement-close" id="announcementClose">×</button>
      <div class="announcement-title" id="announcementModalTitle">Announcement</div>
      <div class="announcement-text" id="announcementModalText"></div>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
/* ================== CONFIG ================== */
const firebaseConfig = {
  apiKey: "AIzaSyBQslLAFRlIRJqsiJ2WWeTNslO067bzKYM",
  authDomain: "taclogin-ab38e.firebaseapp.com",
  databaseURL: "https://taclogin-ab38e-default-rtdb.firebaseio.com",
  projectId: "taclogin-ab38e",
  storageBucket: "taclogin-ab38e.firebasestorage.app",
  messagingSenderId: "937853298051",
  appId: "1:937853298051:web:119ccc7b5499514bd442b6"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================== THEME SYSTEM (from localStorage) ================== */
const themeColors = {
  green: { primary: '#22c55e', dim: 'rgba(34, 197, 94, 0.1)', shadow: 'rgba(34, 197, 94, 0.15)' },
  blue: { primary: '#3b82f6', dim: 'rgba(59, 130, 246, 0.1)', shadow: 'rgba(59, 130, 246, 0.15)' },
  red: { primary: '#ef4444', dim: 'rgba(239, 68, 68, 0.1)', shadow: 'rgba(239, 68, 68, 0.15)' },
  cyan: { primary: '#06b6d4', dim: 'rgba(6, 182, 212, 0.1)', shadow: 'rgba(6, 182, 212, 0.15)' },
  pink: { primary: '#ec4899', dim: 'rgba(236, 72, 153, 0.1)', shadow: 'rgba(236, 72, 153, 0.15)' },
  purple: { primary: '#8b5cf6', dim: 'rgba(139, 92, 246, 0.1)', shadow: 'rgba(139, 92, 246, 0.15)' },
  yellow: { primary: '#eab308', dim: 'rgba(234, 179, 8, 0.1)', shadow: 'rgba(234, 179, 8, 0.15)' },
  orange: { primary: '#f97316', dim: 'rgba(249, 115, 22, 0.1)', shadow: 'rgba(249, 115, 22, 0.15)' },
  white: { primary: '#ffffff', dim: 'rgba(255, 255, 255, 0.1)', shadow: 'rgba(255, 255, 255, 0.15)' },
  whiteout: { primary: '#f5f5f5', dim: 'rgba(255, 255, 255, 0.05)', shadow: 'rgba(255, 255, 255, 0.1)' }
};

function applyTheme() {
  const theme = localStorage.getItem('theme') || 'green';
  const colors = themeColors[theme] || themeColors.green;
  
  document.documentElement.style.setProperty('--accent', colors.primary);
  document.documentElement.style.setProperty('--accent-dim', colors.dim);
  
  const logo = document.getElementById('logo');
  if (logo) logo.src = `taclogos/${theme}.png`;
  
  const sidebar = document.getElementById('sidebar');
  if (sidebar) sidebar.style.boxShadow = `0 0 20px ${colors.shadow}`;
}

window.addEventListener('storage', (e) => {
  if (e.key === 'theme') applyTheme();
});

applyTheme();

/* ================== DOM refs ================== */
const sidebar = document.getElementById('sidebar');
const toggleBtn = document.getElementById('toggleBtn');
const app = document.getElementById('app');
const layout = document.getElementById('layout');
const scroller = document.getElementById('scroller');
const input = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const fileInput = document.getElementById('fileInput');
const profilePicInput = document.getElementById('profilePicInput');
const notice = document.querySelector('.notice');
const bannedListEl = document.getElementById('bannedList');
const timeoutListEl = document.getElementById('timeoutList');
const offensesListEl = document.getElementById('offensesList');
const pendingPicsListEl = document.getElementById('pendingPicsList');
const abThresholdEl = document.getElementById('abThreshold');
const abWindowEl = document.getElementById('abWindow');
const abDurationEl = document.getElementById('abDuration');
const saveAbBtn = document.getElementById('saveAb');
const pollQEl = document.getElementById('pollQ');
const pollOptionsEl = document.getElementById('pollOptions');
const createPollBtn = document.getElementById('createPoll');
const pinnedSlot = document.getElementById('pinnedSlot');
const pinnedBox = document.getElementById('pinnedBox');
const togglePauseBtn = document.getElementById('togglePause');
const badWordsListEl = document.getElementById('badWordsList');
const badwordInput = document.getElementById('badwordInput');
const badwordAddBtn = document.getElementById('badwordAddBtn');
const resetBadwordsBtn = document.getElementById('resetBadwords');
const chatTitleText = document.getElementById('chatTitleText');
const mainChatLink = document.getElementById('mainChatLink');
const modPrivateChatsList = document.getElementById('modPrivateChatsList');
const gameRequestsList = document.getElementById('gameRequestsList');
const modNotificationsList = document.getElementById('modNotificationsList');
const modChatList = document.getElementById('modChatList');
const modChatInput = document.getElementById('modChatInput');
const modChatSendBtn = document.getElementById('modChatSendBtn');
const regexList = document.getElementById('regexList');
const regexInput = document.getElementById('regexInput');
const regexAddBtn = document.getElementById('regexAddBtn');
const botResponsesList = document.getElementById('botResponsesList');
const botCommandInput = document.getElementById('botCommandInput');
const botResponseInput = document.getElementById('botResponseInput');
const botResponseAddBtn = document.getElementById('botResponseAddBtn');
const createChatDropdown = document.getElementById('createChatDropdown');
const userSearch = document.getElementById('userSearch');
const userListEl = document.getElementById('userList');
const confirmCreateChatBtn = document.getElementById('confirmCreateChatBtn');
const cancelCreateChatBtn = document.getElementById('cancelCreateChatBtn');
const announcementOverlay = document.getElementById('announcementOverlay');
const announcementClose = document.getElementById('announcementClose');
const announcementModalTitle = document.getElementById('announcementModalTitle');
const announcementModalText = document.getElementById('announcementModalText');
const announcementTitle = document.getElementById('announcementTitle');
const announcementText = document.getElementById('announcementText');
const setAnnouncementBtn = document.getElementById('setAnnouncementBtn');
const clearAnnouncementBtn = document.getElementById('clearAnnouncementBtn');
const chatSelectorBtn = document.getElementById('chatSelectorBtn');
const chatDropdown = document.getElementById('chatDropdown');
const mainChatOption = document.getElementById('mainChatOption');
const questionsChatOption = document.getElementById('questionsChatOption');
const helpChatOption = document.getElementById('helpChatOption');
const privateChatOptions = document.getElementById('privateChatOptions');
const privateChatsSection = document.getElementById('privateChatsSection');
const newChatBtn = document.getElementById('newChatBtn');

/* ================== LOGIN / MOD AUTH ================== */
// Use lastLoggedInUser from localStorage instead of asking for username
let username = (localStorage.getItem('lastLoggedInUser') || '').trim();
if(!username){
  // Fallback: if no lastLoggedInUser, redirect or show error
  alert('No user logged in. Please log in first.');
  // Optionally redirect to login page:
  // window.location.href = 'login.html';
}

const meNameEl = document.getElementById('meName');
const meRoleEl = document.getElementById('meRole');
const modName = document.getElementById('modName');
const modRole = document.getElementById('modRole');
const meAvatarEl = document.getElementById('meAvatar');
meNameEl.textContent = username;
modName.textContent = username;

let myRole = "Member";
const defaultRoleFor = (n)=>{
  if(/^logan$/i.test(n)) return "Head Dev";
  if(/^leonardo$/i.test(n)) return "Head Moderator";
  return "Member";
};

const modPanel = document.getElementById('modPanel');
let modAuthenticated = !!localStorage.getItem('modAuth');

function canModerate(role){
  return role === 'Head Dev' || role === 'Head Moderator' || modAuthenticated;
}

function updateModPanelVisibility(){
  if(canModerate(myRole)){
    modAuthenticated = true;
    localStorage.setItem('modAuth','1');
    modPanel.classList.add('visible');
    layout.classList.remove('fullscreen');
    app.classList.remove('fullscreen');
    sidebar.classList.remove('hidden');
    toggleBtn.classList.remove('hidden');
  } else {
    modPanel.classList.remove('visible');
    layout.classList.add('fullscreen');
    app.classList.add('fullscreen');
    sidebar.classList.add('hidden');
    toggleBtn.classList.add('hidden');
  }
}

db.ref('users/' + username + '/role').once('value').then(s=>{
  myRole = s.val() || defaultRoleFor(username);
  meRoleEl.textContent = myRole;
  modRole.textContent = myRole;
  meRoleEl.className = 'tag ' + (myRole === 'Head Dev' ? 'dev' : myRole === 'Head Moderator' ? 'mod' : '');
  modRole.className = 'tag ' + (myRole === 'Head Dev' ? 'dev' : myRole === 'Head Moderator' ? 'mod' : '');
  db.ref('users/' + username).update({ name: username, role: myRole }).catch(()=>{});
  updateModPanelVisibility();
});

/* ================== SIDEBAR TOGGLE ================== */
toggleBtn.addEventListener('click', () => {
  sidebar.classList.toggle('collapsed');
  toggleBtn.classList.toggle('collapsed');
  app.classList.toggle('expanded');
});

/* ================== Utilities ================== */
const showNotice = (txt, ms=3500) => {
  notice.textContent = txt;
  notice.style.display = 'block';
  setTimeout(()=> notice.style.display = 'none', ms);
};
const fmtTime = ts => new Date(ts).toLocaleTimeString();
const avatarLetters = n => (n||'?').trim().slice(0,2).toUpperCase();

/* ================== CHAT SELECTOR DROPDOWN ================== */
chatSelectorBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  chatDropdown.classList.toggle('visible');
  chatSelectorBtn.classList.toggle('open');
});

document.addEventListener('click', (e) => {
  if (!chatDropdown.contains(e.target) && !chatSelectorBtn.contains(e.target)) {
    chatDropdown.classList.remove('visible');
    chatSelectorBtn.classList.remove('open');
  }
});

mainChatOption.addEventListener('click', () => {
  loadChat('main');
  chatDropdown.classList.remove('visible');
  chatSelectorBtn.classList.remove('open');
});

questionsChatOption.addEventListener('click', () => {
  loadChat('questions');
  chatDropdown.classList.remove('visible');
  chatSelectorBtn.classList.remove('open');
});

helpChatOption.addEventListener('click', () => {
  loadChat('help');
  chatDropdown.classList.remove('visible');
  chatSelectorBtn.classList.remove('open');
});

newChatBtn.addEventListener('click', () => {
  createChatDropdown.classList.add('visible');
  chatDropdown.classList.remove('visible');
  chatSelectorBtn.classList.remove('open');
  userSearch.focus();
  userSearch.value = '';
  selectedUsers = [];
  renderUserListForDropdown();
});

/* ================== ANNOUNCEMENT SYSTEM ================== */
db.ref('moderation/announcement').on('value', snap => {
  const announcement = snap.val();
  const dismissedKey = 'announcement_dismissed_' + (announcement?.timestamp || '');
  
  if (announcement && announcement.title && !localStorage.getItem(dismissedKey)) {
    announcementModalTitle.textContent = announcement.title;
    announcementModalText.textContent = announcement.text || '';
    announcementOverlay.classList.add('visible');
  } else {
    announcementOverlay.classList.remove('visible');
  }
});

announcementClose.addEventListener('click', () => {
  db.ref('moderation/announcement').once('value').then(snap => {
    const announcement = snap.val();
    if (announcement && announcement.timestamp) {
      localStorage.setItem('announcement_dismissed_' + announcement.timestamp, 'true');
    }
    announcementOverlay.classList.remove('visible');
  });
});

setAnnouncementBtn.addEventListener('click', async () => {
  if (!canModerate(myRole)) { showNotice('Mod access required'); return; }
  const title = announcementTitle.value.trim();
  const text = announcementText.value.trim();
  if (!title) { showNotice('Title required'); return; }
  
  await db.ref('moderation/announcement').set({
    title: title,
    text: text,
    timestamp: Date.now(),
    setBy: username
  });
  
  announcementTitle.value = '';
  announcementText.value = '';
  showNotice('Announcement set');
});

clearAnnouncementBtn.addEventListener('click', async () => {
  if (!canModerate(myRole)) { showNotice('Mod access required'); return; }
  await db.ref('moderation/announcement').remove();
  showNotice('Announcement cleared');
});

/* ================== USER PROFILE PIC STATE ================== */
let usersProfilePics = {};
let myProfilePic = null;
let allUsers = [];

db.ref('users').on('value', snap=>{
  const all = snap.val() || {};
  usersProfilePics = {};
  allUsers = [];
  Object.entries(all).forEach(([k,v])=>{
    if(v && v.profilePic) usersProfilePics[k] = v.profilePic;
    allUsers.push(k);
  });
  if(usersProfilePics[username]){
    myProfilePic = usersProfilePics[username];
    renderMyAvatar(myProfilePic);
  } else {
    renderMyAvatar(null);
  }
  renderUserListForDropdown();
});

function renderMyAvatar(dataUrl){
  meAvatarEl.innerHTML = '';
  if(dataUrl){
    const img = document.createElement('img'); img.src = dataUrl; meAvatarEl.appendChild(img);
  } else {
    meAvatarEl.textContent = avatarLetters(username);
  }
}

/* ================== PROFANITY (DB-driven) ================== */
const DEFAULT_BAD_WORDS = ['*****','*****','*****','*****','*****','*****','*****','*****','*****','*****','*****'];
let badWordMap = {};
let PROFANITY_REGEXES = [];
let customRegexList = {};

function rebuildProfanityRegexes(){
  const words = Object.values(badWordMap).length ? Object.values(badWordMap) : DEFAULT_BAD_WORDS;
  PROFANITY_REGEXES = words.map(wordToRegex);
  
  Object.values(customRegexList).forEach(regexStr => {
    try {
      const parts = regexStr.match(/^\/(.*?)\/([gimsuy]*)$/);
      if (parts) {
        PROFANITY_REGEXES.push(new RegExp(parts[1], parts[2]));
      } else {
        PROFANITY_REGEXES.push(new RegExp(regexStr, 'i'));
      }
    } catch (e) {
      console.error("Invalid regex:", regexStr, e);
    }
  });
}

function wordToRegex(word){
  const chars = word.split('').map(ch => ch.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&') + '\\W*').join('');
  return new RegExp('\\b' + chars + '\\b','i');
}

function containsProfanity(text){
  if(!text) return false;
  for(const r of PROFANITY_REGEXES) if(r.test(text)) return true;
  return false;
}

db.ref('moderation/badWords').on('value', snap=>{
  const val = snap.val() || {};
  if(Array.isArray(val)){
    badWordMap = {};
    val.forEach((w,i)=> { if(w) badWordMap['k'+i] = String(w).toLowerCase(); });
  } else {
    badWordMap = {};
    Object.entries(val).forEach(([k,v])=> { badWordMap[k] = String(v).toLowerCase(); });
  }
  rebuildProfanityRegexes();
  renderBadWordsUI();
});

function renderBadWordsUI(){
  badWordsListEl.innerHTML = '';
  const entries = Object.entries(badWordMap);
  if(!entries.length){
    badWordsListEl.innerHTML = '<div class="small muted">No words set - using defaults.</div>';
    return;
  }
  entries.forEach(([k,w])=>{
    const row = document.createElement('div');
    row.className = 'badword-list-item';
    const lbl = document.createElement('div'); lbl.textContent = w;
    const actions = document.createElement('div');
    const del = document.createElement('button'); del.className = 'btn danger'; del.textContent = 'Delete';
    del.onclick = ()=> { db.ref('moderation/badWords/'+k).remove(); };
    actions.appendChild(del);
    row.appendChild(lbl); row.appendChild(actions);
    badWordsListEl.appendChild(row);
  });
}

badwordAddBtn.addEventListener('click', async ()=>{
  if(!canModerate(myRole)){ showNotice('Mod access required'); return; }
  const v = (badwordInput.value||'').trim().toLowerCase();
  if(!v) return;
  if(/\s/.test(v)){ showNotice('Single word only.'); return; }
  await db.ref('moderation/badWords').push(v);
  badwordInput.value = '';
});

resetBadwordsBtn.addEventListener('click', async ()=>{
  if(!canModerate(myRole)){ showNotice('Mod access required'); return; }
  const ok = prompt('Replace with defaults? Type YES to confirm.');
  if (ok !== 'YES') return;
  const obj = {};
  DEFAULT_BAD_WORDS.forEach(w=> { const k = db.ref().push().key; obj[k] = w; });
  await db.ref('moderation/badWords').set(obj);
  showNotice('Profanity list reset.');
});

db.ref('moderation/regex').on('value', snap => {
  customRegexList = snap.val() || {};
  rebuildProfanityRegexes();
  renderRegexUI();
});

function renderRegexUI() {
  regexList.innerHTML = '';
  const entries = Object.entries(customRegexList);
  if (!entries.length) {
    regexList.innerHTML = '<div class="small muted">No regex patterns.</div>';
    return;
  }
  entries.forEach(([k, w]) => {
    const row = document.createElement('div');
    row.className = 'badword-list-item';
    const lbl = document.createElement('div'); lbl.textContent = w;
    const actions = document.createElement('div');
    const del = document.createElement('button'); del.className = 'btn danger'; del.textContent = 'Delete';
    del.onclick = () => { db.ref('moderation/regex/' + k).remove(); };
    actions.appendChild(del);
    row.appendChild(lbl);
    row.appendChild(actions);
    regexList.appendChild(row);
  });
}

regexAddBtn.addEventListener('click', async () => {
  if (!canModerate(myRole)) { showNotice('Mod access required'); return; }
  const v = (regexInput.value || '').trim();
  if (!v) return;
  try {
    const parts = v.match(/^\/(.*?)\/([gimsuy]*)$/);
    if (parts) {
      new RegExp(parts[1], parts[2]);
    } else {
      new RegExp(v);
    }
  } catch (e) {
    showNotice("Invalid regex pattern.");
    return;
  }
  await db.ref('moderation/regex').push(v);
  regexInput.value = '';
});

/* ================== AUTO-BAN SETTINGS ================== */
const defaultAutoBan = { threshold: 3, windowMs: 60_000, durationMs: 60*60_000 };
let autoBanSettings = { ...defaultAutoBan };

const loadAutoBan = ()=> db.ref('moderation/settings').once('value').then(s=>{
  const val = s.val();
  if(val && val.threshold) autoBanSettings = { ...autoBanSettings, ...val };
  abThresholdEl.value = autoBanSettings.threshold;
  abWindowEl.value = Math.round(autoBanSettings.windowMs/1000);
  abDurationEl.value = Math.round(autoBanSettings.durationMs/60000);
}).catch(()=>{
  abThresholdEl.value = autoBanSettings.threshold;
  abWindowEl.value = Math.round(autoBanSettings.windowMs/1000);
  abDurationEl.value = Math.round(autoBanSettings.durationMs/60000);
});

saveAbBtn.addEventListener('click', ()=>{
  const t = Math.max(1, parseInt(abThresholdEl.value||'3',10));
  const w = Math.max(1, parseInt(abWindowEl.value||'60',10));
  const d = Math.max(1, parseInt(abDurationEl.value||'60',10));
  autoBanSettings = { threshold: t, windowMs: w*1000, durationMs: d*60_000 };
  db.ref('moderation/settings').set(autoBanSettings);
  showNotice('Auto-ban settings saved.');
});

/* ================== OFFENSES & AUTO-BAN ================== */
async function recordOffense(name){
  const key = name.toLowerCase();
  const timesRef = db.ref('offenses/' + key + '/times');
  const now = Date.now();
  const pushRef = timesRef.push();
  await pushRef.set(now);
  const cutoff = now - autoBanSettings.windowMs;
  const snap = await timesRef.once('value');
  const times = snap.exists() ? Object.entries(snap.val()).map(([k,v])=>({k,t:v})) : [];
  const keep = times.filter(t=>t.t >= cutoff);
  const updates = {};
  keep.forEach((t)=> updates[t.k] = t.t);
  await timesRef.set(updates);
  const count = keep.length;
  if(count >= autoBanSettings.threshold){
    const until = Date.now() + autoBanSettings.durationMs;
    await db.ref('bans/' + key).set(until);
    await timesRef.remove();
    showNotice(`${name} was auto-banned for ${Math.round(autoBanSettings.durationMs/60000)} min.`);
  }
}

/* ================== TIMEOUTS & BANS ================== */
async function isBanned(name){
  if(!name) return false;
  const key = name.toLowerCase();
  const snap = await db.ref('bans/'+key).once('value');
  const val = snap.val();
  if(!val) return false;
  if(val === 'perm') return 'perm';
  const now = Date.now();
  if(val > now) return val;
  await db.ref('bans/'+key).remove();
  return false;
}

async function isTimedOut(name){
  if(!name) return 0;
  const snap = await db.ref('timeouts/'+name.toLowerCase()).once('value');
  const until = snap.val() || 0;
  if(until && until > Date.now()) return until;
  if(until) await db.ref('timeouts/'+name.toLowerCase()).remove();
  return 0;
}

function setTimeoutFor(name, msFromNow){
  const until = Date.now() + msFromNow;
  return db.ref('timeouts/'+name.toLowerCase()).set(until);
}

/* ================== SPAM PROTECTION ================== */
const MSG_WINDOW_MS = 10_000;
const MSG_MAX = 5;
const CLIENT_SENDS = [];
function recordClientSend(){ const now = Date.now(); CLIENT_SENDS.push(now); while(CLIENT_SENDS.length>MSG_MAX) CLIENT_SENDS.shift(); }
function checkClientSpam(){ const now = Date.now(); const cutoff = now - MSG_WINDOW_MS; const recent = CLIENT_SENDS.filter(t=>t>=cutoff).length; return recent >= MSG_MAX; }

/* ================== ATTACHMENTS ================== */
async function uploadAttachment(file){
  const MAX = 300 * 1024;
  if(file.size > MAX){ showNotice('File too large. Max ~300KB.'); return null; }
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = async ()=> {
      const dataUrl = fr.result;
      const id = db.ref('attachments').push().key;
      await db.ref('attachments/' + id).set({ uploader: username, name: file.name, dataUrl, createdAt: Date.now() });
      res({ id, dataUrl });
    };
    fr.onerror = e=> { showNotice('Failed reading file'); rej(e); };
    fr.readAsDataURL(file);
  });
}

/* ================== USER PROFILE PIC UPLOAD ================== */
meAvatarEl.addEventListener('click', async () => {
  const snap = await db.ref('users/' + username + '/profilePic').once('value');
  if(snap.exists() && snap.val()){
    showNotice('You already have a profile picture.');
    return;
  }
  profilePicInput.click();
});

profilePicInput.addEventListener('change', async (e) => {
  const file = profilePicInput.files && profilePicInput.files[0];
  if(!file) return;
  const MAX = 300 * 1024;
  if(file.size > MAX){ showNotice('File too large. Max ~300KB.'); profilePicInput.value = ''; return; }
  const fr = new FileReader();
  fr.onload = async () => {
    const dataUrl = fr.result;
    const id = db.ref('profilePicsPending').push().key;
    await db.ref('profilePicsPending/' + id).set({ uploader: username, name: file.name, dataUrl, createdAt: Date.now() });
    showNotice('Profile picture uploaded, awaiting approval.');
    profilePicInput.value = '';
  };
  fr.onerror = () => { showNotice('Failed reading file'); profilePicInput.value = ''; };
  fr.readAsDataURL(file);
});

/* ================== PROFILE PIC APPROVALS ================== */
db.ref('profilePicsPending').on('value', snap => {
  const val = snap.val() || {};
  pendingPicsListEl.innerHTML = '';
  const entries = Object.entries(val);
  if(!entries.length){
    pendingPicsListEl.innerHTML = '<div class="small muted">No pending pictures.</div>';
    return;
  }
  entries.forEach(([id,data])=>{
    const row = document.createElement('div');
    row.className = 'pending-pic-row';
    const img = document.createElement('img'); img.src = data.dataUrl || '';
    const meta = document.createElement('div'); meta.className = 'pending-pic-meta';
    meta.innerHTML = `<div style="font-weight:700">${data.uploader}</div><div class="small muted">${new Date(data.createdAt||0).toLocaleString()}</div>`;
    const actions = document.createElement('div');
    actions.style.display = 'flex';
    actions.style.gap = '6px';
    const approveBtn = document.createElement('button'); approveBtn.className='btn'; approveBtn.textContent='Approve';
    const rejectBtn = document.createElement('button'); rejectBtn.className='btn danger'; rejectBtn.textContent='Reject';
    approveBtn.onclick = async () => {
      if(!canModerate(myRole)){ showNotice('Mod access required'); return; }
      await db.ref('users/' + data.uploader + '/profilePic').set(data.dataUrl);
      await db.ref('profilePicsPending/' + id).remove();
      showNotice('Profile picture approved.');
    };
    rejectBtn.onclick = async () => {
      if(!canModerate(myRole)){ showNotice('Mod access required'); return; }
      await db.ref('profilePicsPending/' + id).remove();
      showNotice('Profile picture rejected.');
    };
    actions.appendChild(approveBtn);
    actions.appendChild(rejectBtn);
    row.appendChild(img);
    row.appendChild(meta);
    row.appendChild(actions);
    pendingPicsListEl.appendChild(row);
  });
});

/* ================== POLLS ================== */
async function createPoll(question, optionsArr){
  const key = db.ref('polls').push().key;
  const obj = { question, options: {}, votes: {}, createdBy: username, createdAt: Date.now(), active: true };
  optionsArr.forEach(o=> obj.options[o] = 0);
  await db.ref('polls/' + key).set(obj);
  const chatId = db.ref('chat/messages').push().key;
  const chatMsg = { id: chatId, type: 'poll', pollId: key, user: username, role: myRole, text: question, timestamp: firebase.database.ServerValue.TIMESTAMP };
  await db.ref('chat/messages/' + chatId).set(chatMsg);
}

/* ================== PINNING & PAUSE ================== */
async function setPinnedMessage(msgId){ await db.ref('moderation/pinned').set(msgId || null); }
async function setPaused(val){ await db.ref('moderation/paused').set(!!val); }

/* ================== RENDER MESSAGES & POLLS ================== */
function renderMessageObj(m, id, chatId='main', isPrivateBotMsg=false){
  const wrap = document.createElement('div'); 
  wrap.className = 'msg' + (isPrivateBotMsg ? ' bot-private' : ''); 
  wrap.id = 'm_' + id;
  const avatar = document.createElement('div'); avatar.className='avatar';
  if(usersProfilePics[m.user]){
    const img = document.createElement('img'); img.src = usersProfilePics[m.user]; avatar.appendChild(img);
  } else {
    avatar.textContent = avatarLetters(m.user);
  }
  const main = document.createElement('div');
  const meta = document.createElement('div'); meta.className='meta';
  const name = document.createElement('span'); name.className='name'; name.textContent = m.user;
  const role = document.createElement('span'); role.className='tag ' + (m.role === 'Head Dev' ? 'dev' : m.role === 'Head Moderator' ? 'mod' : '');
  role.textContent = m.role || 'Member';
  const when = document.createElement('span'); when.className='when'; when.textContent = fmtTime(m.timestamp || Date.now());
  const actions = document.createElement('div'); actions.className='bubble-actions';

  if(!canModerate(myRole) && chatId !== 'main' && chatId !== 'questions' && chatId !== 'help'){
    const leaveBtn = document.createElement('button');
    leaveBtn.className = 'btn danger';
    leaveBtn.textContent = 'Leave';
    leaveBtn.onclick = () => {
      db.ref('private_chats/' + chatId + '/members/' + username).remove();
      db.ref('users/' + username + '/private_chats/' + chatId).remove();
      activeChatId = 'main';
      loadChat('main');
      showNotice('You left the chat.');
    };
    actions.appendChild(leaveBtn);
  }

  if(canModerate(myRole) && !isPrivateBotMsg){
    const pin = document.createElement('button');
    pin.className='btn';
    pin.textContent = (pinnedId === id) ? 'Unpin' : 'Pin';
    pin.onclick = async ()=> {
      if (pinnedId === id) {
        await setPinnedMessage(null);
        showNotice('Unpinned.');
      } else {
        await setPinnedMessage(id);
        showNotice('Pinned.');
      }
    };
    actions.appendChild(pin);
    const del = document.createElement('button'); del.className='btn danger'; del.textContent = 'Delete';
    del.onclick = ()=> {
      const refPath = chatId === 'main' ? 'chat/messages/' : 
                      chatId === 'questions' ? 'chat/questions/' :
                      chatId === 'help' ? 'chat/help/' :
                      `private_chats/${chatId}/messages/`;
      db.ref(refPath + id).remove();
      showNotice('Deleted.');
    };
    const ban = document.createElement('button'); ban.className='btn'; ban.textContent='Ban';
    ban.onclick = ()=> banPrompt(m.user);
    const to = document.createElement('button'); to.className='btn'; to.textContent='Timeout';
    to.onclick = ()=> { const ok = prompt('Timeout seconds (e.g. 30)'); if(ok) setTimeoutFor(m.user, Math.max(1,parseInt(ok,10))*1000); };
    actions.appendChild(del); actions.appendChild(ban); actions.appendChild(to);
  }

  meta.appendChild(name); meta.appendChild(role); meta.appendChild(when); meta.appendChild(actions);
  const text = document.createElement('div'); text.className='text'; text.textContent = m.text || '';
  main.appendChild(meta); main.appendChild(text);

  if(m.type === 'poll' && m.pollId){
    const pollWrap = document.createElement('div'); pollWrap.className='poll'; pollWrap.id = 'poll_' + m.pollId;
    pollWrap.innerHTML = `<strong>Poll: ${m.text}</strong><div id="poll_opts_${m.pollId}" style="margin-top:8px"></div>`;
    main.appendChild(pollWrap);
    
    db.ref('polls/' + m.pollId).on('value', s=>{
      const p = s.val();
      if(!p) return;
      const optEl = document.getElementById('poll_opts_' + m.pollId);
      if(!optEl) return;
      optEl.innerHTML = '';
      const votes = p.votes || {};
      const voteCounts = {};
      Object.values(votes).forEach(opt => {
        voteCounts[opt] = (voteCounts[opt] || 0) + 1;
      });
      
      Object.keys(p.options || {}).forEach(opt=>{
        const row = document.createElement('div');
        row.style.display='flex';
        row.style.gap='8px';
        row.style.alignItems='center';
        row.style.marginBottom='6px';
        const optBtn = document.createElement('button');
        optBtn.className='btn';
        optBtn.textContent = opt;
        optBtn.style.flex = '1';
        optBtn.onclick = ()=> {
          db.ref('polls/' + m.pollId + '/votes/' + username).set(opt);
        };
        if(votes[username] === opt) {
          optBtn.style.background = 'var(--accent)';
          optBtn.style.color = '#000';
        }
        const count = document.createElement('span');
        count.className='small muted';
        count.textContent = `${voteCounts[opt] || 0} votes`;
        row.appendChild(optBtn);
        row.appendChild(count);
        optEl.appendChild(row);
      });
    });
  }

  if(m.attachmentId){
    db.ref('attachments/' + m.attachmentId).once('value').then(s=>{
      const att = s.val();
      if(!att) return;
      const img = document.createElement('img'); img.src = att.dataUrl; img.className = 'attachment';
      main.appendChild(img);
    });
  }
  wrap.appendChild(avatar);
  wrap.appendChild(main);
  return wrap;
}

/* ================== CHAT SWITCHING ================== */
let activeChatId = 'main';
let chatListeners = {};

function detachAllChatListeners() {
  Object.keys(chatListeners).forEach(ref => {
    db.ref(ref).off('child_added', chatListeners[ref]);
    delete chatListeners[ref];
  });
}

function loadChat(chatId) {
  detachAllChatListeners();
  activeChatId = chatId;
  scroller.innerHTML = '';
  
  // Update dropdown active states
  document.querySelectorAll('.chat-dropdown-item').forEach(el => el.classList.remove('active'));
  
  if(chatId === 'main') {
    mainChatOption.classList.add('active');
    chatTitleText.textContent = '# general';
    input.placeholder = 'Message #general';
  } else if(chatId === 'questions') {
    questionsChatOption.classList.add('active');
    chatTitleText.textContent = '# questions';
    input.placeholder = 'Message #questions';
  } else if(chatId === 'help') {
    helpChatOption.classList.add('active');
    chatTitleText.textContent = '# help';
    input.placeholder = 'Message #help';
  } else {
    const chatOption = document.querySelector(`.chat-dropdown-item[data-chat="${chatId}"]`);
    if(chatOption) chatOption.classList.add('active');
  }

  let refPath = '';
  if (chatId === 'main') {
    refPath = 'chat/messages';
  } else if (chatId === 'questions') {
    refPath = 'chat/questions';
  } else if (chatId === 'help') {
    refPath = 'chat/help';
  } else {
    db.ref('private_chats/' + chatId).once('value').then(snap => {
      const chatData = snap.val();
      if (!chatData) {
        showNotice('Chat not found.');
        loadChat('main');
        return;
      }
      const displayName = chatData.members.filter(m => m !== username).join(', ') || 'Private Chat';
      chatTitleText.textContent = displayName;
      input.placeholder = 'Message ' + displayName;
    });
    refPath = `private_chats/${chatId}/messages`;
  }

  const chatRef = db.ref(refPath).orderByChild('timestamp').limitToLast(100);
  chatListeners[refPath] = chatRef.on('child_added', snap => {
    const m = snap.val();
    const el = renderMessageObj(m, snap.key, chatId);
    scroller.appendChild(el);
    scroller.scrollTop = scroller.scrollHeight;
  });
  
  chatRef.on('child_removed', snap => {
    const id = snap.key;
    const el = document.getElementById('m_' + id);
    if(el) el.remove();
  });
}

mainChatLink.addEventListener('click', (e) => {
  e.preventDefault();
  loadChat('main');
});

/* ================== PRIVATE CHAT MANAGEMENT ================== */
let userChats = {};
db.ref('users/' + username + '/private_chats').on('value', snap => {
  const newChats = snap.val() || {};
  const previousChatIds = Object.keys(userChats);
  const newChatIds = Object.keys(newChats).filter(id => !previousChatIds.includes(id));

  if(newChatIds.length > 0){
    newChatIds.forEach(id => {
      showNotice(`You've been added to a new chat!`);
    });
  }

  userChats = newChats;
  renderPrivateChatsDropdown();
  if (activeChatId !== 'main' && activeChatId !== 'questions' && activeChatId !== 'help' && !userChats[activeChatId]) {
    loadChat('main');
  }
});

if (canModerate(myRole)) {
  db.ref('private_chats').on('value', snap => {
    const allChats = snap.val() || {};
    renderModPrivateChats(allChats);
  });
}

function renderPrivateChatsDropdown() {
  privateChatOptions.innerHTML = '';
  
  const entries = Object.entries(userChats);
  if (entries.length === 0) {
    privateChatsSection.style.display = 'none';
    return;
  }
  
  privateChatsSection.style.display = 'block';
  
  entries.forEach(([id, members]) => {
    const el = document.createElement('div');
    el.className = 'chat-dropdown-item';
    el.dataset.chat = id;
    if(id === activeChatId) el.classList.add('active');
    
    const displayName = members.filter(m => m !== username).join(', ') || 'Private Chat';
    
    el.innerHTML = `
      <div class="chat-icon">
        <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
      </div>
      <div class="chat-info">
        <h5>${displayName}</h5>
        <span>Private Chat</span>
      </div>
    `;
    el.onclick = () => {
      loadChat(id);
      chatDropdown.classList.remove('visible');
      chatSelectorBtn.classList.remove('open');
    };
    privateChatOptions.appendChild(el);
  });
}

function renderModPrivateChats(chats) {
  modPrivateChatsList.innerHTML = '';
  const entries = Object.entries(chats);
  if (entries.length === 0) {
    modPrivateChatsList.innerHTML = '<div class="small muted">No private chats.</div>';
    return;
  }
  entries.forEach(([id, data]) => {
    const el = document.createElement('div');
    el.className = 'mod-chat-item';
    el.innerHTML = `<div><strong>${data.members.join(', ')}</strong><br><span class="small muted">Last: ${new Date(data.lastMessageTimestamp||0).toLocaleString()}</span></div>`;
    const actions = document.createElement('div');
    actions.style.display = 'flex';
    actions.style.gap = '6px';
    const viewBtn = document.createElement('button');
    viewBtn.className = 'btn';
    viewBtn.textContent = 'View';
    viewBtn.onclick = () => {
      loadChat(id);
    };
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'btn danger';
    deleteBtn.textContent = 'Delete';
    deleteBtn.onclick = () => {
      const ok = prompt('Delete this chat? Type YES to confirm.');
      if(ok === 'YES'){
        db.ref('private_chats/' + id).remove();
        data.members.forEach(member => {
          db.ref('users/' + member + '/private_chats/' + id).remove();
        });
        if(activeChatId === id) {
          loadChat('main');
        }
      }
    };
    actions.appendChild(viewBtn);
    actions.appendChild(deleteBtn);
    el.appendChild(actions);
    modPrivateChatsList.appendChild(el);
  });
}

/* ================== CREATE CHAT DROPDOWN ================== */
let selectedUsers = [];

cancelCreateChatBtn.addEventListener('click', () => {
  createChatDropdown.classList.remove('visible');
});

confirmCreateChatBtn.addEventListener('click', async () => {
  if (selectedUsers.length === 0) {
    showNotice('Select at least one user.');
    return;
  }
  
  if (selectedUsers.length > 9) {
    showNotice('Max 9 users.');
    return;
  }
  
  const members = [...new Set([username.toLowerCase(), ...selectedUsers.map(u => u.toLowerCase())])].sort();
  
  const existingChatSnap = await db.ref('private_chats').orderByChild('members_sorted').equalTo(members.join(',')).once('value');
  if (existingChatSnap.exists()){
    const chatId = Object.keys(existingChatSnap.val())[0];
    loadChat(chatId);
    createChatDropdown.classList.remove('visible');
    showNotice('Chat already exists.');
    return;
  }
  
  const newChatId = db.ref('private_chats').push().key;
  const chatData = {
    members: members,
    members_sorted: members.join(','),
    createdAt: Date.now(),
    lastMessageTimestamp: Date.now()
  };
  
  const updates = {};
  updates[`private_chats/${newChatId}`] = chatData;
  members.forEach(m => {
    updates[`users/${m}/private_chats/${newChatId}`] = members;
  });
  
  await db.ref().update(updates);
  
  loadChat(newChatId);
  createChatDropdown.classList.remove('visible');
  showNotice('Chat created!');
});

userSearch.addEventListener('input', () => {
  renderUserListForDropdown(userSearch.value);
});

function renderUserListForDropdown(searchTerm = '') {
  userListEl.innerHTML = '';
  const filteredUsers = allUsers.filter(u => u.toLowerCase() !== username.toLowerCase() && u.toLowerCase().includes(searchTerm.toLowerCase()));
  
  if(filteredUsers.length === 0){
    userListEl.innerHTML = '<div class="small muted" style="padding:12px">No users found.</div>';
    return;
  }
  
  filteredUsers.forEach(user => {
    const el = document.createElement('div');
    el.className = 'user-item';
    el.textContent = user;
    if (selectedUsers.includes(user)) {
      el.classList.add('selected');
    }
    
    el.onclick = () => {
      const index = selectedUsers.indexOf(user);
      if (index > -1) {
        selectedUsers.splice(index, 1);
        el.classList.remove('selected');
      } else {
        if (selectedUsers.length < 9) {
          selectedUsers.push(user);
          el.classList.add('selected');
        } else {
          showNotice('Max 9 users.');
        }
      }
    };
    userListEl.appendChild(el);
  });
}

db.ref('chat/messages').on('child_removed', snap => {
  const id = snap.key;
  const el = document.getElementById('m_' + id);
  if(el) el.remove();
});

let pinnedId = null;
db.ref('moderation/pinned').on('value', async snap=>{
  pinnedId = snap.val();
  if(!pinnedId) { pinnedSlot.style.display = 'none'; return; }
  const pinnedMsg = (await db.ref('chat/messages/' + pinnedId).once('value')).val();
  if(!pinnedMsg) { pinnedSlot.style.display = 'none'; return; }
  pinnedBox.innerHTML = '';
  pinnedBox.appendChild(renderMessageObj(pinnedMsg, pinnedId));
  pinnedSlot.style.display = 'block';
});

let isPaused = false;
db.ref('moderation/paused').on('value', snap=>{
  isPaused = snap.val();
  const isPublicChannel = activeChatId === 'main' || activeChatId === 'questions' || activeChatId === 'help';
  input.placeholder = isPaused && isPublicChannel ? 'Chat is paused' : getPlaceholderForChat(activeChatId);
  sendBtn.disabled = isPaused && isPublicChannel;
  input.disabled = isPaused && isPublicChannel;
  fileInput.disabled = isPaused && isPublicChannel;
});

function getPlaceholderForChat(chatId) {
  if(chatId === 'main') return 'Message #general';
  if(chatId === 'questions') return 'Message #questions';
  if(chatId === 'help') return 'Message #help';
  return 'Message...';
}

/* ================== LOCAL BOT MESSAGE (only visible to current user) ================== */
function showLocalBotMessage(text) {
  const localId = 'local_' + Date.now();
  const botMsg = {
    user: 'ModBot',
    text: text,
    role: 'Head Dev',
    timestamp: Date.now()
  };
  const el = renderMessageObj(botMsg, localId, activeChatId, true);
  scroller.appendChild(el);
  scroller.scrollTop = scroller.scrollHeight;
}

/* ================== SEND MESSAGE ================== */
sendBtn.addEventListener('click', async ()=>{
  const isPublicChannel = activeChatId === 'main' || activeChatId === 'questions' || activeChatId === 'help';
  if(isPaused && isPublicChannel){ showNotice('Chat is paused.'); return; }
  let text = input.value.trim();
  if(!text && !fileInput.files.length) return;
  
  if(checkClientSpam()){ showNotice('Slow down!'); return; }
  if(containsProfanity(text)){ showNotice('Message contains profanity.'); recordOffense(username); return; }
  if(await isBanned(username)){ showNotice('You are banned.'); return; }
  if(await isTimedOut(username)){ showNotice('You are timed out.'); return; }
  
  recordClientSend();
  
  const parts = text.split(/\s+/);
  const cmd = parts[0].toLowerCase();

  if(cmd === '!game' && isPublicChannel){
    await db.ref('moderation/gameRequests').push({ user: username, timestamp: Date.now() });
    input.value = '';
    showNotice('Game request sent.');
    return;
  }

  if(cmd === '!mod' && isPublicChannel){
    const message = parts.slice(1).join(' ').trim();
    if(!message) {
      // Show placeholder hint to user
      showLocalBotMessage('Usage: !mod [Type message here]\nExample: !mod Someone is spamming in chat');
      input.value = '';
      return;
    }
    await db.ref('moderation/modNotifications').push({ user: username, message: message, timestamp: Date.now() });
    input.value = '';
    // Show confirmation only to the user who sent it
    showLocalBotMessage('✓ Your message has been sent to the moderators.');
    return;
  }

  const botResponsesRef = db.ref('moderation/customBotResponses');
  const snap = await botResponsesRef.once('value');
  const responses = snap.val() || {};
  const botResponse = Object.values(responses).find(res => res.command.toLowerCase() === cmd);
  if(botResponse && isPublicChannel){
    // Show bot response only to the user who typed the command
    showLocalBotMessage(botResponse.text);
    input.value = '';
    return;
  }

  // Determine which chat path to use
  let refPath = '';
  if (activeChatId === 'main') {
    refPath = 'chat/messages';
  } else if (activeChatId === 'questions') {
    refPath = 'chat/questions';
  } else if (activeChatId === 'help') {
    refPath = 'chat/help';
  } else {
    refPath = `private_chats/${activeChatId}/messages`;
  }

  if(isPublicChannel){
    try {
      if(fileInput.files.length){
        const file = fileInput.files[0];
        const upload = await uploadAttachment(file);
        if(upload){
          await db.ref(refPath).push({
            user: username,
            text: text,
            role: myRole,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            attachmentId: upload.id
          });
          input.value = '';
          fileInput.value = '';
        }
      } else if(text){
        await db.ref(refPath).push({
          user: username,
          text: text,
          role: myRole,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        input.value = '';
      }
    } catch(e) {
      showNotice('Failed: ' + e.message);
    }
  } else {
    try {
      const chatRef = db.ref('private_chats/' + activeChatId);
      const messageRef = chatRef.child('messages').push();
      await messageRef.set({
        user: username,
        text: text,
        role: myRole,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        id: messageRef.key
      });
      await chatRef.update({ lastMessageTimestamp: Date.now() });
      input.value = '';
    } catch(e) {
      showNotice('Failed: ' + e.message);
    }
  }
});

input.addEventListener('keyup', (e)=>{ if(e.key==='Enter') sendBtn.click(); });

/* ================== MODERATION PANEL ================== */
function renderUserList(container, data, actionBtnText, onActionClick){
  container.innerHTML = '';
  const entries = Object.entries(data);
  if(!entries.length){ container.innerHTML = '<div class="small muted">None.</div>'; return; }
  entries.forEach(([name, val])=>{
    const el = document.createElement('div');
    el.innerHTML = `<span>${name}</span>`;
    const actions = document.createElement('div');
    const btn = document.createElement('button');
    btn.className = 'btn danger';
    btn.textContent = actionBtnText;
    btn.onclick = () => onActionClick(name);
    actions.appendChild(btn);
    el.appendChild(actions);
    container.appendChild(el);
  });
}

db.ref('bans').on('value', s=> renderUserList(bannedListEl, s.val()||{}, 'Unban', (name) => db.ref('bans/'+name).remove()));

db.ref('timeouts').on('value', s=>{
  timeoutListEl.innerHTML = '';
  const entries = Object.entries(s.val()||{});
  if(!entries.length){ timeoutListEl.innerHTML = '<div class="small muted">None.</div>'; return; }
  entries.forEach(([name, until])=>{
    const el = document.createElement('div');
    const timeLeft = Math.round((until - Date.now())/1000);
    el.innerHTML = `<span>${name}</span> <span class="small muted">${timeLeft}s</span>`;
    const actions = document.createElement('div');
    const del = document.createElement('button'); del.className='btn danger'; del.textContent='Remove';
    del.onclick = ()=> db.ref('timeouts/'+name).remove();
    actions.appendChild(del);
    el.appendChild(actions);
    timeoutListEl.appendChild(el);
  });
});

db.ref('offenses').on('value', s=>{
  offensesListEl.innerHTML = '';
  const entries = Object.entries(s.val()||{});
  if(!entries.length){ offensesListEl.innerHTML = '<div class="small muted">None.</div>'; return; }
  entries.forEach(([name, data])=>{
    const el = document.createElement('div');
    el.innerHTML = `<span>${name}</span> <span class="small muted">${Object.values(data.times||{}).length} offense(s)</span>`;
    offensesListEl.appendChild(el);
  });
});

function banPrompt(user){
  if(!canModerate(myRole)) return;
  const dur = prompt('Ban ' + user + ' for how many minutes? (or "perm")');
  if(dur === null) return;
  if(dur.toLowerCase() === 'perm'){ db.ref('bans/'+user.toLowerCase()).set('perm'); showNotice(user + ' permanently banned.'); return; }
  const mins = parseInt(dur, 10);
  if(mins > 0){
    const until = Date.now() + mins * 60_000;
    db.ref('bans/'+user.toLowerCase()).set(until);
    showNotice(user + ' banned for ' + mins + ' min.');
  }
}

togglePauseBtn.addEventListener('click', async()=>{
  if(!canModerate(myRole)) return;
  await setPaused(!isPaused);
  showNotice('Chat ' + (isPaused ? 'paused' : 'unpaused'));
});

createPollBtn.addEventListener('click', async ()=>{
  if(!canModerate(myRole)) return;
  const q = pollQEl.value.trim();
  const opts = pollOptionsEl.value.split(',').map(s=>s.trim()).filter(s=>s);
  if(!q || opts.length < 2){ showNotice('Need question and 2+ options.'); return; }
  await createPoll(q, opts);
  pollQEl.value = '';
  pollOptionsEl.value = '';
  showNotice('Poll created.');
});

db.ref('moderation/gameRequests').on('value', snap => {
  const reqs = snap.val() || {};
  gameRequestsList.innerHTML = '';
  const entries = Object.entries(reqs);
  if (!entries.length) {
    gameRequestsList.innerHTML = '<div class="small muted">No requests.</div>';
    return;
  }
  entries.forEach(([k, req]) => {
    const row = document.createElement('div');
    row.className = 'game-req-item';
    const content = document.createElement('div');
    content.innerHTML = `<span>${req.user}</span> <span class="small muted">${new Date(req.timestamp).toLocaleTimeString()}</span>`;
    const actions = document.createElement('div');
    const dismissBtn = document.createElement('button');
    dismissBtn.className = 'btn danger';
    dismissBtn.textContent = 'Dismiss';
    dismissBtn.onclick = () => db.ref('moderation/gameRequests/' + k).remove();
    actions.appendChild(dismissBtn);
    row.appendChild(content);
    row.appendChild(actions);
    gameRequestsList.appendChild(row);
  });
});

db.ref('moderation/modNotifications').on('value', snap => {
  const notifs = snap.val() || {};
  modNotificationsList.innerHTML = '';
  const entries = Object.entries(notifs);
  if (!entries.length) {
    modNotificationsList.innerHTML = '<div class="small muted">No notifications.</div>';
    return;
  }
  entries.forEach(([k, notif]) => {
    const row = document.createElement('div');
    row.className = 'mod-notif-item';
    const content = document.createElement('div');
    content.innerHTML = `<strong>${notif.user}</strong> <span class="small muted">${new Date(notif.timestamp).toLocaleTimeString()}</span>`;
    const msg = document.createElement('div');
    msg.textContent = notif.message;
    msg.style.marginTop = '4px';
    const actions = document.createElement('div');
    actions.style.marginTop = '6px';
    const dismissBtn = document.createElement('button');
    dismissBtn.className = 'btn danger';
    dismissBtn.textContent = 'Dismiss';
    dismissBtn.onclick = () => db.ref('moderation/modNotifications/' + k).remove();
    actions.appendChild(dismissBtn);
    row.appendChild(content);
    row.appendChild(msg);
    row.appendChild(actions);
    modNotificationsList.appendChild(row);
  });
});

modChatSendBtn.addEventListener('click', async () => {
  if (!canModerate(myRole)) { showNotice('Mod access required'); return; }
  const text = modChatInput.value.trim();
  if (!text) return;
  await db.ref('moderation/modChat').push({
    user: username,
    text: text,
    timestamp: firebase.database.ServerValue.TIMESTAMP
  });
  modChatInput.value = '';
});

db.ref('moderation/modChat').orderByChild('timestamp').on('child_added', snap => {
  const m = snap.val();
  const el = document.createElement('div');
  el.innerHTML = `<div><strong>${m.user}</strong> <span class="small muted">${fmtTime(m.timestamp)}</span></div><div style="margin-top:4px">${m.text}</div>`;
  el.style.padding = '8px';
  el.style.borderBottom = '1px solid var(--border)';
  modChatList.appendChild(el);
  modChatList.scrollTop = modChatList.scrollHeight;
});

db.ref('moderation/customBotResponses').on('value', snap => {
  const responses = snap.val() || {};
  botResponsesList.innerHTML = '';
  const entries = Object.entries(responses);
  if (!entries.length) {
    botResponsesList.innerHTML = '<div class="small muted">No bot responses.</div>';
    return;
  }
  entries.forEach(([k, response]) => {
    const row = document.createElement('div');
    row.className = 'badword-list-item';
    const lbl = document.createElement('div');
    lbl.innerHTML = `<strong>${response.command}</strong>: ${response.text}`;
    const actions = document.createElement('div');
    const del = document.createElement('button');
    del.className = 'btn danger';
    del.textContent = 'Delete';
    del.onclick = () => { db.ref('moderation/customBotResponses/' + k).remove(); };
    actions.appendChild(del);
    row.appendChild(lbl);
    row.appendChild(actions);
    botResponsesList.appendChild(row);
  });
});

botResponseAddBtn.addEventListener('click', async () => {
  if (!canModerate(myRole)) { showNotice('Mod access required'); return; }
  const command = (botCommandInput.value || '').trim().toLowerCase();
  const response = (botResponseInput.value || '').trim();
  if (!command.startsWith('!') || !response) {
    showNotice('Command must start with "!" and response required.');
    return;
  }
  await db.ref('moderation/customBotResponses').push({ command, text: response });
  botCommandInput.value = '';
  botResponseInput.value = '';
  showNotice('Bot command added.');
});

/* ================== INIT ================== */
loadAutoBan();
loadChat('main');
updateModPanelVisibility();
</script>
<script src="guard.js"></script>
    <script src="custom-cursor.js"></script>
    <script src="rightclick.js"></script>
    <script src="panic-key.js"></script>
    <script src="idle-dvd.js"></script>
    <script src="timeTracker.js"></script>
</body>
</html>