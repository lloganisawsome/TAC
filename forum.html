<!doctype html>
<html lang="en">
<head>
    <link rel="stylesheet" href="rightclick.css">
    <link rel="stylesheet" href="custom-cursor.css">
<meta charset="utf-8" />
<title>TAC Forum</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root {
    --bg: #0a0a0b;
    --panel: #111113;
    --panel-hover: #1a1a1c;
    --accent: #22c55e;
    --accent-dim: rgba(34, 197, 94, 0.1);
    --muted: #71717a;
    --border: rgba(255,255,255,0.06);
    --danger: #ef4444;
    --danger-dim: rgba(239, 68, 68, 0.1);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
    min-height: 100%;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: #fff;
    font-size: 14px;
}

::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

/* Sidebar */
.sidebar {
    position: fixed;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    width: 70px;
    background: var(--panel);
    border: 1px solid var(--accent);
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px 0;
    transition: all 0.3s ease;
    z-index: 1000;
    box-shadow: 0 0 20px var(--accent-dim);
}

.sidebar.collapsed {
    width: 0;
    padding: 0;
    border: none;
    margin-left: -10px;
    overflow: hidden;
}

.logo-container {
    margin-bottom: 16px;
    padding: 4px;
    transition: opacity 0.3s;
}

.sidebar.collapsed .logo-container {
    opacity: 0;
}

.logo {
    width: 50px;
    height: 50px;
    border-radius: 8px;
}

.nav-items {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    width: 100%;
    padding: 0 8px;
    transition: opacity 0.3s;
}

.sidebar.collapsed .nav-items {
    opacity: 0;
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 54px;
    height: 54px;
    border-radius: 10px;
    text-decoration: none;
    color: var(--accent);
    transition: all 0.2s ease;
    cursor: pointer;
}

.nav-item:hover {
    background: var(--accent-dim);
}

.nav-item.active {
    background: var(--accent-dim);
    border: 1px solid var(--accent);
}

.nav-item svg {
    width: 24px;
    height: 24px;
    margin-bottom: 2px;
}

.nav-item span {
    font-size: 9px;
    font-weight: 500;
}

.toggle-btn {
    position: fixed;
    left: 90px;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 36px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 1001;
    color: #fff;
}

.toggle-btn:hover {
    background: var(--panel-hover);
    border-color: var(--accent);
}

.toggle-btn svg {
    width: 14px;
    height: 14px;
    color: #fff;
    transition: transform 0.3s ease;
}

.toggle-btn.collapsed {
    left: 10px;
}

.toggle-btn.collapsed svg {
    transform: rotate(180deg);
}

/* Main Content */
.main-content {
    margin-left: 100px;
    padding: 24px;
    transition: margin-left 0.3s ease;
}

.main-content.expanded {
    margin-left: 24px;
}

/* Header */
header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 12px;
    margin-bottom: 20px;
}

header .title-section {
    display: flex;
    align-items: center;
    gap: 12px;
}

header h1 {
    font-size: 20px;
    font-weight: 600;
    color: var(--accent);
}

header .subforum-label {
    color: var(--muted);
    font-size: 14px;
}

header .user-section {
    display: flex;
    align-items: center;
    gap: 12px;
}

header .welcome-text {
    color: var(--muted);
    font-size: 13px;
}

/* Buttons */
.btn {
    background: var(--panel);
    border: 1px solid var(--border);
    padding: 8px 14px;
    border-radius: 8px;
    cursor: pointer;
    color: #fff;
    font-size: 13px;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.btn:hover {
    background: var(--panel-hover);
    border-color: var(--accent);
}

.btn-primary {
    background: var(--accent-dim);
    border-color: var(--accent);
    color: var(--accent);
}

.btn-primary:hover {
    background: var(--accent);
    color: #000;
}

.btn-danger {
    background: var(--danger-dim);
    border-color: var(--danger);
    color: var(--danger);
}

.btn-danger:hover {
    background: var(--danger);
    color: #fff;
}

/* Layout */
.content-grid {
    display: grid;
    grid-template-columns: 280px 1fr 300px;
    gap: 20px;
}

@media (max-width: 1200px) {
    .content-grid {
        grid-template-columns: 1fr;
    }
    .sidebar-left, .sidebar-right {
        display: none;
    }
}

/* Panels */
.panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
}

.panel-title {
    font-size: 15px;
    font-weight: 600;
    color: #fff;
}

.panel-subtitle {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
}

/* Subforums */
.subforum-item {
    padding: 12px;
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.subforum-item:hover {
    background: var(--panel-hover);
    border-color: var(--accent);
}

.subforum-item .name {
    font-weight: 500;
    color: #fff;
    margin-bottom: 4px;
}

.subforum-item .desc {
    font-size: 12px;
    color: var(--muted);
}

.subforum-item .mod-badge {
    display: inline-block;
    background: var(--accent-dim);
    color: var(--accent);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    margin-top: 6px;
}

/* Posts */
.post-card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.2s ease;
}

.post-card:hover {
    border-color: rgba(255,255,255,0.1);
}

.post-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.post-title {
    font-size: 16px;
    font-weight: 600;
    color: #fff;
    margin-bottom: 4px;
}

.post-meta {
    font-size: 12px;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 8px;
}

.post-content {
    font-size: 14px;
    line-height: 1.6;
    color: rgba(255,255,255,0.85);
    margin-bottom: 12px;
    white-space: pre-wrap;
}

.post-footer {
    display: flex;
    align-items: center;
    gap: 8px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
}

/* Pills/Tags */
.pill {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    background: var(--accent-dim);
    border: 1px solid var(--accent);
    border-radius: 20px;
    font-size: 11px;
    font-weight: 500;
    color: var(--accent);
}

.pill.warning {
    background: rgba(234, 179, 8, 0.1);
    border-color: #eab308;
    color: #eab308;
}

.pill.danger {
    background: var(--danger-dim);
    border-color: var(--danger);
    color: var(--danger);
}

/* Voting */
.vote-btn {
    background: transparent;
    border: 1px solid var(--border);
    width: 32px;
    height: 32px;
    border-radius: 6px;
    cursor: pointer;
    color: var(--muted);
    font-size: 14px;
    transition: all 0.2s ease;
}

.vote-btn:hover {
    background: var(--accent-dim);
    border-color: var(--accent);
    color: var(--accent);
}

.score {
    font-weight: 600;
    color: var(--accent);
    min-width: 30px;
    text-align: center;
}

/* Comments */
.comments-section {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
}

.comment {
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 8px;
    margin-left: var(--depth, 0px);
}

.comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.comment-author {
    font-weight: 500;
    color: var(--accent);
    font-size: 13px;
}

.comment-time {
    font-size: 11px;
    color: var(--muted);
}

.comment-content {
    font-size: 13px;
    line-height: 1.5;
    color: rgba(255,255,255,0.8);
}

/* Admin Panel */
.admin-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
}

.admin-actions .btn {
    font-size: 11px;
    padding: 6px 10px;
}

/* Forms */
input, select, textarea {
    width: 100%;
    padding: 10px 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: #fff;
    font-size: 14px;
    margin-bottom: 12px;
    transition: border-color 0.2s ease;
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--accent);
}

label {
    display: block;
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 6px;
    font-weight: 500;
}

/* Modal */
.overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    z-index: 1100;
    display: none;
}

.overlay.show {
    display: block;
}

.modal {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    z-index: 1200;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    display: none;
}

.modal.show {
    display: block;
}

.modal.large {
    max-width: 900px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
}

.modal-title {
    font-size: 18px;
    font-weight: 600;
}

.modal-close {
    background: transparent;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 24px;
    line-height: 1;
}

.modal-close:hover {
    color: #fff;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 20px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
}

/* Admin Modal Tabs */
.admin-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 20px;
    background: var(--bg);
    padding: 4px;
    border-radius: 8px;
}

.admin-tab {
    flex: 1;
    padding: 10px 16px;
    background: transparent;
    border: none;
    border-radius: 6px;
    color: var(--muted);
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.admin-tab:hover {
    color: #fff;
}

.admin-tab.active {
    background: var(--panel);
    color: var(--accent);
}

.admin-tab-content {
    display: none;
}

.admin-tab-content.active {
    display: block;
}

/* Admin Stats */
.admin-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 20px;
}

.stat-card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
    text-align: center;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 4px;
}

.stat-label {
    font-size: 11px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* User Lookup Result */
.lookup-result {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
    margin-top: 12px;
}

.lookup-user {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.lookup-avatar {
    width: 48px;
    height: 48px;
    background: var(--accent-dim);
    border: 2px solid var(--accent);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: 700;
    color: var(--accent);
}

.lookup-info h4 {
    font-size: 16px;
    margin-bottom: 4px;
}

.lookup-info p {
    font-size: 12px;
    color: var(--muted);
}

.lookup-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 12px;
}

.lookup-stat {
    background: var(--panel);
    padding: 10px;
    border-radius: 8px;
    text-align: center;
}

.lookup-stat-value {
    font-size: 18px;
    font-weight: 600;
    color: #fff;
}

.lookup-stat-label {
    font-size: 10px;
    color: var(--muted);
}

.lookup-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

/* Reports & Audit Lists */
.list-item {
    padding: 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 8px;
}

.list-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}

.list-item-type {
    font-size: 11px;
    font-weight: 600;
    color: var(--accent);
    text-transform: uppercase;
}

.list-item-time {
    font-size: 11px;
    color: var(--muted);
}

.list-item-content {
    font-size: 13px;
    color: rgba(255,255,255,0.8);
}

.list-container {
    max-height: 300px;
    overflow-y: auto;
}

/* Blacklist */
.blacklist-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.blacklist-tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: var(--danger-dim);
    border: 1px solid var(--danger);
    border-radius: 6px;
    font-size: 12px;
    color: var(--danger);
}

/* Key Icon */
#keyIcon {
    position: fixed;
    right: 20px;
    bottom: 20px;
    width: 56px;
    height: 56px;
    border-radius: 14px;
    background: var(--panel);
    border: 1px solid var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1000;
    transition: all 0.2s ease;
    box-shadow: 0 4px 20px var(--accent-dim);
}

#keyIcon:hover {
    background: var(--accent);
    transform: scale(1.05);
}

#keyIcon:hover span {
    filter: brightness(0);
}

#keyIcon span {
    font-size: 24px;
}

/* Live Indicator */
.live-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    background: var(--accent-dim);
    border: 1px solid var(--accent);
    border-radius: 20px;
    font-size: 11px;
    color: var(--accent);
}

.live-dot {
    width: 6px;
    height: 6px;
    background: var(--accent);
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}

/* Quick Actions */
.quick-actions {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
}

/* Utilities */
.hidden { display: none !important; }
.muted { color: var(--muted); }
.small { font-size: 12px; }
.text-center { text-align: center; }
.mt-2 { margin-top: 8px; }
.mt-4 { margin-top: 16px; }
.mb-2 { margin-bottom: 8px; }
.flex { display: flex; gap: 8px; align-items: center; }
.flex-wrap { flex-wrap: wrap; }

/* Mobile */
@media (max-width: 768px) {
    .main-content {
        margin-left: 24px;
    }
    
    .sidebar {
        display: none;
    }
    
    .toggle-btn {
        display: none;
    }
    
    .admin-stats {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <div class="logo-container">
        <img src="taclogos/green.png" alt="Logo" class="logo" id="logo">
    </div>

    <nav class="nav-items">
        <a href="index.html" class="nav-item">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
            </svg>
            <span>Home</span>
        </a>

        <a href="forum.html" class="nav-item active">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z"/>
            </svg>
            <span>Forum</span>
        </a>

        <a href="chat.html" class="nav-item">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
            </svg>
            <span>Chat</span>
        </a>

        <a href="apps.html" class="nav-item">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z"/>
            </svg>
            <span>Apps</span>
        </a>
    </nav>
</aside>

<button class="toggle-btn" id="toggleBtn">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"/>
    </svg>
</button>

<!-- Main Content -->
<main class="main-content" id="mainContent">
    <header>
        <div class="title-section">
            <h1>TAC Forum</h1>
            <span id="currentSubforumLabel" class="subforum-label"></span>
        </div>
        <div class="user-section">
            <span id="welcomeText" class="welcome-text">Not signed in</span>
            <button id="openLoginBtn" class="btn btn-primary">Login</button>
            <button id="openSignupBtn" class="btn">Signup</button>
            <button id="logoutBtn" class="btn hidden">Logout</button>
        </div>
    </header>

    <div class="content-grid">
        <!-- Left Sidebar -->
        <div class="sidebar-left">
            <div class="panel">
                <div class="panel-header">
                    <div>
                        <h3 class="panel-title">Quick Actions</h3>
                    </div>
                </div>
                <div class="quick-actions">
                    <button id="createSubBtn" class="btn btn-primary" style="flex:1">+ Subforum</button>
                    <button id="createPostBtn" class="btn btn-primary" style="flex:1">+ Post</button>
                </div>
                <p class="small muted">Welcome to TAC Forums! Create posts, join discussions, and connect with the community.</p>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <div>
                        <h3 class="panel-title">Subforums</h3>
                        <p class="panel-subtitle">Browse communities</p>
                    </div>
                </div>
                <div id="subforumItems"></div>
            </div>

            <div id="userPanel" class="panel hidden">
                <div class="panel-header">
                    <h3 class="panel-title">Your Profile</h3>
                </div>
                <div id="userMeta"></div>
                <div id="userActions" class="mt-2"></div>
            </div>
        </div>

        <!-- Main Content Area -->
        <section>
            <div class="panel">
                <div class="panel-header">
                    <div>
                        <h3 class="panel-title">Posts</h3>
                        <p class="panel-subtitle">Latest discussions</p>
                    </div>
                    <div class="flex">
                        <select id="sortSelect" style="width:auto;margin:0">
                            <option value="new">Newest</option>
                            <option value="top">Top</option>
                            <option value="pinned">Pinned</option>
                        </select>
                        <label class="flex small muted" style="margin:0;cursor:pointer">
                            <input id="showPinnedOnly" type="checkbox" style="width:auto;margin:0"/>
                            Pinned only
                        </label>
                    </div>
                </div>
                <div id="postsFeed"></div>
            </div>
        </section>

        <!-- Right Sidebar -->
        <div class="sidebar-right">
            <div id="modPanel" class="panel hidden">
                <div class="panel-header">
                    <div>
                        <h3 class="panel-title">Mod Tools</h3>
                    </div>
                    <div class="live-indicator">
                        <span class="live-dot"></span>
                        Live
                    </div>
                </div>
                <div id="modQueue"></div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <div>
                        <h3 class="panel-title">Global Admins</h3>
                    </div>
                </div>
                <div id="adminList" class="small muted"></div>
                <p class="small muted mt-2">Only <strong>logan</strong> can manage global admins.</p>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <div>
                        <h3 class="panel-title">Blacklist</h3>
                    </div>
                </div>
                <div id="blacklistView" class="blacklist-tags"></div>
            </div>
        </div>
    </div>
</main>

<!-- Key icon -->
<div id="keyIcon" title="Admin / Mod Panel"><span>ðŸ”‘</span></div>

<!-- Overlay -->
<div id="overlay" class="overlay"></div>

<!-- Login Modal -->
<div id="loginModal" class="modal">
    <div class="modal-header">
        <h3 class="modal-title">Login</h3>
        <button class="modal-close" id="closeLoginBtn">&times;</button>
    </div>
    <label>Username</label>
    <input id="loginUsername" placeholder="Enter your username" />
    <label>Password</label>
    <input id="loginPassword" type="password" placeholder="Enter your password" />
    <div class="modal-footer">
        <button id="doLoginBtn" class="btn btn-primary">Login</button>
    </div>
</div>

<!-- Signup Modal -->
<div id="signupModal" class="modal">
    <div class="modal-header">
        <h3 class="modal-title">Create Account</h3>
        <button class="modal-close" id="closeSignupBtn">&times;</button>
    </div>
    <label>Username</label>
    <input id="signupUsername" placeholder="Choose a username" />
    <label>Password</label>
    <input id="signupPassword" type="password" placeholder="Choose a password" />
    <div class="modal-footer">
        <button id="doSignupBtn" class="btn btn-primary">Create Account</button>
    </div>
</div>

<!-- Create Subforum Modal -->
<div id="createSubModal" class="modal">
    <div class="modal-header">
        <h3 class="modal-title">Create Subforum</h3>
        <button class="modal-close" id="closeCreateSubBtn">&times;</button>
    </div>
    <label>ID (single word, no spaces)</label>
    <input id="newSubId" placeholder="e.g. tech" />
    <label>Display Name</label>
    <input id="newSubName" placeholder="e.g. Technology" />
    <label>Description</label>
    <input id="newSubDesc" placeholder="What's this subforum about?" />
    <div class="modal-footer">
        <button id="doCreateSubBtn" class="btn btn-primary">Create</button>
    </div>
</div>

<!-- Create Post Modal -->
<div id="createPostModal" class="modal">
    <div class="modal-header">
        <h3 class="modal-title">Create Post</h3>
        <button class="modal-close" id="closeCreatePostBtn">&times;</button>
    </div>
    <label>Subforum</label>
    <input id="postSubId" placeholder="e.g. tech" />
    <label>Type</label>
    <select id="postTypeSelect">
        <option value="text">Text</option>
        <option value="poll">Poll</option>
        <option value="announcement">Announcement</option>
    </select>
    <label>Title</label>
    <input id="postTitleInput" placeholder="Post title" />
    <label>Content</label>
    <textarea id="postContentInput" rows="6" placeholder="Write your post..."></textarea>
    <div id="pollBlock" class="hidden">
        <label>Poll Question</label>
        <input id="pollQuestion" placeholder="What do you want to ask?" />
        <label>Options (one per line)</label>
        <textarea id="pollOptions" rows="3" placeholder="Option 1&#10;Option 2&#10;Option 3"></textarea>
    </div>
    <div class="modal-footer">
        <button id="doCreatePostBtn" class="btn btn-primary">Post</button>
    </div>
</div>

<!-- Report Modal -->
<div id="reportModal" class="modal">
    <div class="modal-header">
        <h3 class="modal-title">Submit Report</h3>
        <button class="modal-close" id="closeReportBtn">&times;</button>
    </div>
    <label>Type (post/comment)</label>
    <input id="reportTypeInput" placeholder="post or comment" />
    <label>Target ID</label>
    <input id="reportTargetInput" placeholder="postId or postId/commentId" />
    <label>Reason</label>
    <textarea id="reportReasonInput" rows="3" placeholder="Why are you reporting this?"></textarea>
    <div class="modal-footer">
        <button id="doReportBtn" class="btn btn-primary">Submit Report</button>
    </div>
</div>

<!-- Admin Modal -->
<div id="adminModal" class="modal large">
    <div class="modal-header">
        <h3 class="modal-title">Admin Panel</h3>
        <button class="modal-close" id="closeAdminBtn">&times;</button>
    </div>

    <!-- Stats -->
    <div class="admin-stats">
        <div class="stat-card">
            <div class="stat-value" id="statUsers">0</div>
            <div class="stat-label">Users</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statPosts">0</div>
            <div class="stat-label">Posts</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statReports">0</div>
            <div class="stat-label">Reports</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statOffenses">0</div>
            <div class="stat-label">Offenses</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="admin-tabs">
        <button class="admin-tab active" data-tab="users">Users</button>
        <button class="admin-tab" data-tab="reports">Reports</button>
        <button class="admin-tab" data-tab="audit">Audit Log</button>
        <button class="admin-tab" data-tab="blacklist">Blacklist</button>
        <button class="admin-tab" data-tab="admins">Admins</button>
    </div>

    <!-- Users Tab -->
    <div class="admin-tab-content active" id="tab-users">
        <label>Username Lookup</label>
        <div class="flex">
            <input id="lookupUsername" placeholder="Enter username" style="margin:0;flex:1" />
            <button id="doLookupBtn" class="btn btn-primary">Lookup</button>
        </div>
        <div id="lookupResult"></div>
    </div>

    <!-- Reports Tab -->
    <div class="admin-tab-content" id="tab-reports">
        <input id="reportFilterInput" placeholder="Filter reports..." style="margin-bottom:12px" />
        <div id="adminReportsList" class="list-container"></div>
    </div>

    <!-- Audit Tab -->
    <div class="admin-tab-content" id="tab-audit">
        <div class="flex mb-2">
            <input id="auditFilterInput" placeholder="Filter audit log..." style="margin:0;flex:1" />
            <button id="exportAuditBtn" class="btn">Export JSON</button>
        </div>
        <div id="adminAuditList" class="list-container"></div>
    </div>

    <!-- Blacklist Tab -->
    <div class="admin-tab-content" id="tab-blacklist">
        <div class="flex mb-2">
            <input id="blackInput" placeholder="Word to add/remove" style="margin:0;flex:1" />
            <button id="addBlackBtn" class="btn btn-primary">Add</button>
            <button id="removeBlackBtn" class="btn btn-danger">Remove</button>
        </div>
        <div id="blackAdminView" class="blacklist-tags mt-4"></div>
    </div>

    <!-- Admins Tab -->
    <div class="admin-tab-content" id="tab-admins">
        <p class="small muted mb-2">Only <strong>logan</strong> can promote or demote global admins.</p>
        <div class="flex mb-2">
            <input id="adminTargetInput" placeholder="Username" style="margin:0;flex:1" />
            <button id="promoteAdminBtn" class="btn btn-primary">Promote</button>
            <button id="demoteAdminBtn" class="btn btn-danger">Demote</button>
        </div>
        <div class="mt-4">
            <label>Current Global Admins</label>
            <div id="adminListModal" class="blacklist-tags"></div>
        </div>
    </div>
</div>

<!-- Firebase + App -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, set, push, get, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBQslLAFRlIRJqsiJ2WWeTNslO067bzKYM",
  authDomain: "taclogin-ab38e.firebaseapp.com",
  databaseURL: "https://taclogin-ab38e-default-rtdb.firebaseio.com",
  projectId: "taclogin-ab38e",
  storageBucket: "taclogin-ab38e.firebaseapp.com",
  messagingSenderId: "937853298051",
  appId: "1:937853298051:web:119ccc7b5499514bd442b6"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const FORUM_ROOT = "forum";
const SESSION_KEY = "forumUserSession";

let CURRENT_USER = null;
let ALL_SUBFORUMS = {};
let ALL_POSTS = {};
let ALL_COMMENTS = {};
let BLACKLIST = [];
let ALL_REPORTS = {};
let ALL_AUDIT = {};
let ALL_ADMINS = {};
let ALL_OFFENSES = {};
let ALL_USERS = {};

// Theme Colors
const themeColors = {
    green: { primary: '#22c55e', dim: 'rgba(34, 197, 94, 0.1)', shadow: 'rgba(34, 197, 94, 0.15)' },
    blue: { primary: '#3b82f6', dim: 'rgba(59, 130, 246, 0.1)', shadow: 'rgba(59, 130, 246, 0.15)' },
    red: { primary: '#ef4444', dim: 'rgba(239, 68, 68, 0.1)', shadow: 'rgba(239, 68, 68, 0.15)' },
    cyan: { primary: '#06b6d4', dim: 'rgba(6, 182, 212, 0.1)', shadow: 'rgba(6, 182, 212, 0.15)' },
    pink: { primary: '#ec4899', dim: 'rgba(236, 72, 153, 0.1)', shadow: 'rgba(236, 72, 153, 0.15)' },
    purple: { primary: '#8b5cf6', dim: 'rgba(139, 92, 246, 0.1)', shadow: 'rgba(139, 92, 246, 0.15)' },
    yellow: { primary: '#eab308', dim: 'rgba(234, 179, 8, 0.1)', shadow: 'rgba(234, 179, 8, 0.15)' },
    orange: { primary: '#f97316', dim: 'rgba(249, 115, 22, 0.1)', shadow: 'rgba(249, 115, 22, 0.15)' },
    white: { primary: '#ffffff', dim: 'rgba(255, 255, 255, 0.1)', shadow: 'rgba(255, 255, 255, 0.15)' },
    whiteout: { primary: '#ffffff', dim: 'rgba(255, 255, 255, 0.05)', shadow: 'rgba(255, 255, 255, 0.1)' }
};

function applyTheme() {
    const theme = localStorage.getItem('theme') || 'green';
    const colors = themeColors[theme] || themeColors.green;

    document.documentElement.style.setProperty('--accent', colors.primary);
    document.documentElement.style.setProperty('--accent-dim', colors.dim);

    const logo = document.getElementById('logo');
    if (logo) logo.src = `taclogos/${theme}.png`;

    const sidebar = document.getElementById('sidebar');
    if (sidebar) sidebar.style.boxShadow = `0 0 20px ${colors.shadow}`;
    
    const keyIcon = document.getElementById('keyIcon');
    if (keyIcon) keyIcon.style.boxShadow = `0 4px 20px ${colors.shadow}`;
}

applyTheme();
window.addEventListener('storage', (e) => {
    if (e.key === 'theme') applyTheme();
});

// Sidebar Toggle
const sidebar = document.getElementById('sidebar');
const toggleBtn = document.getElementById('toggleBtn');
const mainContent = document.getElementById('mainContent');

toggleBtn.addEventListener('click', () => {
    sidebar.classList.toggle('collapsed');
    toggleBtn.classList.toggle('collapsed');
    mainContent.classList.toggle('expanded');
});

// UI refs
const openLoginBtn = document.getElementById('openLoginBtn');
const openSignupBtn = document.getElementById('openSignupBtn');
const logoutBtn = document.getElementById('logoutBtn');
const welcomeText = document.getElementById('welcomeText');
const subforumItems = document.getElementById('subforumItems');
const postsFeed = document.getElementById('postsFeed');
const createSubBtn = document.getElementById('createSubBtn');
const createPostBtn = document.getElementById('createPostBtn');
const modPanel = document.getElementById('modPanel');
const modQueue = document.getElementById('modQueue');
const adminList = document.getElementById('adminList');
const blacklistView = document.getElementById('blacklistView');

const overlay = document.getElementById('overlay');
const loginModal = document.getElementById('loginModal');
const signupModal = document.getElementById('signupModal');
const createSubModal = document.getElementById('createSubModal');
const createPostModal = document.getElementById('createPostModal');
const reportModal = document.getElementById('reportModal');
const adminModal = document.getElementById('adminModal');

const loginUsername = document.getElementById('loginUsername');
const loginPassword = document.getElementById('loginPassword');
const doLoginBtn = document.getElementById('doLoginBtn');
const closeLoginBtn = document.getElementById('closeLoginBtn');

const signupUsername = document.getElementById('signupUsername');
const signupPassword = document.getElementById('signupPassword');
const doSignupBtn = document.getElementById('doSignupBtn');
const closeSignupBtn = document.getElementById('closeSignupBtn');

const newSubId = document.getElementById('newSubId');
const newSubName = document.getElementById('newSubName');
const newSubDesc = document.getElementById('newSubDesc');
const doCreateSubBtn = document.getElementById('doCreateSubBtn');
const closeCreateSubBtn = document.getElementById('closeCreateSubBtn');

const postSubId = document.getElementById('postSubId');
const postTypeSelect = document.getElementById('postTypeSelect');
const postTitleInput = document.getElementById('postTitleInput');
const postContentInput = document.getElementById('postContentInput');
const pollBlock = document.getElementById('pollBlock');
const pollQuestion = document.getElementById('pollQuestion');
const pollOptions = document.getElementById('pollOptions');
const doCreatePostBtn = document.getElementById('doCreatePostBtn');
const closeCreatePostBtn = document.getElementById('closeCreatePostBtn');

const reportTypeInput = document.getElementById('reportTypeInput');
const reportTargetInput = document.getElementById('reportTargetInput');
const reportReasonInput = document.getElementById('reportReasonInput');
const doReportBtn = document.getElementById('doReportBtn');
const closeReportBtn = document.getElementById('closeReportBtn');

const keyIcon = document.getElementById('keyIcon');
const lookupUsername_el = document.getElementById('lookupUsername');
const doLookupBtn = document.getElementById('doLookupBtn');
const lookupResult = document.getElementById('lookupResult');

const adminTargetInput = document.getElementById('adminTargetInput');
const promoteAdminBtn = document.getElementById('promoteAdminBtn');
const demoteAdminBtn = document.getElementById('demoteAdminBtn');

const blackInput = document.getElementById('blackInput');
const addBlackBtn = document.getElementById('addBlackBtn');
const removeBlackBtn = document.getElementById('removeBlackBtn');
const blackAdminView = document.getElementById('blackAdminView');

const reportFilterInput = document.getElementById('reportFilterInput');
const adminReportsList = document.getElementById('adminReportsList');

const auditFilterInput = document.getElementById('auditFilterInput');
const exportAuditBtn = document.getElementById('exportAuditBtn');
const adminAuditList = document.getElementById('adminAuditList');

const closeAdminBtn = document.getElementById('closeAdminBtn');

// Utilities
function setSession(uid){ localStorage.setItem(SESSION_KEY, uid); }
function clearSession(){ localStorage.removeItem(SESSION_KEY); }
function getSession(){ return localStorage.getItem(SESSION_KEY); }
async function sha256Hex(str){ const enc = new TextEncoder().encode(str); const h = await crypto.subtle.digest('SHA-256', enc); return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join(''); }

function showModal(el){ overlay.classList.add('show'); el.classList.add('show'); }
function hideModal(el){ overlay.classList.remove('show'); el.classList.remove('show'); }

function getEvasionLock(){ return localStorage.getItem(`${FORUM_ROOT}evasionLock`); }
function clearEvasionLock(){ localStorage.removeItem(`${FORUM_ROOT}evasionLock`); }
function setEvasionLock(durationMs = 315360000000){
  localStorage.setItem(`${FORUM_ROOT}evasionLock`, Date.now() + durationMs);
}
function isEvasionLocked(){
  const until = getEvasionLock();
  if(!until) return false;
  const expiryTime = parseInt(until);
  if(Date.now() > expiryTime) {
    clearEvasionLock();
    return false;
  }
  return true;
}

// Get username from UID - uses cache and falls back to lastLoggedInUser
function getUsernameFromUid(uid) {
    if (!uid) return localStorage.getItem('lastLoggedInUser') || 'Unknown';
    if (ALL_USERS[uid] && ALL_USERS[uid].username) {
        return ALL_USERS[uid].username;
    }
    return localStorage.getItem('lastLoggedInUser') || uid.substring(0, 8);
}

// UI wiring
openLoginBtn.onclick = ()=> showModal(loginModal);
openSignupBtn.onclick = ()=> showModal(signupModal);
closeLoginBtn.onclick = ()=> hideModal(loginModal);
closeSignupBtn.onclick = ()=> hideModal(signupModal);

createSubBtn.onclick = ()=> { if(!CURRENT_USER) return alert('Sign in first'); newSubId.value=''; newSubName.value=''; newSubDesc.value=''; showModal(createSubModal); };
closeCreateSubBtn.onclick = ()=> hideModal(createSubModal);

createPostBtn.onclick = ()=> { if(!CURRENT_USER) return alert('Sign in first'); postSubId.value=''; postTypeSelect.value='text'; postTitleInput.value=''; postContentInput.value=''; pollQuestion.value=''; pollOptions.value=''; pollBlock.classList.add('hidden'); showModal(createPostModal); };
closeCreatePostBtn.onclick = ()=> hideModal(createPostModal);
postTypeSelect.onchange = ()=> pollBlock.classList.toggle('hidden', postTypeSelect.value!=='poll');

closeReportBtn.onclick = ()=> hideModal(reportModal);

doLoginBtn.onclick = async ()=>{
  if(isEvasionLocked()) return alert('Access is restricted from this device.');

  const username = loginUsername.value?.trim()?.toLowerCase();
  const pass = loginPassword.value;
  if(!username||!pass) return alert('Enter username and password');
  
  const map = await get(ref(db, `${FORUM_ROOT}/usersByName/${username}`));
  if(!map.exists()) return alert('No such user');
  const uid = map.val();
  
  const snap = await get(ref(db, `${FORUM_ROOT}/users/${uid}`));
  if(!snap.exists()) return alert('User record missing');
  
  const ph = await sha256Hex(pass);
  if(snap.val().passwordHash !== ph) return alert('Wrong password');
  
  const r = await get(ref(db, `${FORUM_ROOT}/restrictions/${uid}`));
  if(r.exists()){
      const restriction = r.val();
      const isPermanentlyBanned = restriction.restrictLogin;
      const isTemporarilyRestricted = restriction.until && restriction.until > Date.now();
      
      if (isPermanentlyBanned || isTemporarilyRestricted) {
          if (isPermanentlyBanned) {
              setEvasionLock();
          } else if (isTemporarilyRestricted) {
              const remainingMs = restriction.until - Date.now();
              setEvasionLock(remainingMs);
          }

          if (isPermanentlyBanned && restriction.restrictLogin) {
              return alert('Your account is permanently restricted. Contact an admin.'); 
          } else {
              return alert('Your account is currently restricted. Please wait for the restriction to expire.');
          }
      }
  }

  clearEvasionLock();
  localStorage.setItem('lastLoggedInUser', username);
  setSession(uid);
  await refreshCurrentUser();
  hideModal(loginModal);
};

doSignupBtn.onclick = async ()=>{
  if(isEvasionLocked()) return alert('Access is restricted from this device.');
  const username = signupUsername.value?.trim()?.toLowerCase();
  const pass = signupPassword.value;
  if(!username||!pass) return alert('Enter username and password');
  const exists = await get(ref(db, `${FORUM_ROOT}/usersByName/${username}`));
  if(exists.exists()) return alert('Username taken');
  const newRef = push(ref(db, `${FORUM_ROOT}/_userIds`));
  const uid = newRef.key;
  const ph = await sha256Hex(pass);
  const userObj = { username, isAdmin:false, moderatedSubforums:[], karma:0, badges:[], passwordHash:ph, createdAt:Date.now() };
  await set(ref(db, `${FORUM_ROOT}/users/${uid}`), userObj);
  await set(ref(db, `${FORUM_ROOT}/usersByName/${username}`), uid);
  localStorage.setItem('lastLoggedInUser', username);
  setSession(uid);
  await refreshCurrentUser();
  hideModal(signupModal);
};

logoutBtn.onclick = ()=>{ clearSession(); location.reload(); };

// Core listeners
function startListeners(){
  onValue(ref(db, `${FORUM_ROOT}/users`), snap=>{ ALL_USERS = snap.val() || {}; });
  onValue(ref(db, `${FORUM_ROOT}/subforums`), snap=>{ ALL_SUBFORUMS = snap.val() || {}; renderSubforums(); });
  onValue(ref(db, `${FORUM_ROOT}/posts`), snap=>{ ALL_POSTS = snap.val() || {}; renderPostsFeed(); updateAdminStats(); });
  onValue(ref(db, `${FORUM_ROOT}/comments`), snap=>{ ALL_COMMENTS = snap.val() || {}; renderPostsFeed(); });
  onValue(ref(db, `${FORUM_ROOT}/blacklist`), snap=>{ BLACKLIST = Object.values(snap.val()||{}); renderBlacklist(); renderAdminBlacklistView(); });
  onValue(ref(db, `${FORUM_ROOT}/reports`), snap=>{ ALL_REPORTS = snap.val() || {}; renderModQueue(); renderAdminReportsList(); updateAdminStats(); });
  onValue(ref(db, `${FORUM_ROOT}/auditLogs`), snap=>{ ALL_AUDIT = snap.val() || {}; renderAdminAuditList(); });
  onValue(ref(db, `${FORUM_ROOT}/admins`), snap=>{ ALL_ADMINS = snap.val() || {}; renderAdminList(); renderAdminListModal(); });
  onValue(ref(db, `${FORUM_ROOT}/offenses`), snap=>{ ALL_OFFENSES = snap.val() || {}; updateAdminStats(); });
}

// Render Subforums
function renderSubforums(){
  subforumItems.innerHTML = "";
  for(const id in ALL_SUBFORUMS){
    const sf = ALL_SUBFORUMS[id];
    const el = document.createElement("div"); 
    el.className = "subforum-item";
    let modBadge = '';
    if(CURRENT_USER && sf.moderators && sf.moderators[CURRENT_USER.uid]) {
      modBadge = '<span class="mod-badge">MOD</span>';
    }
    el.innerHTML = `<div class="name">${escapeHtml(sf.name)}</div><div class="desc">${escapeHtml(sf.description||"No description")}</div>${modBadge}`;
    el.onclick = ()=> { FILTER_SUBFORUM = id; document.getElementById('currentSubforumLabel').textContent = `/ ${sf.name}`; renderPostsFeed(); };
    subforumItems.appendChild(el);
  }
  if(Object.keys(ALL_SUBFORUMS).length === 0) {
    subforumItems.innerHTML = '<p class="small muted text-center">No subforums yet. Create one!</p>';
  }
}

// Render Posts
let FILTER_SUBFORUM = null;

function renderPostsFeed(){
  postsFeed.innerHTML = "";
  const arr = [];
  const now = Date.now();
  for(const id in ALL_POSTS){
    const p = ALL_POSTS[id];
    const pub = p.publishAt || p.createdAt || 0;
    if(pub > now) continue;
    if(FILTER_SUBFORUM && p.subforum !== FILTER_SUBFORUM) continue;
    if(document.getElementById('showPinnedOnly').checked && !(p.settings && p.settings.isPinned)) continue;
    arr.push({ id, ...p });
  }
  const sort = document.getElementById('sortSelect').value;
  if(sort === "new") arr.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
  if(sort === "top") arr.sort((a,b)=> postScore(b) - postScore(a));
  if(sort === "pinned") arr.sort((a,b)=> (b.settings?.isPinned?1:0) - (a.settings?.isPinned?1:0));

  if(arr.length === 0) {
    postsFeed.innerHTML = '<div class="text-center muted" style="padding:40px"><p>No posts yet. Be the first to create one!</p></div>';
    return;
  }

  for(const post of arr){
    const card = document.createElement("div"); 
    card.className = "post-card";
    
    const authorName = getUsernameFromUid(post.author);
    const pinnedPill = post.settings?.isPinned ? `<span class="pill">ðŸ“Œ Pinned</span>` : "";
    const lockedPill = post.settings?.isLocked ? `<span class="pill warning">ðŸ”’ Locked</span>` : "";
    
    card.innerHTML = `
      <div class="post-header">
        <div>
          <div class="post-title">${escapeHtml(post.title)} ${pinnedPill} ${lockedPill}</div>
          <div class="post-meta">
            <span>by <strong>${escapeHtml(authorName)}</strong></span>
            <span>â€¢</span>
            <span>${post.subforum}</span>
            <span>â€¢</span>
            <span>${new Date(post.createdAt).toLocaleDateString()}</span>
          </div>
        </div>
      </div>
      <div class="post-content">${renderText(post.content)}</div>
    `;

    // Voting
    const votesAllowed = !(post.settings?.disableVotes) && !(ALL_SUBFORUMS[post.subforum]?.settings?.disableVotes);
    const footer = document.createElement("div"); 
    footer.className = "post-footer";
    
    if(votesAllowed){
      const score = postScore(post);
      footer.innerHTML = `
        <button class="vote-btn" data-action="up">â–²</button>
        <span class="score">${score}</span>
        <button class="vote-btn" data-action="down">â–¼</button>
      `;
      footer.querySelector('[data-action="up"]').onclick = async ()=>{ 
        if(!CURRENT_USER) return alert("Sign in"); 
        await set(ref(db, `${FORUM_ROOT}/posts/${post.id}/votes/${CURRENT_USER.uid}`), 1); 
        await audit('votePost', post.id, CURRENT_USER.uid); 
        await updateKarmaForVote(post.id); 
      };
      footer.querySelector('[data-action="down"]').onclick = async ()=>{ 
        if(!CURRENT_USER) return alert("Sign in"); 
        await set(ref(db, `${FORUM_ROOT}/posts/${post.id}/votes/${CURRENT_USER.uid}`), -1); 
        await audit('votePost', post.id, CURRENT_USER.uid); 
        await updateKarmaForVote(post.id); 
      };
    } else { 
      footer.innerHTML = `<span class="small muted">Voting disabled</span>`; 
    }
    card.appendChild(footer);

    // Poll
    if(post.type === "poll" && post.poll && !(post.settings?.disablePolls) && !(ALL_SUBFORUMS[post.subforum]?.settings?.disablePolls)){
      const pdiv = document.createElement("div"); 
      pdiv.className = "mt-4";
      pdiv.innerHTML = `<div class="small" style="margin-bottom:8px"><strong>${escapeHtml(post.poll.question||"")}</strong></div>`;
      const optionsDiv = document.createElement("div");
      optionsDiv.className = "flex flex-wrap";
      post.poll.options.forEach((opt,i)=>{
        const votes = countPollVotes(post.id, i);
        const optBtn = document.createElement("button"); 
        optBtn.className = "btn"; 
        optBtn.textContent = `${opt} (${votes})`;
        optBtn.onclick = async ()=>{ 
          if(!CURRENT_USER) return alert("Sign in"); 
          await set(ref(db, `${FORUM_ROOT}/posts/${post.id}/poll/votes/${CURRENT_USER.uid}`), i); 
          await set(ref(db, `${FORUM_ROOT}/pollVotes/${post.id}/${CURRENT_USER.uid}`), i); 
          await audit("pollVote", `${post.id}:${i}`, CURRENT_USER.uid); 
        };
        optionsDiv.appendChild(optBtn);
      });
      pdiv.appendChild(optionsDiv);
      card.appendChild(pdiv);
    }

    // Comments
    const commentsDisabled = post.settings?.disableComments || ALL_SUBFORUMS[post.subforum]?.settings?.disableComments;
    if(!commentsDisabled){
      const commentBox = document.createElement("div"); 
      commentBox.className = "mt-4";
      const ta = document.createElement("textarea"); 
      ta.rows = 2; 
      ta.placeholder = "Write a comment...";
      ta.style.marginBottom = "8px";
      const btn = document.createElement("button"); 
      btn.className = "btn btn-primary"; 
      btn.textContent = "Post Comment";
      btn.onclick = async ()=>{
        if(!CURRENT_USER) return alert("Sign in");
        const txt = ta.value.trim(); if(!txt) return;
        const rSnap = await get(ref(db, `${FORUM_ROOT}/restrictions/${CURRENT_USER.uid}`));
        if(rSnap.exists() && rSnap.val().restrictComment) return alert("You are restricted from commenting.");
        if(containsBlacklisted(txt)){ 
          const cens = censorText(txt); 
          const n = push(ref(db, `${FORUM_ROOT}/offenses`)); 
          await set(n, { by: CURRENT_USER.uid, type:"comment", content: txt, createdAt: Date.now(), reason:"blacklistMatch" }); 
          await incrementOffense(CURRENT_USER.uid); 
          await push(ref(db, `${FORUM_ROOT}/comments/${post.id}`)).then(async rr=> await set(rr, { author: CURRENT_USER.uid, content:cens, votes:{}, settings:{disabled:false}, createdAt:Date.now(), replies:{} })); 
        } else {
          const newRef = push(ref(db, `${FORUM_ROOT}/comments/${post.id}`)); 
          await set(newRef, { author: CURRENT_USER.uid, content: txt, votes:{}, settings:{disabled:false}, createdAt: Date.now(), replies:{} });
        }
        await audit("createComment", post.id, CURRENT_USER.uid);
        ta.value = "";
      };
      commentBox.appendChild(ta); 
      commentBox.appendChild(btn); 
      card.appendChild(commentBox);
    } else {
      const dn = document.createElement("div"); 
      dn.className = "small muted mt-2"; 
      dn.textContent = "Comments disabled"; 
      card.appendChild(dn);
    }

    // Admin/mod controls
    let isGlobalAdmin = (ALL_ADMINS && ALL_ADMINS[CURRENT_USER?.uid]);
    let isSubMod = (ALL_SUBFORUMS[post.subforum] && ALL_SUBFORUMS[post.subforum].moderators && ALL_SUBFORUMS[post.subforum].moderators[CURRENT_USER?.uid]);
    if(CURRENT_USER && (isGlobalAdmin || isSubMod)){
      const ap = document.createElement("div"); 
      ap.className = "admin-actions";
      ap.innerHTML = `
        <button class="btn btn-danger" data-action="del">Delete</button>
        <button class="btn" data-action="pin">Pin</button>
        <button class="btn" data-action="lock">Lock</button>
        <button class="btn" data-action="disableVotes">No Votes</button>
        <button class="btn" data-action="disableComments">No Comments</button>
      `;
      card.appendChild(ap);
      ap.querySelector('[data-action="del"]').onclick = async ()=>{ if(confirm("Delete post?")){ await remove(ref(db, `${FORUM_ROOT}/posts/${post.id}`)); await audit("deletePost", post.id, CURRENT_USER.uid); } };
      ap.querySelector('[data-action="pin"]').onclick = async ()=>{ await update(ref(db, `${FORUM_ROOT}/posts/${post.id}/settings`), { isPinned:true }); await audit("pinPost", post.id, CURRENT_USER.uid); };
      ap.querySelector('[data-action="lock"]').onclick = async ()=>{ await update(ref(db, `${FORUM_ROOT}/posts/${post.id}/settings`), { isLocked:true }); await audit("lockPost", post.id, CURRENT_USER.uid); };
      ap.querySelector('[data-action="disableVotes"]').onclick = async ()=>{ await update(ref(db, `${FORUM_ROOT}/posts/${post.id}/settings`), { disableVotes:true }); await audit("disableVotesPost", post.id, CURRENT_USER.uid); };
      ap.querySelector('[data-action="disableComments"]').onclick = async ()=>{ await update(ref(db, `${FORUM_ROOT}/posts/${post.id}/settings`), { disableComments:true }); await audit("disableCommentsPost", post.id, CURRENT_USER.uid); };
    }

    // Comments rendering
    const commentTree = ALL_COMMENTS[post.id] || {};
    if(Object.keys(commentTree).length > 0) {
      const croot = document.createElement("div"); 
      croot.className = "comments-section";
      croot.innerHTML = `<div class="small" style="margin-bottom:12px"><strong>Comments (${Object.keys(commentTree).length})</strong></div>`;
      for(const cid in commentTree){
        croot.appendChild(renderCommentBlock(post.id, cid, commentTree[cid]));
      }
      card.appendChild(croot);
    }

    postsFeed.appendChild(card);
  }
}

// Comment renderer
function renderCommentBlock(postId, commentId, commentObj, depth=0){
  const wrap = document.createElement("div"); 
  wrap.style.setProperty('--depth', `${depth*16}px`);
  
  const el = document.createElement("div"); 
  el.className = "comment";
  el.style.marginLeft = `${depth*16}px`;
  
  const authorName = getUsernameFromUid(commentObj.author);
  
  el.innerHTML = `
    <div class="comment-header">
      <span class="comment-author">${escapeHtml(authorName)}</span>
      <span class="comment-time">${new Date(commentObj.createdAt||0).toLocaleString()}</span>
    </div>
    <div class="comment-content">${renderText(commentObj.content)}</div>
  `;
  
  if(!(commentObj.settings?.disabled)){
    const voteDiv = document.createElement("div");
    voteDiv.className = "flex mt-2";
    voteDiv.innerHTML = `
      <button class="vote-btn" data-action="up" style="width:24px;height:24px;font-size:10px">â–²</button>
      <span class="score small">${commentScore(commentObj)}</span>
      <button class="vote-btn" data-action="down" style="width:24px;height:24px;font-size:10px">â–¼</button>
    `;
    voteDiv.querySelector('[data-action="up"]').onclick = async ()=>{ 
      if(!CURRENT_USER) return alert("Sign in"); 
      await set(ref(db, `${FORUM_ROOT}/comments/${postId}/${commentId}/votes/${CURRENT_USER.uid}`), 1); 
      await audit("voteComment", `${postId}:${commentId}`, CURRENT_USER.uid); 
    };
    voteDiv.querySelector('[data-action="down"]').onclick = async ()=>{ 
      if(!CURRENT_USER) return alert("Sign in"); 
      await set(ref(db, `${FORUM_ROOT}/comments/${postId}/${commentId}/votes/${CURRENT_USER.uid}`), -1); 
      await audit("voteComment", `${postId}:${commentId}`, CURRENT_USER.uid); 
    };
    el.appendChild(voteDiv);
  } else {
    const dn = document.createElement("div"); 
    dn.className = "small muted mt-2"; 
    dn.textContent = "Comment disabled"; 
    el.appendChild(dn);
  }

  // Mod actions
  const isGlobalAdmin = (ALL_ADMINS && ALL_ADMINS[CURRENT_USER?.uid]);
  const postSub = ALL_POSTS[postId]?.subforum;
  const isSubMod = (ALL_SUBFORUMS[postSub] && ALL_SUBFORUMS[postSub].moderators && ALL_SUBFORUMS[postSub].moderators[CURRENT_USER?.uid]);
  if(CURRENT_USER && (isGlobalAdmin || isSubMod)){
    const m = document.createElement("div"); 
    m.className = "flex mt-2";
    m.innerHTML = `
      <button class="btn btn-danger" style="font-size:10px;padding:4px 8px">Delete</button>
      <button class="btn" style="font-size:10px;padding:4px 8px">Disable</button>
    `;
    m.children[0].onclick = async ()=>{ if(confirm("Delete comment?")){ await remove(ref(db, `${FORUM_ROOT}/comments/${postId}/${commentId}`)); await audit("deleteComment", `${postId}:${commentId}`, CURRENT_USER.uid); } };
    m.children[1].onclick = async ()=>{ await update(ref(db, `${FORUM_ROOT}/comments/${postId}/${commentId}/settings`), { disabled:true }); await audit("disableComment", `${postId}:${commentId}`, CURRENT_USER.uid); };
    el.appendChild(m);
  }

  wrap.appendChild(el);

  const replies = commentObj.replies || {};
  for(const rid in replies){
    wrap.appendChild(renderCommentBlock(postId, `${commentId}/replies/${rid}`, replies[rid], depth+1));
  }
  return wrap;
}

// Mod Queue
function renderModQueue(){
  modQueue.innerHTML = "";
  let count = 0;
  for(const key in ALL_REPORTS){
    for(const rid in ALL_REPORTS[key]){
      const r = ALL_REPORTS[key][rid];
      if(r.handled) continue;
      count++;
      const reporterName = getUsernameFromUid(r.reporter);
      const card = document.createElement("div"); 
      card.className = "list-item";
      card.innerHTML = `
        <div class="list-item-header">
          <span class="list-item-type">${key}</span>
          <span class="list-item-time">${new Date(r.createdAt).toLocaleDateString()}</span>
        </div>
        <div class="list-item-content">${escapeHtml(reporterName)}: ${escapeHtml(r.reason)}</div>
      `;
      const btn = document.createElement("button"); 
      btn.className = "btn btn-primary mt-2"; 
      btn.style.fontSize = "11px";
      btn.textContent = "Mark Handled";
      btn.onclick = async ()=>{ 
        await update(ref(db, `${FORUM_ROOT}/reports/${key}/${rid}`), { handled:true, handledBy: CURRENT_USER.uid, handledAt: Date.now() }); 
        await audit("handleReport", `${key}:${rid}`, CURRENT_USER.uid); 
        card.remove(); 
      };
      card.appendChild(btn); 
      modQueue.appendChild(card);
    }
  }
  if(count === 0) modQueue.innerHTML = '<p class="small muted">No pending reports</p>';
}

function renderBlacklist(){
  blacklistView.innerHTML = BLACKLIST.length ? BLACKLIST.map(w=>`<span class="blacklist-tag">${escapeHtml(w)}</span>`).join("") : '<span class="small muted">No blacklisted words</span>';
}

function renderAdminList(){
  const arr = [];
  for(const uid in ALL_ADMINS) {
    if(ALL_ADMINS[uid]) {
      arr.push(getUsernameFromUid(uid));
    }
  }
  adminList.textContent = arr.length ? arr.join(", ") : "None";
}

function renderAdminListModal(){
  const el = document.getElementById('adminListModal');
  if(!el) return;
  const arr = [];
  for(const uid in ALL_ADMINS) {
    if(ALL_ADMINS[uid]) {
      arr.push(getUsernameFromUid(uid));
    }
  }
  el.innerHTML = arr.length ? arr.map(n=>`<span class="pill">${escapeHtml(n)}</span>`).join("") : '<span class="small muted">No admins</span>';
}

// Admin modal
function updateAdminStats(){
  document.getElementById('statUsers').textContent = Object.keys(ALL_USERS).length;
  document.getElementById('statPosts').textContent = Object.keys(ALL_POSTS).length;
  let reportCount = 0;
  for(const k in ALL_REPORTS) {
    for(const r in ALL_REPORTS[k]) {
      if(!ALL_REPORTS[k][r].handled) reportCount++;
    }
  }
  document.getElementById('statReports').textContent = reportCount;
  document.getElementById('statOffenses').textContent = Object.keys(ALL_OFFENSES).length;
}

function renderAdminReportsList(){
  adminReportsList.innerHTML = "";
  const filter = reportFilterInput.value?.trim().toLowerCase();
  let hasItems = false;
  for(const k in ALL_REPORTS){
    for(const rid in ALL_REPORTS[k]){
      const r = ALL_REPORTS[k][rid];
      const reporterName = getUsernameFromUid(r.reporter);
      if(filter && !(k.includes(filter) || reporterName.toLowerCase().includes(filter) || (r.reason||"").toLowerCase().includes(filter))) continue;
      hasItems = true;
      const d = document.createElement("div"); 
      d.className = "list-item";
      d.innerHTML = `
        <div class="list-item-header">
          <span class="list-item-type">${k}</span>
          <span class="list-item-time">${new Date(r.createdAt).toLocaleDateString()}</span>
        </div>
        <div class="list-item-content">${escapeHtml(reporterName)}: ${escapeHtml(r.reason)}</div>
        <div class="small muted mt-2">${r.handled ? 'âœ… Handled' : 'â³ Pending'}</div>
      `;
      adminReportsList.appendChild(d);
    }
  }
  if(!hasItems) adminReportsList.innerHTML = '<p class="small muted">No reports found</p>';
}

function renderAdminAuditList(){
  adminAuditList.innerHTML = "";
  const rows = [];
  for(const id in ALL_AUDIT) rows.push(ALL_AUDIT[id]);
  rows.sort((a,b)=> (b.timestamp||0) - (a.timestamp||0));
  const filter = auditFilterInput.value?.trim().toLowerCase();
  let count = 0;
  for(const r of rows.slice(0,200)){
    const byName = getUsernameFromUid(r.by);
    if(filter && !(r.action.toLowerCase().includes(filter) || byName.toLowerCase().includes(filter) || (r.target||"").toLowerCase().includes(filter))) continue;
    count++;
    const d = document.createElement("div"); 
    d.className = "list-item";
    d.innerHTML = `
      <div class="list-item-header">
        <span class="list-item-type">${r.action}</span>
        <span class="list-item-time">${new Date(r.timestamp).toLocaleString()}</span>
      </div>
      <div class="list-item-content">Target: ${r.target} â€¢ By: ${escapeHtml(byName)}</div>
    `;
    adminAuditList.appendChild(d);
  }
  if(count === 0) adminAuditList.innerHTML = '<p class="small muted">No audit entries found</p>';
}

function renderAdminBlacklistView(){
  blackAdminView.innerHTML = BLACKLIST.length ? BLACKLIST.map(w=>`<span class="blacklist-tag">${escapeHtml(w)}</span>`).join("") : '<span class="small muted">No blacklisted words</span>';
}

// Admin tabs
document.querySelectorAll('.admin-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
  });
});

// Admin controls
promoteAdminBtn.onclick = async ()=>{
  if(!CURRENT_USER || CURRENT_USER.username !== "logan") return alert("Only logan can promote admins.");
  const uname = adminTargetInput.value?.trim().toLowerCase(); if(!uname) return alert("Enter username");
  const map = await get(ref(db, `${FORUM_ROOT}/usersByName/${uname}`)); if(!map.exists()) return alert("User not found");
  const uid = map.val();
  await set(ref(db, `${FORUM_ROOT}/admins/${uid}`), true);
  await update(ref(db, `${FORUM_ROOT}/users/${uid}`), { isAdmin:true });
  await audit("promoteAdmin", uid, CURRENT_USER.uid);
  adminTargetInput.value = '';
};

demoteAdminBtn.onclick = async ()=>{
  if(!CURRENT_USER || CURRENT_USER.username !== "logan") return alert("Only logan can demote admins.");
  const uname = adminTargetInput.value?.trim().toLowerCase(); if(!uname) return alert("Enter username");
  const map = await get(ref(db, `${FORUM_ROOT}/usersByName/${uname}`)); if(!map.exists()) return alert("User not found");
  const uid = map.val();
  await remove(ref(db, `${FORUM_ROOT}/admins/${uid}`));
  await update(ref(db, `${FORUM_ROOT}/users/${uid}`), { isAdmin:false });
  await audit("demoteAdmin", uid, CURRENT_USER.uid);
  adminTargetInput.value = '';
};

addBlackBtn.onclick = async ()=>{ 
  if(!CURRENT_USER || !(CURRENT_USER.isAdmin || CURRENT_USER.username==="logan")) return alert("Admins only"); 
  const w = blackInput.value?.trim().toLowerCase(); if(!w) return; 
  const bref = push(ref(db, `${FORUM_ROOT}/blacklist`)); 
  await set(bref, w); 
  await audit("addBlacklist", w, CURRENT_USER.uid); 
  blackInput.value=''; 
};

removeBlackBtn.onclick = async ()=>{ 
  if(!CURRENT_USER || !(CURRENT_USER.isAdmin || CURRENT_USER.username==="logan")) return alert("Admins only"); 
  const w = blackInput.value?.trim().toLowerCase(); if(!w) return; 
  const snap = await get(ref(db, `${FORUM_ROOT}/blacklist`)); 
  if(!snap.exists()) return alert("Empty"); 
  const obj = snap.val(); 
  for(const k in obj) if(obj[k] === w) { 
    await remove(ref(db, `${FORUM_ROOT}/blacklist/${k}`)); 
    await audit("removeBlacklist", w, CURRENT_USER.uid); 
    break; 
  } 
  blackInput.value=''; 
};

// User lookup
doLookupBtn.onclick = async ()=>{
  const uname = lookupUsername_el.value?.trim().toLowerCase(); 
  if(!uname) return alert("Enter username");
  const map = await get(ref(db, `${FORUM_ROOT}/usersByName/${uname}`)); 
  if(!map.exists()) return alert("Not found");
  const uid = map.val();
  const snap = await get(ref(db, `${FORUM_ROOT}/users/${uid}`));
  if(!snap.exists()) return alert("No record");
  const user = snap.val();
  
  const offenseSnap = await get(ref(db, `${FORUM_ROOT}/userOffenseCounts/${uid}`));
  const offenseCount = offenseSnap.exists() ? (offenseSnap.val().count || 0) : 0;
  
  const restrictionSnap = await get(ref(db, `${FORUM_ROOT}/restrictions/${uid}`));
  const restriction = restrictionSnap.exists() ? restrictionSnap.val() : null;
  let restrictionStatus = 'None';
  if(restriction) {
    if(restriction.restrictLogin) restrictionStatus = 'ðŸš« Banned';
    else if(restriction.until && restriction.until > Date.now()) restrictionStatus = 'â³ Temporary';
  }
  
  lookupResult.innerHTML = `
    <div class="lookup-result">
      <div class="lookup-user">
        <div class="lookup-avatar">${(user.username || 'U')[0].toUpperCase()}</div>
        <div class="lookup-info">
          <h4>${escapeHtml(user.username)}</h4>
          <p>${user.isAdmin ? 'ðŸ‘‘ Admin' : 'ðŸ‘¤ User'} â€¢ Joined ${new Date(user.createdAt || 0).toLocaleDateString()}</p>
        </div>
      </div>
      <div class="lookup-stats">
        <div class="lookup-stat">
          <div class="lookup-stat-value">${user.karma || 0}</div>
          <div class="lookup-stat-label">Karma</div>
        </div>
        <div class="lookup-stat">
          <div class="lookup-stat-value">${offenseCount}</div>
          <div class="lookup-stat-label">Offenses</div>
        </div>
        <div class="lookup-stat">
          <div class="lookup-stat-value" style="font-size:12px">${restrictionStatus}</div>
          <div class="lookup-stat-label">Status</div>
        </div>
      </div>
      <div class="lookup-actions" id="lookupActions"></div>
    </div>
  `;
  
  const actions = document.getElementById('lookupActions');
  
  const warnBtn = document.createElement("button"); 
  warnBtn.className = "btn"; 
  warnBtn.textContent = "âš ï¸ Warn";
  warnBtn.onclick = async ()=>{ 
    const n = push(ref(db, `${FORUM_ROOT}/offenses`)); 
    await set(n, { by: uid, reason:'warned by admin', createdAt: Date.now() }); 
    await audit("warnUser", uid, CURRENT_USER.uid); 
    alert("User warned"); 
  };
  
  const muteBtn = document.createElement("button"); 
  muteBtn.className = "btn"; 
  muteBtn.textContent = "ðŸ”‡ Mute 24h";
  muteBtn.onclick = async ()=>{ 
    const muteDuration = 24*3600*1000;
    await set(ref(db, `${FORUM_ROOT}/restrictions/${uid}`), { restrictPost:true, restrictComment:true, restrictLogin:false, until: Date.now()+muteDuration }); 
    await audit("muteUser", uid, CURRENT_USER.uid); 
    alert("Muted 24h"); 
  };
  
  const banBtn = document.createElement("button"); 
  banBtn.className = "btn btn-danger"; 
  banBtn.textContent = "ðŸš« Ban";
  banBtn.onclick = async ()=>{ 
    if(!confirm("Ban user (block login)?")) return; 
    await set(ref(db, `${FORUM_ROOT}/restrictions/${uid}`), { restrictPost:true, restrictComment:true, restrictLogin:true, until:null }); 
    await audit("banUser", uid, CURRENT_USER.uid); 
    alert("Banned"); 
  };
  
  const unbanBtn = document.createElement("button"); 
  unbanBtn.className = "btn btn-primary"; 
  unbanBtn.textContent = "âœ… Unban";
  unbanBtn.onclick = async ()=>{ 
    await remove(ref(db, `${FORUM_ROOT}/restrictions/${uid}`)); 
    await audit("unbanUser", uid, CURRENT_USER.uid); 
    alert("Unbanned"); 
  };
  
  const clearOffBtn = document.createElement("button"); 
  clearOffBtn.className = "btn"; 
  clearOffBtn.textContent = "ðŸ§¹ Clear Offenses";
  clearOffBtn.onclick = async ()=>{ 
    const snap = await get(ref(db, `${FORUM_ROOT}/offenses`)); 
    if(!snap.exists()) return alert("No offenses"); 
    const obj = snap.val(); 
    for(const k in obj) if(obj[k].by === uid) await remove(ref(db, `${FORUM_ROOT}/offenses/${k}`)); 
    await remove(ref(db, `${FORUM_ROOT}/userOffenseCounts/${uid}`));
    await audit("clearOffenses", uid, CURRENT_USER.uid); 
    alert("Cleared"); 
  };
  
  actions.appendChild(warnBtn); 
  actions.appendChild(muteBtn); 
  actions.appendChild(banBtn); 
  actions.appendChild(unbanBtn); 
  actions.appendChild(clearOffBtn);
};

// Report modal
doReportBtn.onclick = async ()=>{
  if(!CURRENT_USER) return alert("Sign in");
  const type = reportTypeInput.value?.trim();
  const target = reportTargetInput.value?.trim();
  const reason = reportReasonInput.value?.trim();
  if(!type||!target||!reason) return alert("Fill all fields");
  const rref = push(ref(db, `${FORUM_ROOT}/reports/${type}_${target.replace("/","_")}`));
  await set(rref, { reporter: CURRENT_USER.uid, reason, createdAt: Date.now(), handled:false });
  await audit("createReport", `${type}:${target}`, CURRENT_USER.uid);
  hideModal(reportModal);
};

// Create sub/post
doCreateSubBtn.onclick = async ()=>{
  if(!CURRENT_USER) return alert("Sign in");
  const id = newSubId.value?.trim().toLowerCase(); if(!id) return alert("ID required");
  const snap = await get(ref(db, `${FORUM_ROOT}/subforums/${id}`)); if(snap.exists()) return alert("Already exists");
  const display = newSubName.value?.trim() || id; 
  const desc = newSubDesc.value?.trim() || "";
  await set(ref(db, `${FORUM_ROOT}/subforums/${id}`), { 
    name: display, 
    description: desc, 
    creator: CURRENT_USER.uid, 
    createdAt: Date.now(), 
    settings:{ disablePolls:false, disableVotes:false, disableComments:false }, 
    moderators: { [CURRENT_USER.uid]: true }
  });
  const userSnap = await get(ref(db, `${FORUM_ROOT}/users/${CURRENT_USER.uid}`));
  const msubs = userSnap.exists() ? (userSnap.val().moderatedSubforums || []) : [];
  if(!msubs.includes(id)){ 
    msubs.push(id); 
    await update(ref(db, `${FORUM_ROOT}/users/${CURRENT_USER.uid}`), { moderatedSubforums: msubs }); 
  }
  await audit("createSubforum", id, CURRENT_USER.uid);
  hideModal(createSubModal);
};

doCreatePostBtn.onclick = async ()=>{
  if(!CURRENT_USER) return alert("Sign in");
  const sub = postSubId.value?.trim(); if(!sub) return alert("Subforum required");
  const sSnap = await get(ref(db, `${FORUM_ROOT}/subforums/${sub}`)); if(!sSnap.exists()) return alert("Subforum not found");
  const r = await get(ref(db, `${FORUM_ROOT}/restrictions/${CURRENT_USER.uid}`)); 
  if(r.exists() && r.val().restrictPost) return alert("You are restricted from posting");
  let title = postTitleInput.value || ""; 
  let content = postContentInput.value || "";
  const wasBlack = containsBlacklisted(title) || containsBlacklisted(content);
  const ct = censorText(content); 
  const tt = censorText(title);
  if(wasBlack){ 
    const o = push(ref(db, `${FORUM_ROOT}/offenses`)); 
    await set(o, { by: CURRENT_USER.uid, reason:"blacklistMatch", createdAt: Date.now() }); 
    await incrementOffense(CURRENT_USER.uid); 
  }
  let poll = null;
  if(postTypeSelect.value==='poll'){ 
    const q = pollQuestion.value || title; 
    const opts = (pollOptions.value||"").split("\n").map(x=>x.trim()).filter(Boolean); 
    poll = { question: censorText(q), options: opts.map(o=>censorText(o)), votes:{} }; 
  }
  const postObj = {
    title: tt, content: ct, type: postTypeSelect.value, author: CURRENT_USER.uid, subforum: sub,
    votes:{}, poll, settings:{ disablePolls:false, disableVotes:false, disableComments:false, isPinned:false, isLocked:false }, createdAt: Date.now(), publishAt: Date.now()
  };
  const newRef = push(ref(db, `${FORUM_ROOT}/posts`)); 
  await set(newRef, postObj);
  await audit("createPost", newRef.key, CURRENT_USER.uid);
  hideModal(createPostModal);
};

// Offense system
async function incrementOffense(uid){
  if(!uid) return;
  const snap = await get(ref(db, `${FORUM_ROOT}/userOffenseCounts/${uid}`));
  const cur = snap.exists()? (snap.val().count||0) : 0;
  const next = cur + 1;
  await set(ref(db, `${FORUM_ROOT}/userOffenseCounts/${uid}`), { count: next, last: Date.now() });
  const restrict24h = 24*3600*1000;
  if(next === 3){ 
    await set(ref(db, `${FORUM_ROOT}/restrictions/${uid}`), { restrictPost:true, restrictComment:false, restrictLogin:false, until: Date.now()+restrict24h }); 
    await audit("autoRestrict_posts_24h", uid, "system"); 
  }
  else if(next === 5){ 
    await set(ref(db, `${FORUM_ROOT}/restrictions/${uid}`), { restrictPost:true, restrictComment:true, restrictLogin:false, until: Date.now()+restrict24h }); 
    await audit("autoRestrict_comments_24h", uid, "system"); 
  }
  else if(next >= 7){ 
    await set(ref(db, `${FORUM_ROOT}/restrictions/${uid}`), { restrictPost:true, restrictComment:true, restrictLogin:true, until: null }); 
    await audit("autoBan_login", uid, "system"); 
  }
}

// Karma
async function updateKarmaForVote(postId){
  const snap = await get(ref(db, `${FORUM_ROOT}/posts/${postId}`));
  if(!snap.exists()) return;
  const post = snap.val(); 
  const votes = post.votes || {}; 
  let net = 0; 
  for(const u in votes) net += (votes[u]||0);
  const author = post.author; 
  if(author){
    const s = await get(ref(db, `${FORUM_ROOT}/users/${author}`));
    const curr = s.exists()? (s.val().karma||0) : 0;
    await update(ref(db, `${FORUM_ROOT}/users/${author}`), { karma: curr + net });
  }
}

// Audit
async function audit(action, target, by){
  const r = push(ref(db, `${FORUM_ROOT}/auditLogs`));
  await set(r, { action, target, by, timestamp: Date.now() });
}

// Helpers
function escapeHtml(s){ if(!s) return ""; return String(s).replace(/[&<>"']/g, c=> ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c])); }
function renderText(s){ if(!s) return ""; let out = escapeHtml(s); out = out.replace(/`([^`]+)`/g, "<code style='background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:4px'>$1</code>"); out = out.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>"); return out; }
function containsBlacklisted(text){ if(!text) return false; const t = text.toLowerCase(); for(const w of BLACKLIST){ if(!w) continue; if(t.includes(w.toLowerCase())) return true; } return false; }
function censorText(text){ if(!text) return ""; let out = text; for(const w of BLACKLIST){ if(!w) continue; const re = new RegExp(w, 'ig'); out = out.replace(re, match => '*'.repeat(match.length)); } return out; }

function countPollVotes(postId, optionIndex){ const post = ALL_POSTS[postId]; if(!post || !post.poll) return 0; const votes = post.poll.votes || {}; let c = 0; for(const uid in votes) if(votes[uid] === optionIndex) c++; return c; }
function scoreObj(o){ const v = o.votes || {}; let s=0; for(const k in v) s += (v[k]||0); return s; }
function postScore(p){ return scoreObj(p); }
function commentScore(c){ return scoreObj(c); }

// Export audit
exportAuditBtn.onclick = ()=>{
  const data = JSON.stringify(ALL_AUDIT || {}, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'audit.json'; a.click();
  URL.revokeObjectURL(url);
};

// Admin key icon
keyIcon.onclick = ()=> {
  if(!CURRENT_USER) { showModal(loginModal); return; }
  updateAdminStats();
  renderAdminReportsList();
  renderAdminAuditList();
  renderAdminBlacklistView();
  renderAdminListModal();
  showModal(adminModal);
};
closeAdminBtn.onclick = ()=> hideModal(adminModal);

// Filters
reportFilterInput?.addEventListener('input', ()=> renderAdminReportsList());
auditFilterInput?.addEventListener('input', ()=> renderAdminAuditList());

// Auto-login
(async ()=>{
  startListeners();
  const saved = getSession();
  if(saved){
    const s = await get(ref(db, `${FORUM_ROOT}/users/${saved}`));
    if(s.exists()) await refreshCurrentUser();
    else clearSession();
  }
})();

// Refresh current user
async function refreshCurrentUser(){
  const uid = getSession();
  if(!uid) return;
  const snap = await get(ref(db, `${FORUM_ROOT}/users/${uid}`));
  if(!snap.exists()){ clearSession(); return; }
  CURRENT_USER = { uid, ...snap.val() };
  localStorage.setItem('lastLoggedInUser', CURRENT_USER.username);
  welcomeText.textContent = `Signed in as ${CURRENT_USER.username}`;
  openLoginBtn.classList.add("hidden");
  openSignupBtn.classList.add("hidden");
  logoutBtn.classList.remove("hidden");
  document.getElementById('userPanel').classList.remove('hidden');
  renderUserPanel();
  const isAdminSnap = await get(ref(db, `${FORUM_ROOT}/admins/${uid}`));
  if(isAdminSnap.exists() || (CURRENT_USER.moderatedSubforums && CURRENT_USER.moderatedSubforums.length>0)) modPanel.classList.remove('hidden');
}

// User panel
function renderUserPanel(){
  const userMeta = document.getElementById('userMeta');
  const userActions = document.getElementById('userActions');
  userMeta.innerHTML = `
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
      <div style="width:40px;height:40px;background:var(--accent-dim);border:2px solid var(--accent);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:var(--accent)">${(CURRENT_USER.username || 'U')[0].toUpperCase()}</div>
      <div>
        <strong>${escapeHtml(CURRENT_USER.username)}</strong>
        <div class="small muted">Karma: ${CURRENT_USER.karma||0}</div>
      </div>
    </div>
  `;
  userActions.innerHTML = "";
  const editBtn = document.createElement("button"); 
  editBtn.className = "btn"; 
  editBtn.textContent = "Edit Username";
  editBtn.onclick = async ()=>{ 
    const newName = prompt("New username:", CURRENT_USER.username); 
    if(!newName) return; 
    const nn = newName.trim().toLowerCase(); 
    const exists = await get(ref(db, `${FORUM_ROOT}/usersByName/${nn}`)); 
    if(exists.exists()) return alert("Name taken"); 
    await remove(ref(db, `${FORUM_ROOT}/usersByName/${CURRENT_USER.username}`)); 
    await set(ref(db, `${FORUM_ROOT}/usersByName/${nn}`), CURRENT_USER.uid); 
    await update(ref(db, `${FORUM_ROOT}/users/${CURRENT_USER.uid}`), { username: nn }); 
    await audit("editProfile", CURRENT_USER.uid, CURRENT_USER.uid); 
    await refreshCurrentUser(); 
  };
  userActions.appendChild(editBtn);
}

console.log("TAC Forum loaded.");
</script>
<script src="guard.js"></script>
    <script src="custom-cursor.js"></script>
    <script src="rightclick.js"></script>
    <script src="panic-key.js"></script>
    <script src="idle-dvd.js"></script>
    <script src="timeTracker.js"></script>
</body>
</html>