<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Not Games — TAC (Games)</title>
<link rel="icon" type="image/png" href="favicon.png" />
<style>
  /* --- layout & theme (matches OG + sidebar rgb(26,26,26)) --- */
  :root {
    --green: #058b4a;
    --sidebar: rgb(26,26,26);
    --panel: #ffffff;
    --muted: #666;
  }
  html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:#000;color:var(--green)}
  .sidebar {
    width: 250px;
    background: var(--sidebar);
    color: #fff;
    padding: 20px;
    position: fixed;
    height: 100%;
    overflow: auto;
    box-sizing: border-box;
  }
  .sidebar .logo { width:100%; display:block; margin-bottom:16px; }
  .sidebar nav ul{ list-style:none;padding:0;margin:0; }
  .sidebar nav li{ margin:10px 0; }
  .sidebar nav a{ color:#fff; text-decoration:none; font-weight:600; display:block; padding:6px 8px; border-radius:6px; }
  .sidebar nav a:hover{ background: rgba(255,255,255,0.04); }

  .main {
    margin-left: 270px; /* leaves room for sidebar */
    padding: 20px;
    box-sizing: border-box;
    min-height: 100vh;
  }

  h1{ margin: 6px 0 12px 0; color:var(--green); font-size:24px; }
  p.lead{ color:var(--muted); margin-top:0; margin-bottom:18px; }

  /* games list */
  .controls { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
  #search { padding:10px;border-radius:8px;border:2px solid var(--green); width:360px; font-size:16px; }
  .grid {
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap:12px;
  }
  .card {
    background: var(--panel);
    border-radius:10px;
    padding:10px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    display:flex;
    gap:10px;
    align-items:center;
    cursor:pointer;
    transition: transform .12s ease, box-shadow .12s ease;
  }
  .card:hover{ transform: translateY(-4px); box-shadow: 0 12px 28px rgba(0,0,0,0.08); }
  .logo-thumb{ width:72px;height:56px;object-fit:contain;border-radius:6px;background:#f5f5f5;padding:6px }
  .meta { flex:1 }
  .meta .title { font-weight:700; color:#0b6a3d }
  .meta .cat { font-size:13px; color:var(--muted); margin-top:6px; }

  /* game view area (within content area — sidebar remains visible) */
  .game-view { display:none; margin-top:12px; }
  .game-controls {
    display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:10px;
  }
  .left-controls { display:flex; gap:8px; align-items:center; }
  .btn {
    background:var(--green); color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700;
  }
  .btn.secondary { background:#2b2b2b; }
  .btn.ghost { background:transparent; color:var(--green); border:1px solid var(--green); }
  .game-frame-wrap {
    background:#000; border-radius:8px; overflow:hidden; position:relative;
    height: 72vh; min-height:420px;
  }
  .game-frame {
    width:100%; height:100%; border:0; display:block;
  }
  .close-hint { font-size:13px; color:var(--muted); margin-left:8px; }

  /* empty state */
  .empty { color:var(--muted); padding:18px; background:#fff;border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.04) }

  /* responsive */
  @media (max-width:880px){
    .sidebar{ display:none; }
    .main{ margin-left:0; padding:12px; }
    #search{ width:100%; }
    .game-frame-wrap{ height:60vh; }
  }
</style>
</head>
<body>

  <aside class="sidebar">
    <img src="logo.png" class="logo" alt="TAC Logo">
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="games/Prox.html">TAC Search 1.7</a></li>
        <li><a href="chat.html">Chat</a></li>
        <li><a href="contact.html" target="_blank">Contact</a></li>
        <li><a href="apply.html" target="_blank">Apply for Staff</a></li>
        <li><a href="members.html">Members</a></li>
        <li><a href="notgames.html">Not Games</a></li>
      </ul>
    </nav>
  </aside>

  <main class="main">
    <h1>Games</h1>
    <p class="lead">Click a game to load it — the sidebar stays visible. Use fullscreen for a distraction-free experience.</p>

    <div class="controls">
      <input id="search" placeholder="Search games by title..." />
      <button id="refreshBtn" class="btn secondary">Refresh list</button>
    </div>

    <!-- games list -->
    <div id="listArea" class="grid" aria-live="polite">
      <!-- cards injected here -->
    </div>

    <!-- game viewer (appears in content area; sidebar remains) -->
    <section id="gameView" class="game-view" aria-hidden="true">
      <div class="game-controls">
        <div class="left-controls">
          <img id="gvLogo" src="" alt="" style="width:64px;height:48px;object-fit:contain;border-radius:6px;background:#fff;padding:6px;display:none">
          <div style="margin-left:10px">
            <div id="gvTitle" style="font-weight:800;color:var(--green);font-size:18px">Loading…</div>
            <div id="gvCategory" style="font-size:13px;color:var(--muted);margin-top:4px"></div>
          </div>
        </div>

        <div>
          <button id="fsBtn" class="btn">Fullscreen</button>
          <button id="closeBtn" class="btn ghost" title="Close game">Close</button>
        </div>
      </div>

      <div class="game-frame-wrap" id="gameFrameWrap">
        <iframe id="gameFrame" class="game-frame" sandbox="allow-forms allow-scripts allow-same-origin allow-popups"></iframe>
      </div>
    </section>

    <div id="emptyHint" class="empty" style="display:none; margin-top:12px;">
      No games found. Add games in Firebase under <code>/games</code> (key = id). Each game should include <code>title</code>, <code>logo</code> (filename lowercase no spaces, placed in <code>/logos/</code>), and <code>iframe</code> (URL).
    </div>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ======= Firebase config (your project's config) =======
    const firebaseConfig = {
      apiKey: "AIzaSyBQslLAFRlIRJqsiJ2WWeTNslO067bzKYM",
      authDomain: "taclogin-ab38e.firebaseapp.com",
      databaseURL: "https://taclogin-ab38e-default-rtdb.firebaseio.com",
      projectId: "taclogin-ab38e",
      storageBucket: "taclogin-ab38e.firebasestorage.app",
      messagingSenderId: "937853298051",
      appId: "1:937853298051:web:119ccc7b5499514bd442b6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ======= UI refs =======
    const listArea = document.getElementById('listArea');
    const search = document.getElementById('search');
    const refreshBtn = document.getElementById('refreshBtn');
    const emptyHint = document.getElementById('emptyHint');

    const gameView = document.getElementById('gameView');
    const gvTitle = document.getElementById('gvTitle');
    const gvCategory = document.getElementById('gvCategory');
    const gvLogo = document.getElementById('gvLogo');
    const gameFrame = document.getElementById('gameFrame');
    const closeBtn = document.getElementById('closeBtn');
    const fsBtn = document.getElementById('fsBtn');
    const gameFrameWrap = document.getElementById('gameFrameWrap');

    // Keep games map
    let games = {}; // key -> game object

    // Utility: sanitize text for insertion
    function esc(s){ return String(s||''); }

    // Render list of games
    function renderList(filter='') {
      listArea.innerHTML = '';
      const keys = Object.keys(games);
      if (!keys.length) {
        emptyHint.style.display = 'block';
        return;
      } else {
        emptyHint.style.display = 'none';
      }
      const q = (filter||'').toLowerCase();
      const entries = Object.entries(games).filter(([k,g]) => {
        if (!g || !g.title) return false;
        if (!q) return true;
        return (g.title||'').toLowerCase().includes(q) || (g.category||'').toLowerCase().includes(q);
      }).sort((a,b)=> (a[1].title||'').localeCompare(b[1].title||''));
      for (const [id, game] of entries) {
        const card = document.createElement('div');
        card.className = 'card';
        card.tabIndex = 0;
        card.setAttribute('role','button');
        // thumb
        const img = document.createElement('img');
        img.className = 'logo-thumb';
        // If game.logo is a filename (e.g., "raftwars.png") we load from /logos/
        if (game.logo && !game.logo.startsWith('http')) {
          img.src = 'logos/' + game.logo;
        } else {
          img.src = game.logo || 'favicon.png';
        }
        img.alt = esc(game.title) + ' logo';
        // meta
        const meta = document.createElement('div');
        meta.className = 'meta';
        const t = document.createElement('div');
        t.className = 'title';
        t.textContent = esc(game.title);
        const cat = document.createElement('div');
        cat.className = 'cat';
        cat.textContent = (game.category || '');
        meta.appendChild(t);
        meta.appendChild(cat);

        card.appendChild(img);
        card.appendChild(meta);

        // click loads game into content area
        card.addEventListener('click', ()=> loadGame(id));
        card.addEventListener('keydown', (e)=> { if(e.key==='Enter') loadGame(id); });

        listArea.appendChild(card);
      }
    }

    // Load a game into the viewer area
    function loadGame(id) {
      const g = games[id];
      if (!g) return;
      // set header + logo + iframe
      gvTitle.textContent = g.title || 'Untitled';
      gvCategory.textContent = g.category ? g.category : '';
      if (g.logo) {
        if (g.logo.startsWith('http')) {
          gvLogo.src = g.logo;
        } else {
          gvLogo.src = 'logos/' + g.logo;
        }
        gvLogo.style.display = 'block';
      } else {
        gvLogo.style.display = 'none';
      }

      // Use iframe field (iframe) or fallback to url or page
      const src = g.iframe || g.url || g.page || '';
      // If src is empty, show message instead of iframe
      if (!src) {
        gameFrame.removeAttribute('src');
        gameFrame.style.display = 'none';
        gameFrameWrap.innerHTML = '<div style="padding:18px;color:var(--muted);background:#111;border-radius:8px;">No playable URL found for this game.</div>';
      } else {
        gameFrame.style.display = 'block';
        gameFrameWrap.innerHTML = ''; // clear to re-append iframe
        gameFrameWrap.appendChild(gameFrame);
        // set src last to avoid immediate navigation on element that's not in DOM (safer)
        gameFrame.src = src;
      }

      // show view area
      gameView.style.display = 'block';
      gameView.setAttribute('aria-hidden','false');

      // scroll view into visible area on small screens
      gameView.scrollIntoView({ behavior:'smooth', block:'start' });
    }

    // Close current game and return to list
    function closeGame() {
      // unload iframe
      try { gameFrame.src = 'about:blank'; } catch(e){}
      gameView.style.display = 'none';
      gameView.setAttribute('aria-hidden','true');
      // restore list focus
      const first = listArea.querySelector('.card');
      if (first) first.focus();
    }

    // Fullscreen support for gameFrameWrap
    async function toggleFullscreen() {
      if (!document.fullscreenElement) {
        try {
          await gameFrameWrap.requestFullscreen();
        } catch (err) {
          // some browsers require the iframe to be allowed for fullscreen; fallback: request on document
          try { await document.documentElement.requestFullscreen(); } catch(e){ console.warn('fs fail', e); }
        }
      } else {
        try { await document.exitFullscreen(); } catch(e){/*noop*/ }
      }
    }

    // ======= Wiring buttons =======
    closeBtn.addEventListener('click', closeGame);
    fsBtn.addEventListener('click', toggleFullscreen);
    refreshBtn.addEventListener('click', ()=> loadFromFirebase());

    search.addEventListener('input', ()=> renderList(search.value));

    // When ESC pressed and we are fullscreen, exit fullscreen; if viewing game, close it on ESC as well
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape') {
        if (document.fullscreenElement) {
          document.exitFullscreen().catch(()=>{});
        } else if (gameView.style.display === 'block') {
          closeGame();
        }
      }
    });

    // ======= Firebase loading =======
    async function loadFromFirebase() {
      try {
        const snap = await db.ref('games').once('value');
        const val = snap.val() || {};
        games = {};
        // Normalize entries: allow both plain-string values (title only) or object forms
        for (const key of Object.keys(val)) {
          const v = val[key];
          if (!v) continue;
          if (typeof v === 'string') {
            games[key] = { title: v, logo: '', iframe: '' };
          } else {
            // support both {title,logo,iframe,category} or older variations
            games[key] = {
              title: v.title || v.name || key,
              logo: v.logo || v.thumb || v.logoFile || '',
              iframe: v.iframe || v.url || v.page || '',
              category: v.category || ''
            };
          }
        }
        renderList(search.value);
      } catch (err) {
        console.error('Firebase load error', err);
        listArea.innerHTML = '<div class="empty">Failed to load games from Firebase.</div>';
      }
    }

    // Initial load & live updates (keeps list instantly updated)
    db.ref('games').on('value', ()=> loadFromFirebase());

    // Kick off first load
    loadFromFirebase();
  </script>
</body>
</html>
