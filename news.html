
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TAC News</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#070707;
      --panel:rgba(255,255,255,0.06);
      --muted:rgba(255,255,255,0.6);
      --accent: #19b56a; /* green accent */
      --accent-600: #12a85a;
      --glass-border: rgba(255,255,255,0.08);
      --card: rgba(0,0,0,0.45);
      color: white; /* default text color for dark mode */
    }
    [data-theme="light"]{
      --bg:#f6f7f9;
      --panel:rgba(0,0,0,0.04);
      --muted:rgba(0,0,0,0.6);
      --accent: #0a8f46;
      --accent-600:#07733a;
      --glass-border: rgba(0,0,0,0.06);
      --card: rgba(255,255,255,0.85);
      color: #111;
    }
    html,body{height:100%;margin:0;padding:0;background:var(--bg);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    .wrap{max-width:820px;margin:22px auto;padding:18px;}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .brand{font-weight:800;font-size:20px;cursor:pointer;user-select:none;display:flex;align-items:center;gap:10px}
    .logo{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-600));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;box-shadow:0 6px 18px rgba(0,0,0,0.45);transform:translateZ(0)}
    .controls{display:flex;gap:10px;align-items:center}
    .btn{background:var(--accent);color:white;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600;box-shadow:0 4px 10px rgba(0,0,0,0.25);transition:transform .12s ease}
    .btn:active{transform:translateY(1px)}
    .glass{background:var(--panel);border:1px solid var(--glass-border);border-radius:12px;padding:12px}
    .row{display:flex;gap:10px;align-items:center}
    input[type="text"], input[type="password"], .search{background:var(--card);border:1px solid var(--glass-border);padding:10px;border-radius:10px;outline:none;width:100%;color:inherit;} /* Added color:inherit */
    textarea{width:100%;min-height:70px;padding:10px;border-radius:10px;border:1px solid var(--glass-border);background:var(--card);color:inherit}
    .small{font-size:13px;color:var(--muted)}
    #newsList{margin-top:6px}
    .post{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(0,0,0,0.18), transparent);margin-bottom:10px;border:1px solid rgba(0,0,0,0.15);position:relative;overflow:hidden;transition:transform .18s, box-shadow .18s}
    .post:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,0.45)}
    .post .meta{font-size:12px;color:var(--muted);margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;gap:6px}
    .post .text{white-space:pre-wrap;font-size:15px}
    .pinned{border-left:4px solid var(--accent);padding-left:10px}
    .actions{margin-top:10px;display:flex;gap:8px;align-items:center}
    .icon-btn{background:transparent;border:none;color:var(--muted);cursor:pointer;padding:6px;border-radius:8px}
    .icon-btn:hover{color:var(--accent)}
    .reaction{display:inline-flex;gap:8px;align-items:center}
    .reaction button{background:transparent;border:none;font-size:16px;cursor:pointer;padding:6px;border-radius:8px;transition:transform .12s}
    .reaction button:active{transform:scale(.9)}
    .reaction .count{margin-left:6px;font-size:13px;color:var(--muted)}
    .fade-in{animation:fadeIn .28s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    /* reactive pop */
    .pop { animation:pop .38s ease; }
    @keyframes pop { 0%{transform:scale(.6);opacity:0}50%{transform:scale(1.15);opacity:1}100%{transform:scale(1);opacity:1} }

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:60}
    .modal{background:var(--card);padding:18px;border-radius:12px;min-width:300px;border:1px solid var(--glass-border)}
    .admin-icon{position:fixed;right:18px;bottom:18px;background:rgba(0,0,0,0.35);border-radius:10px;padding:8px;display:none;color:white;z-index:70}
    .admin-icon.show{display:block;background:linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.2));border:1px solid var(--glass-border);cursor:pointer;}
    .tiny{font-size:12px}
    /* mobile tweaks */
    @media(max-width:640px){
      .wrap{padding:12px}
      .brand{font-size:18px}
      .controls{flex-wrap:wrap;}
      .search{order: 1; min-width: 100%; margin-top: 10px;}
    }
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <div class="topbar">
      <div class="brand" id="brand">
        <div class="logo" title="TAC">TN</div>
        <div>
          <div style="line-height:1">TAC News</div>
          <div class="tiny small">Daily news</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="toggleTheme">Toggle Theme</button>
        <input class="search" id="searchInput" placeholder="Search posts..." />
        <button class="btn" id="refreshBtn" title="Force refresh">Refresh</button>
      </div>
    </div>

    <button id="adminIcon" class="admin-icon" title="Admin controls" onclick="openAdminPanel()">âš™</button>

    <div class="glass">
      <div class="row" style="justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:280px">
          <textarea id="newsInput" placeholder="What's happening today?"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <input type="text" id="nameInput" placeholder="Name (optional)" style="width:200px;padding:8px;border-radius:8px;border:1px solid var(--glass-border);background:var(--card)"/>
            <button class="btn" id="postBtn">Post</button>
            <div class="small" id="autoTxt" style="cursor:pointer">Auto-refresh: ON</div>
          </div>
        </div>
        <div style="width:200px;min-width:180px">
          <div class="small" style="margin-bottom:6px">Viewing Day</div>
          <div class="glass" id="todayBox" style="text-align:center;font-weight:600"></div>
          <div style="margin-top:8px;text-align:center">
            <button class="btn" id="viewPastBtn">View Past</button>
          </div>
        </div>
      </div>
    </div>

    <div class="glass" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Feed</h3>
        <div class="small">Pinned show first</div>
      </div>
      <div id="newsList" class="fade-in"></div>
    </div>

    <div class="glass" id="pastPanel" style="display:none;margin-top:12px">
      <h4 style="margin:0 0 8px 0">Past Days</h4>
      <div id="pastDates" class="small"></div>
    </div>
  </div>

  <div id="adminModal" style="display:none"></div>

<script type="module">
  // Corrected Firebase modular imports for version 9+
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
  import { getDatabase, ref, push, onValue, get, update, remove, set } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js";

  /* ---------- CONFIG ---------- */
  // NOTE: REPLACE THESE WITH YOUR ACTUAL FIREBASE CONFIG AND ADMIN KEY!
  const firebaseConfig = {
    apiKey: "AIzaSyBQslLAFRlIRJqsiJ2WWeTNslO067bzKYM",
    authDomain: "taclogin-ab38e.firebaseapp.com",
    databaseURL: "https://taclogin-ab38e-default-rtdb.firebaseio.com",
    projectId: "taclogin-ab38e",
    storageBucket: "taclogin-ab38e.firebasestorage.app",
    messagingSenderId: "937853298051",
    appId: "1:937853298051:web:119ccc7b5499514bd442b6"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  /* ---------- SETTINGS ---------- */
  const ADMIN_KEY = "tacdev1234"; // <-- replace with your secret admin key
  const REACTIONS = ["ðŸ”¥","ðŸ‘","ðŸ˜‚","ðŸ˜®","ðŸ˜¢"];
  const AUTO_REFRESH_MS = 8000;

  /* ---------- state ---------- */
  let currentView = getToday();
  let isAdmin = false;
  let autoRefresh = true;
  let refreshTimer = null;

  // user id to track reactions (stored locally)
  let userId = localStorage.getItem("tac_user_id") || cryptoRandomId();
  localStorage.setItem("tac_user_id", userId);

  // theme preference
  const savedTheme = localStorage.getItem("tac_theme");
  if(savedTheme) document.documentElement.setAttribute("data-theme", savedTheme);

  // elements
  const newsListEl = document.getElementById("newsList");
  const todayBox = document.getElementById("todayBox");
  const pastPanel = document.getElementById("pastPanel");
  const pastDatesEl = document.getElementById("pastDates");
  const adminIcon = document.getElementById("adminIcon");
  const adminModal = document.getElementById("adminModal");
  const searchInput = document.getElementById("searchInput");
  const autoTxt = document.getElementById("autoTxt");
  document.getElementById("todayBox").innerText = currentView;

  /* ---------- helpers ---------- */
  function getToday(){ return new Date().toISOString().split("T")[0]; }
  function cryptoRandomId(){ return 'u_' + Math.random().toString(36).slice(2,11); }
  function el(tag, attrs={}, children=[]){ const e=document.createElement(tag); for(const k in attrs) e[k]=attrs[k]; (Array.isArray(children)?children:[children]).forEach(c=>{ if(typeof c==='string') e.appendChild(document.createTextNode(c)); else if(c) e.appendChild(c) }); return e }

  /* ---------- UI behavior ---------- */

  // theme toggle
  document.getElementById("toggleTheme").addEventListener("click", ()=>{
    const cur = document.documentElement.getAttribute("data-theme");
    const next = cur === "light" ? "" : "light";
    if(next) document.documentElement.setAttribute("data-theme", next);
    else document.documentElement.removeAttribute("data-theme");
    localStorage.setItem("tac_theme", next);
  });

  // brand long-press to open admin login (not obvious)
  (function adminLongPress(){
    const brand = document.getElementById("brand");
    let t = null;
    brand.addEventListener("pointerdown", e => {
      // Prevent context menu on some devices
      e.preventDefault(); 
      t = setTimeout(()=> openAdminLogin(), 700); // long press 700ms
    });
    ["pointerup","pointerleave","pointercancel"].forEach(ev => brand.addEventListener(ev, ()=> clearTimeout(t)));
  })();

  // search filter
  searchInput.addEventListener("input", ()=> renderPosts(lastSnapshot));

  // manual refresh
  document.getElementById("refreshBtn").addEventListener("click", ()=> {
    loadView(currentView);
  });

  // view past toggle
  document.getElementById("viewPastBtn").addEventListener("click", ()=>{
    // Toggle visibility
    const isVisible = pastPanel.style.display === "block";
    pastPanel.style.display = isVisible ? "none" : "block";
    document.getElementById("viewPastBtn").innerText = isVisible ? "View Past" : "Hide Past";
    if(!isVisible) loadPastDates();
  });

  // post
  document.getElementById("postBtn").addEventListener("click", async ()=>{
    const text = document.getElementById("newsInput").value.trim();
    const name = document.getElementById("nameInput").value.trim() || "anon";
    if(!text) return;
    const postRef = ref(db, `news/${getToday()}`);
    await push(postRef, { text, time: new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'}), pinned:false, author:name, reactions:{} });
    document.getElementById("newsInput").value = "";
    document.getElementById("nameInput").value = "";
  });

  // auto-refresh toggle by clicking auto text
  autoTxt.addEventListener("click", ()=>{
    autoRefresh = !autoRefresh;
    autoTxt.innerText = `Auto-refresh: ${autoRefresh? "ON":"OFF"}`;
    if(autoRefresh) startAutoRefresh(); else stopAutoRefresh();
  });

  /* ---------- data loading ---------- */
  let lastSnapshot = null;
  let offCurrentViewListener = null;

  // live listener for "today" (keeps feed reactive)
  function attachTodayListener(day){
    // Detach previous listener if it exists
    if(offCurrentViewListener) offCurrentViewListener();

    offCurrentViewListener = onValue(ref(db, `news/${day}`), snap=>{
      lastSnapshot = snap;
      renderPosts(snap);
    });
  }

  // load arbitrary day (one-off get)
  async function loadView(day){
    currentView = day;
    todayBox.innerText = day;
    
    // If viewing today, use the live listener
    if(day === getToday()){
      // The attachTodayListener function already handles detaching the old one
      attachTodayListener(day);
    } else {
      // If viewing a past day, detach the live listener and perform a one-off get
      if(offCurrentViewListener) offCurrentViewListener();
      offCurrentViewListener = null;

      const snap = await get(ref(db, `news/${day}`));
      lastSnapshot = snap;
      renderPosts(snap);
    }
    // Also, if we change the view from today, stop auto-refreshing the *current* view 
    // since the live listener is gone/changed. The timer handles past days.
  }

  // get past dates list
  async function loadPastDates(){
    const snap = await get(ref(db, "news"));
    pastDatesEl.innerHTML = "";
    if(!snap.exists()) { pastDatesEl.innerHTML = "<div class='small'>No entries yet</div>"; return; }
    
    // Sort dates descending
    const days = Object.keys(snap.val()).sort().reverse();
    
    days.forEach(d=>{
      const btn = el('div', {className:'small', style:"cursor:pointer;padding:6px;border-radius:6px;margin-bottom:6px;border:1px solid var(--glass-border);background:var(--card)"}, [
        el('div', {}, [d]),
        el('div', {className:'tiny small', style:"color:var(--muted)"}, ["Click to view"])
      ]);
      // Highlight current day in the list
      if(d === currentView) {
        btn.style.border = `1px solid var(--accent)`;
        btn.style.fontWeight = 'bold';
      }
      btn.addEventListener("click", ()=> loadView(d));
      pastDatesEl.appendChild(btn);
    });
  }

  /* ---------- render ---------- */
  function renderPosts(snap){
    newsListEl.innerHTML = "";
    if(!snap || !snap.exists()){
      newsListEl.innerHTML = "<div class='small' style='padding:12px'>No posts.</div>";
      return;
    }
    const data = snap.val();
    // convert and sort: pinned first, then by the order in the database (which is Firebase's timestamp order)
    let entries = Object.entries(data).map(([id, val])=>({id, ...val}));
    
    entries.sort((a,b)=>{
      // Pinned first
      if(a.pinned && !b.pinned) return -1;
      if(!a.pinned && b.pinned) return 1;
      
      // Fallback by key/time. Firebase keys are timestamp based, so sorting by ID works for chronological order.
      if(a.id < b.id) return 1; // Reverse order (newest first based on key)
      if(a.id > b.id) return -1;
      return 0;
    });

    const q = (searchInput.value || "").toLowerCase();

    entries.forEach(post=>{
      if(q){
        const hay = `${post.text} ${post.author || ""}`.toLowerCase();
        if(!hay.includes(q)) return;
      }
      const node = renderPostNode(post);
      newsListEl.appendChild(node);
    });
    
    // If the view is switched, reload past dates to highlight the current day
    if(pastPanel.style.display === "block") loadPastDates();
  }

  function renderPostNode(post){
    const container = el('div', {className: `post ${post.pinned? 'pinned':''} fade-in`});
    const meta = el('div', {className:'meta'}, [
      el('div', {}, [`${post.author ? post.author : 'anon'}`]),
      el('div', {}, [`${post.time || ''}`])
    ]);
    const text = el('div', {className:'text'}, [post.text]);

    // bottom row actions
    const actions = el('div', {className:'actions'});
    // reactions
    const reactWrap = el('div', {className:'reaction'});
    REACTIONS.forEach((emoji)=>{
      const btn = el('button', {innerText: emoji});
      // Count reactions for this emoji
      const count = (post.reactions && Object.values(post.reactions).filter(r=>r===emoji).length) || 0;
      const ct = el('span', {className:'count', innerText: count||''});
      
      // Check if current user has reacted with this emoji
      const userReaction = post.reactions && post.reactions[userId] === emoji;
      if(userReaction) {
        btn.style.border = `1px solid var(--accent)`;
        btn.style.borderRadius = '6px';
      }
      
      btn.addEventListener("click", ()=> handleReact(post.id, emoji, btn));
      reactWrap.appendChild(btn);
      reactWrap.appendChild(ct);
    });

    // share button
    const shareBtn = el('button', {className:'icon-btn', title:'Copy post text', innerText:'ðŸ”—'});
    shareBtn.addEventListener("click", ()=> {
      navigator.clipboard?.writeText(`${post.text}\nâ€” ${post.author || 'anon'} (${post.time || ''})`).then(()=> {
        shareBtn.classList.add('pop');
        setTimeout(()=>shareBtn.classList.remove('pop'),380);
      });
    });

    actions.appendChild(reactWrap);
    actions.appendChild(shareBtn);

    // if admin, show admin controls
    if(isAdmin){
      const editBtn = el('button', {className:'icon-btn', title:'Edit', innerText:'âœï¸'});
      const delBtn = el('button', {className:'icon-btn', title:'Delete', innerText:'ðŸ—‘ï¸'});
      const pinBtn = el('button', {className:'icon-btn', title: post.pinned ? 'Unpin':'Pin', innerText: post.pinned?'ðŸ“Œ':'ðŸ“'}); // Changed pin icon when pinned/unpinned
      editBtn.addEventListener("click", ()=> adminEdit(post));
      delBtn.addEventListener("click", ()=> adminDelete(post));
      pinBtn.addEventListener("click", ()=> adminTogglePin(post));
      actions.appendChild(editBtn);
      actions.appendChild(pinBtn);
      actions.appendChild(delBtn);
    }

    container.appendChild(meta);
    container.appendChild(text);
    container.appendChild(actions);
    return container;
  }

  /* ---------- reactions handling ---------- */
  async function handleReact(postId, emoji, btnEl){
    // store reaction under news/<day>/<postId>/reactions/<userId> = emoji
    const path = `news/${currentView}/${postId}/reactions/${userId}`;
    const reactionRef = ref(db, path);
    
    // Read then update/remove
    const existingSnap = await get(reactionRef);
    const current = existingSnap.exists() ? existingSnap.val() : null;
    
    let isToggled = false;
    if(current === emoji){
      // Remove (toggle off)
      await set(reactionRef, null);
    } else {
      // Set or replace (toggle on)
      await set(reactionRef, emoji);
      isToggled = true;
    }
    
    // Optimistic UI: no need to manually update count as onValue listener handles it
    btnEl.classList.add('pop');
    setTimeout(()=>btnEl.classList.remove('pop'),380);
  }

  /* ---------- admin actions ---------- */
  function openAdminLogin(){
    // ... admin login modal code (kept original)
    adminModal.innerHTML = `
      <div class="modal-backdrop">
        <div class="modal glass">
          <h3 style="margin-top:0">Admin Access</h3>
          <input id="admKey" type="password" placeholder="Enter admin key" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--glass-border);background:var(--card)"/>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
            <button id="admCancel" class="btn">Cancel</button>
            <button id="admOk" class="btn">Unlock</button>
          </div>
          <div class="small" style="margin-top:8px;color:var(--muted)">Pro tip: long-press the TAC title to open this.</div>
        </div>
      </div>
    `;
    adminModal.style.display = "block";
    document.getElementById("admCancel").addEventListener("click", ()=> { adminModal.style.display = "none"; adminModal.innerHTML = ""; });
    document.getElementById("admOk").addEventListener("click", ()=> {
      const k = document.getElementById("admKey").value.trim();
      if(k === ADMIN_KEY && ADMIN_KEY !== "YOUR_ADMIN_KEY_HERE"){ // Added check for placeholder key
        isAdmin = true;
        adminModal.style.display = "none"; adminModal.innerHTML = "";
        adminIcon.classList.add('show');
        localStorage.setItem("news_admin_key", k);
        startAdminPanel();
        loadView(currentView);
      } else {
        alert("nah.");
      }
    });
  }

  // Check stored login on load
  if(localStorage.getItem("news_admin_key") === ADMIN_KEY && ADMIN_KEY !== "YOUR_ADMIN_KEY_HERE"){
    isAdmin = true;
    adminIcon.classList.add('show');
    startAdminPanel();
  }

  function startAdminPanel(){
    adminIcon.classList.add('show');
    // Admin icon is visible
  }

  function openAdminPanel(){
    // ... admin panel modal code (kept original)
    adminModal.innerHTML = `
      <div class="modal-backdrop">
        <div class="modal glass">
          <h3 style="margin-top:0">Admin Panel</h3>
          <div style="display:flex;gap:8px;flex-direction:column">
            <button id="clearTodayBtn" class="btn">âš  Clear Today (${getToday()})</button>
            <div style="display:flex;gap:8px">
              <input id="adminTargetDay" placeholder="YYYY-MM-DD" value="${currentView}" style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--glass-border);background:var(--card)"/>
              <button id="clearDayBtn" class="btn" style="width:100px;">Clear Day</button>
            </div>
            <button id="downloadJson" class="btn">Export All (JSON)</button>
            <button id="logoutAdmin" class="btn" style="background:red">Logout Admin</button>
            <div style="display:flex;gap:8px">
              <button id="closeAdmin" class="btn" style="flex:1">Close</button>
            </div>
            <div class="small" style="color:var(--muted);margin-top:8px">Use with care. Actions are destructive.</div>
          </div>
        </div>
      </div>
    `;
    document.getElementById("closeAdmin").addEventListener("click", ()=> { adminModal.style.display = "none"; adminModal.innerHTML = ""; });
    document.getElementById("logoutAdmin").addEventListener("click", ()=>{
      localStorage.removeItem("news_admin_key");
      isAdmin = false;
      adminIcon.classList.remove('show');
      adminModal.style.display='none'; 
      adminModal.innerHTML='';
      loadView(currentView); // Refresh to hide admin controls
    });
    document.getElementById("clearTodayBtn").addEventListener("click", async ()=>{
      if(confirm(`Really clear today (${getToday()})? THIS IS DESTRUCTIVE.`)){ 
        await set(ref(db, `news/${getToday()}`), null); // Use null to remove the day node
        alert("Cleared."); 
        adminModal.style.display='none'; 
        adminModal.innerHTML=''; 
      }
    });
    document.getElementById("clearDayBtn").addEventListener("click", async ()=>{
      const d = document.getElementById("adminTargetDay").value.trim();
      if(!d) return alert("Enter day in YYYY-MM-DD format.");
      if(confirm(`Are you sure you want to clear ALL posts for ${d}? THIS IS DESTRUCTIVE.`)){
        await set(ref(db, `news/${d}`), null); // Use null to remove the day node
        alert(`Cleared day: ${d}.`);
        adminModal.style.display='none'; 
        adminModal.innerHTML='';
        loadView(currentView);
      }
    });
    document.getElementById("downloadJson").addEventListener("click", async ()=>{
      const snap = await get(ref(db,"news"));
      const data = snap.exists() ? snap.val() : {};
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = `tac-news-${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
    });
    adminModal.style.display = "block";
  }

  async function adminEdit(post){
    const newText = prompt("Edit post text:", post.text);
    if(newText===null) return;
    await update(ref(db, `news/${currentView}/${post.id}`), { text:newText, time: new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'}) + ' (edited)' }); // Add (edited) to time
  }

  async function adminDelete(post){
    if(!confirm("Delete this post?")) return;
    await remove(ref(db, `news/${currentView}/${post.id}`));
  }

  async function adminTogglePin(post){
    await update(ref(db, `news/${currentView}/${post.id}`), { pinned: !post.pinned });
  }

  /* ---------- utilities ---------- */

  async function init(){
    await loadView(getToday());
    if(autoRefresh) startAutoRefresh();
  }

  function startAutoRefresh(){
    if(refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(()=> {
      // Only force refresh non-today views. The 'today' view is updated live by onValue.
      if(currentView !== getToday()){
        loadView(currentView);
      } else if (currentView === getToday()){
        // Also ensure currentView is correct if day changes while app is open
        todayBox.innerText = currentView;
      }
    }, AUTO_REFRESH_MS);
    autoTxt.innerText = `Auto-refresh: ON`;
  }
  function stopAutoRefresh(){
    if(refreshTimer) clearInterval(refreshTimer);
    refreshTimer = null;
    autoTxt.innerText = `Auto-refresh: OFF`;
  }
  
  // initial startup
  init();

  // tiny accessibility: press "Escape" in search to clear
  searchInput.addEventListener('keydown', (e)=>{ if(e.key==='Escape') { searchInput.value=''; renderPosts(lastSnapshot); } });

  // small UI polish: show date on todayBox
  todayBox.innerText = getToday();

</script>
</body>
</html>