<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sign in – Google Accounts</title>
    <!-- Placeholder favicon -->
    <link rel="icon" type="image/png" href="https://placehold.co/16x16/0a8c2d/ffffff?text=G" />
    <style>
        /* General Setup */
        html,body { height: 100%; margin: 0; font-family: 'Inter', Arial, Helvetica, sans-serif; }
        body { background: #f1f1f1; display: flex; justify-content: center; align-items: center; }
        /* Container Styling */
        .container {
            width: 360px;
            max-width: 90%;
            background: #fff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,.1);
            text-align: center;
        }
        .google-logo { width: 75px; margin-bottom: 20px; }
        h2 { font-size: 24px; font-weight: 400; margin-bottom: 24px; }
        /* Form Elements */
        input {
            width: 100%;
            padding: 10px;
            margin: 12px 0;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        input:focus { outline: none; border-color: #1a73e8; box-shadow: 0 0 0 1px #1a73e8; }
        /* PIN Input specific styling (to center text) */
        .pin-input { text-align: center; font-size: 24px; letter-spacing: 5px; }

        button {
            width: 100%;
            padding: 10px;
            background: #1a73e8;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-top: 16px;
            transition: background 0.3s;
        }
        button:hover { background: #0c5adb; }
        .secondary-button {
            background: #f0f0f0;
            color: #3c4043;
            border: 1px solid #dadce0;
        }
        .secondary-button:hover { background: #e8e8e8; }

        /* Links and Messages */
        .error { color: #d93025; margin-top: 5px; font-size: 12px; }
        .small-link { font-size: 12px; color:#1a73e8; cursor:pointer; margin-top: 10px; text-decoration: none; }
        .small-link:hover { text-decoration: underline; }
        .big-link { font-size: 14px; color: #4caf50; font-weight: 600; }
        .recent-account-info {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .user-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #c2e7ff;
            color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 18px;
            margin-right: 15px;
        }
        .user-name-text { font-size: 16px; font-weight: 500; color: #3c4043; }
        .sign-out-link { margin-top: 20px; font-size: 12px; color: #3c4043; cursor: pointer; }
        .sign-out-link:hover { color: #d93025; }

        /* Video Overlay (from original code) */
        #videoOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;display:none;justify-content:center;align-items:center;z-index:9999;cursor:none;flex-direction:column}
        #videoOverlay video{width:100%;height:100%;object-fit:cover;display:block}
    </style>
</head>
<body>

<div class="container" id="login-container">
    <img src="https://www.google.com/images/branding/googlelogo/1x/googlelogo_color_92x30dp.png" class="google-logo" alt="Logo" />
    <h2>Sign in</h2>

    <!-- NEW: Step 1 - Recent Account Check (Default View if local storage is set) -->
    <div id="step-recent-account" style="display:none;">
        <div class="recent-account-info">
            <div class="user-icon" id="recent-user-icon">U</div>
            <span class="user-name-text" id="recent-user-name">User</span>
        </div>
        <p style="font-size: 14px; color: #3c4043;">Unlock your account with your 4-digit PIN.</p>
        <input id="pin-input" class="pin-input" type="number" pattern="\d{4}" maxlength="4" placeholder="••••" oninput="if(this.value.length>this.maxLength)this.value=this.value.slice(0,this.maxLength)" />
        <div class="error" id="pin-error"></div>
        <button onclick="checkPin()">Unlock</button>
        <p class="small-link" onclick="goToStandardLogin()">Sign in with a different account</p>
    </div>

    <!-- NEW: Step 2 - Set PIN (If user has no PIN set yet) -->
    <div id="step-set-pin" style="display:none;">
        <p style="font-size: 14px; color: #3c4043;">Set a 4-digit PIN for quick access to <span id="set-pin-username" class="user-name-text"></span>.</p>
        <input id="new-pin-input" class="pin-input" type="number" pattern="\d{4}" maxlength="4" placeholder="••••" oninput="if(this.value.length>this.maxLength)this.value=this.value.slice(0,this.maxLength)" />
        <input id="confirm-new-pin-input" class="pin-input" type="number" pattern="\d{4}" maxlength="4" placeholder="Confirm ••••" oninput="if(this.value.length>this.maxLength)this.value=this.value.slice(0,this.maxLength)" />
        <div class="error" id="set-pin-error"></div>
        <button onclick="setPin()">Set PIN & Sign in</button>
    </div>

    <!-- Original Steps (Hidden by default, shown if no local user or 'Sign in with a different account' is clicked) -->
    <div id="step-username">
        <input id="username" placeholder="Email or phone" autocomplete="username" />
        <div class="error" id="username-error"></div>
        <button onclick="checkUsername()">Next</button>
        <p id="create-account-link" class="small-link" onclick="showCreateAccount()">Create account</p>
        <p class="error" id="no-account-msg" style="display:none;margin-top:6px">You don't have an account! Try creating one.</p>
    </div>

    <div id="step-password" style="display:none">
        <input id="password" type="password" placeholder="Enter your password" autocomplete="current-password"/>
        <div class="error" id="password-error"></div>
        <button onclick="checkPassword()">Next</button>
        <p class="small-link" id="forgotBtn">Forgot password?</p>
    </div>

    <div id="step-change-password" style="display:none">
        <input id="new-password" type="password" placeholder="New password" />
        <input id="confirm-password" type="password" placeholder="Confirm new password" />
        <div class="error" id="change-error"></div>
        <button onclick="saveNewPassword()">Save Password</button>
    </div>

    <div id="step-create" style="display:none">
        <input id="new-username" placeholder="Choose your username" autocomplete="username" />
        <div class="error" id="create-error"></div>
        <button onclick="createAccount()">Submit</button>
        <p style="margin-top:8px">Your request will be sent for approval.</p>
    </div>
    
</div>
<!-- Sign out link always visible for convenience -->
<p class="sign-out-link" id="signOutLink" onclick="logout()" style="position: absolute; bottom: 20px;">Sign Out</p>


<div id="videoOverlay">
    <video id="combinedVideo" playsinline preload="auto"></video>
</div>

<!-- Firebase Scripts (using provided versions) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBQslLAFRlIRJqsiJ2WWeTNslO067bzKYM",
        authDomain: "taclogin-ab38e.firebaseapp.com",
        databaseURL: "https://taclogin-ab38e-default-rtdb.firebaseio.com",
        projectId: "taclogin-ab38e",
        storageBucket: "taclogin-ab38e.firebasestorage.app",
        messagingSenderId: "937853298051",
        appId: "1:937853298051:web:119ccc7b5499514bd442b6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentUser = "";

    // Global utility to hide all steps and reset errors
    function hideAllSteps() {
        ['step-username', 'step-password', 'step-change-password', 'step-create', 'step-recent-account', 'step-set-pin'].forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
    }

    // Reset error messages and link styles
    function resetErrors() {
        ['username-error', 'password-error', 'create-error', 'change-error', 'pin-error', 'set-pin-error'].forEach(id => {
            document.getElementById(id).innerText = '';
        });
        document.getElementById('no-account-msg').style.display = 'none';
        document.getElementById('create-account-link').classList.remove('big-link');
    }

    // Runs on page load to check for a previously logged-in user
    window.onload = function() {
        const lastUser = localStorage.getItem('lastLoggedInUser');
        if (lastUser) {
            currentUser = lastUser;
            showPinLogin();
        } else {
            document.getElementById('step-username').style.display = 'block';
        }
    }

    // Final action after any successful login path (Password or PIN)
    function loginSuccess() {
        // 1. Store/Update the last logged-in user in Local Storage
        localStorage.setItem('lastLoggedInUser', currentUser);

        // 2. Perform original Firebase login tracking
        db.ref('logins/' + currentUser).transaction(c => (c || 0) + 1);
        db.ref('totalLogins').transaction(c => (c || 0) + 1);

        // 3. Trigger video overlay (original success action)
        showVideoOverlay();
    }

    // ---------- NEW PIN LOGIN FLOW ----------

    // Show the PIN login interface
    function showPinLogin() {
        hideAllSteps();
        resetErrors();
        document.getElementById('step-recent-account').style.display = 'block';
        document.getElementById('recent-user-name').innerText = currentUser;
        document.getElementById('recent-user-icon').innerText = currentUser.charAt(0).toUpperCase();
        document.getElementById('pin-input').value = '';
    }

    // Switch to the standard username/password login form
    function goToStandardLogin() {
        hideAllSteps();
        document.getElementById('step-username').style.display = 'block';
        // Clear current user state to force full login path
        currentUser = "";
        document.getElementById('username').value = "";
    }

    // Check the entered 4-digit PIN
    function checkPin() {
        resetErrors();
        const pin = document.getElementById('pin-input').value.trim();
        const errorEl = document.getElementById('pin-error');

        if (!pin || pin.length !== 4 || isNaN(pin)) {
            errorEl.innerText = 'PIN must be 4 digits.';
            return;
        }

        // Check if the user has a PIN saved in Firebase
        db.ref('userPins/' + currentUser).once('value').then(snap => {
            const savedPin = snap.val();
            if (!savedPin) {
                // No PIN found, prompt to set one
                showSetPin();
            } else if (pin === savedPin) {
                // PIN Match
                loginSuccess();
            } else {
                // PIN Mismatch
                errorEl.innerText = 'Incorrect PIN.';
            }
        }).catch(err => {
            console.error("Firebase PIN fetch error:", err);
            errorEl.innerText = 'An error occurred. Try standard login.';
        });
    }

    // Show the interface to set a new 4-digit PIN
    function showSetPin() {
        hideAllSteps();
        resetErrors();
        document.getElementById('step-set-pin').style.display = 'block';
        document.getElementById('set-pin-username').innerText = currentUser;
        document.getElementById('new-pin-input').value = '';
        document.getElementById('confirm-new-pin-input').value = '';
    }

    // Save the new 4-digit PIN to Firebase
    function setPin() {
        resetErrors();
        const newPin = document.getElementById('new-pin-input').value.trim();
        const confirmPin = document.getElementById('confirm-new-pin-input').value.trim();
        const errorEl = document.getElementById('set-pin-error');

        if (!newPin || newPin.length !== 4 || isNaN(newPin) || !confirmPin || confirmPin.length !== 4 || isNaN(confirmPin)) {
            errorEl.innerText = 'Both PINs must be 4 digits.';
            return;
        }
        if (newPin !== confirmPin) {
            errorEl.innerText = 'PINs do not match.';
            return;
        }

        // Save the PIN to the dedicated path
        db.ref('userPins/' + currentUser).set(newPin)
          .then(() => {
              loginSuccess();
          })
          .catch(err => {
              console.error("Firebase PIN save error:", err);
              errorEl.innerText = 'Failed to save PIN. Try again.';
          });
    }

    // Clear local storage and log out
    function logout() {
        localStorage.removeItem('lastLoggedInUser');
        currentUser = "";
        window.location.reload();
    }


    // ---------- ORIGINAL LOGIN FLOW (MODIFIED TO CALL loginSuccess) ----------

    function checkUsername() {
        resetErrors();
        const username = document.getElementById('username').value.trim();
        if (!username) { document.getElementById('username-error').innerText = 'Enter a username'; return; }

        db.ref('allowedUsers/' + username).once('value').then(snap => {
            if (snap.exists()) {
                currentUser = username;
                document.getElementById('step-username').style.display = 'none';
                document.getElementById('step-password').style.display = 'block';
            } else {
                document.getElementById('no-account-msg').style.display = 'block';
                document.getElementById('create-account-link').classList.add('big-link');
            }
        });
    }

    function checkPassword() {
        resetErrors();
        const password = document.getElementById('password').value.trim();

        db.ref('userPasswords/' + currentUser).once('value').then(snap => {
            const savedPassword = snap.val();
            if (!savedPassword && password === 'tac') {
                // first-time login with TAC → force password change
                document.getElementById('step-password').style.display = 'none';
                document.getElementById('step-change-password').style.display = 'block';
            } else if (password === savedPassword) {
                // normal login - MODIFIED to call loginSuccess
                loginSuccess();
            } else {
                document.getElementById('password-error').innerText = 'Wrong password';
                db.ref('failedLogins').push({ username: currentUser, triedPassword: password, time: new Date().toISOString() });
            }
        });
    }

    function saveNewPassword() {
        resetErrors();
        const newPwd = document.getElementById('new-password').value.trim();
        const confirmPwd = document.getElementById('confirm-password').value.trim();
        if (!newPwd || !confirmPwd) { document.getElementById('change-error').innerText = 'Enter both fields'; return; }
        if (newPwd !== confirmPwd) { document.getElementById('change-error').innerText = 'Passwords do not match'; return; }
        db.ref('userPasswords/' + currentUser).set(newPwd);
        // MODIFIED to call loginSuccess
        loginSuccess();
    }

    // ---------- CREATE ACCOUNT (Original Logic) ----------

    function showCreateAccount() {
        resetErrors();
        document.getElementById('step-username').style.display = 'none';
        document.getElementById('step-create').style.display = 'block';
        document.getElementById('new-username').value = document.getElementById('username').value.trim();
    }

    function createAccount() {
        resetErrors();
        const newUser = document.getElementById('new-username').value.trim();
        if (!newUser) { document.getElementById('create-error').innerText = 'Enter a username'; return; }

        Promise.all([ db.ref('allowedUsers/' + newUser).once('value'), db.ref('pendingAccounts/' + newUser).once('value') ])
        .then(([allowedSnap, pendingSnap]) => {
            if (allowedSnap.exists()) { document.getElementById('create-error').innerText = 'Account already approved. Please login.'; }
            else if (pendingSnap.exists()) { document.getElementById('create-error').innerText = 'Account creation pending approval.'; }
            else {
                db.ref('pendingAccounts/' + newUser).set({ requestedAt: new Date().toISOString() });
                // Using a custom message box instead of alert, but for simplicity here I'll stick to a basic text update/simple alert for this less critical path.
                alert('Account request sent for approval. You will be notified once approved.');
                document.getElementById('step-create').style.display = 'none';
                document.getElementById('step-username').style.display = 'block';
            }
        });
    }

    // ---------- FORGOT PASSWORD (Original Logic) ----------
    document.getElementById('forgotBtn').addEventListener('click', () => {
        if (!currentUser) { alert('Enter your username first'); return; }
        db.ref('notifications').push({
            type: 'forgotPassword',
            user: currentUser,
            time: new Date().toISOString()
        });
        alert('Dev team notified. They will reset your password.');
    });


    // ---------- VIDEO OVERLAY (Original Logic) ----------
    const overlay = document.getElementById('videoOverlay');
    const videoEl = document.getElementById('combinedVideo');

    function makeRedirectUrl() {
        const href = window.location.href;
        const folder = href.substring(0, href.lastIndexOf('/') + 1);
        return folder + 'index.html';
    }

    function showVideoOverlay() {
        overlay.style.display = 'flex';
        document.body.style.cursor = 'none';
        videoEl.src = 'combined.mp4';
        videoEl.muted = false;
        videoEl.currentTime = 0;
        videoEl.play();
        videoEl.onended = () => { window.location.replace(makeRedirectUrl()); };
    }
</script>
</body>
</html>