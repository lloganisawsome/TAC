<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Login</title>
<link rel="icon" type="image/png" href="https://clouddrivecdn.classlink.com/favicons/2051/icon/favicon-32x32.png?1721076899121" sizes="32x32">

<link href="https://cdn.classlink.com/production/launchpad/resources/bootstrap-3.4.1/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.classlink.com/production/launchpad/resources/font-awesome-4.5.0/css/font-awesome.css" rel="stylesheet">
<link href="https://cdn.classlink.com/production/launchpad/css/login/login.css" rel="stylesheet">
<link href="https://cdn.classlink.com/production/framework/stylesheets/cl-lp-loginscreen.css" rel="stylesheet">


<!-- Fonts -->
<link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,300,600|Lato:400,400italic|Roboto" rel="stylesheet">

<style>
body {
  background: url(https://filescdn.classlink.com/resources/tenants/2051/backgrounds/1722879311078-52c94f352f342ad55dec26965e7f2554) no-repeat center center fixed;
  background-size: cover;
  font-family: 'Open Sans', 'Lato', 'Roboto', sans-serif;
}
.btn-primary.google {
  background: #4285f4 !important;
  border: solid 1px #4285f4 !important;
  box-shadow: 0px 4px 0px 0px #3062B3 !important;
}
.btn-primary.google:hover { background-color: rgba(66, 133, 244, .7) !important; }
a.link-center{vertical-align: middle;line-height: 2.0;}
#videoOverlay {
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:#000;
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
  cursor:none;
  flex-direction:column;
}
#videoOverlay video {
  width:100%; height:100%;
  object-fit:cover;
  display:block;
}
</style>
</head>
<body class="login-bg">

<div class="navbar navbar-default navbar-fixed-top2 text-center"></div>

<div class="container login" id="login_form_action">
  <div class="container1">
    <div class="heading">
      <h1 style="color:#ffffff !important">Waxahachie ISD</h1>
    </div>
    <div class="row">
      <div class="col-xs-12">
        <form id="loginForm">
          <div class="form-group username-container">
            <input type="text" autofocus autocomplete="off" id="username" name="username" class="form-control" placeholder=" " required>
            <span class="floating-label">Username</span>
          </div>
          <div class="form-group password-row-container">
            <div class="form-group password-field password-container">
              <input type="password" autocomplete="off" class="form-control hideShowPassword-hidden" placeholder=" " name="password" id="password" required>
              <span class="floating-label">Password</span>
            </div>
            <button type="button" class="show-password fa fa-eye-slash">
              <input id="show-password-input" type="checkbox" checked>
            </button>
          </div>
          <div class="form-group code-container" style="display:none;">
            <input type="text" class="form-control" id="code" name="code" placeholder=" " value="waxahachie">
            <span class="floating-label">Code (optional)</span>
          </div>
          <button type="submit" id="signin" class="btn btn-primary btn-block btnlogin">Sign In</button>
        </form>

        <button title="Sign in with Google" class="btn btn-primary btn-block google" id="googleSignIn">
          <img src="https://cdn.classlink.com/production/framework/assets/images/lp-login/btn_google.png" alt="">
          <span>Sign in with Google</span>
        </button>
      </div>
    </div>
  </div>
</div>

<div id="videoOverlay">
  <video id="combinedVideo" playsinline preload="auto"></video>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, get, child, set, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBQslLAFRlIRJqsiJ2WWeTNslO067bzKYM",
  authDomain: "taclogin-ab38e.firebaseapp.com",
  databaseURL: "https://taclogin-ab38e-default-rtdb.firebaseio.com",
  projectId: "taclogin-ab38e",
  storageBucket: "taclogin-ab38e.firebasestorage.app",
  messagingSenderId: "937853298051",
  appId: "1:937853298051:web:119ccc7b5499514bd442b6"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
let currentUser = "";

// ---------- UTILS ----------
function showVideoOverlay(){
  const overlay = document.getElementById('videoOverlay');
  const videoEl = document.getElementById('combinedVideo');
  overlay.style.display='flex';
  document.body.style.cursor='none';
  videoEl.src='combined.mp4';
  videoEl.muted=false;
  videoEl.currentTime=0;
  videoEl.play();
  videoEl.onended = () => {
    const folder = window.location.href.substring(0, window.location.href.lastIndexOf('/')+1);
    window.location.replace(folder + 'index.html');
  };
}

// ---------- LOGIN ----------
document.getElementById('loginForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;

  try {
    const snapshot = await get(child(ref(db), `userPasswords/${username}`));
    if(!snapshot.exists()){ alert("User not found!"); return; }
    const storedPassword = snapshot.val();

    if(storedPassword !== password){
      const failRef = ref(db, `failedLogins/${username}`);
      const failSnap = await get(failRef);
      const fails = failSnap.exists()? failSnap.val()+1 : 1;
      await set(failRef, fails);
      alert("Incorrect password!");
      return;
    }

    // Successful login â†’ update DB & show video
    const userRef = ref(db, `logins/${username}`);
    const loginsSnap = await get(userRef);
    const totalLogins = loginsSnap.exists()? loginsSnap.val()+1 : 1;
    await set(userRef, totalLogins);
    showVideoOverlay();

  } catch(err){
    console.error(err);
    alert("Error logging in: "+err.message);
  }
});

// Optional Google button
document.getElementById('googleSignIn').addEventListener('click',()=>{
});
</script>

</body>
</html>
