<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Classlink</title>
    <link rel="icon" href="https://clouddrivecdn.classlink.com/favicons/2051/icon/apple-touch-icon.png?1721076899121">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        html, body { height: 100%; margin: 0; background: #000; overflow: hidden; }
        iframe { position: fixed; inset: 0; border: 0; width: 100%; height: 100%; display: block; z-index: 1; }
        
        #mini-call-popup {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 250px;
            background: rgba(17, 17, 17, 0.98);
            border: 1px solid #333;
            border-left: 4px solid #25ffa0;
            border-radius: 8px;
            padding: 15px;
            z-index: 9999;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #fff;
        }
        .popup-header { font-size: 10px; color: #888; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1.5px; }
        .caller-name { font-size: 18px; font-weight: bold; color: #25ffa0; margin-bottom: 15px; }
        .action-row { display: flex; gap: 10px; }
        button { flex: 1; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 12px; transition: opacity 0.2s; }
        button:active { opacity: 0.7; }
        .btn-answer { background: #25ffa0; color: #111; }
        .btn-decline { background: #ff5f56; color: #fff; }
        
        #active-indicator {
            display: none;
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 8px;
            height: 8px;
            background: #25ffa0;
            border-radius: 50%;
            z-index: 9998;
            box-shadow: 0 0 8px #25ffa0;
        }
    </style>
</head>
<body>

<iframe id="main_iframe"></iframe>

<div id="mini-call-popup">
    <div class="popup-header">Incoming Secure Call</div>
    <div class="caller-name" id="popup-caller">Unknown</div>
    <div class="action-row">
        <button class="btn-answer" id="btn-answer">Answer</button>
        <button class="btn-decline" id="btn-decline">Decline</button>
    </div>
</div>

<div id="active-indicator" title="Call Connected"></div>
<audio id="ringtone" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3" loop></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, remove, onDisconnect, update, get } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const TAC_URL = 'https://lloganisawsome.github.io/TAC/home.html';
    const PANIC_URL = 'https://launchpad.classlink.com/wisd';

    const firebaseConfig = {
        apiKey: "AIzaSyBQslLAFRlIRJqsiJ2WWeTNslO067bzKYM",
        authDomain: "taclogin-ab38e.firebaseapp.com",
        databaseURL: "https://taclogin-ab38e-default-rtdb.firebaseio.com",
        projectId: "taclogin-ab38e",
        storageBucket: "taclogin-ab38e.firebasestorage.app",
        messagingSenderId: "937853298051",
        appId: "1:937853298051:web:119ccc7b5499514bd442b6"
    };

    document.getElementById('main_iframe').src = TAC_URL;

    // Panic Key
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'p') {
            e.preventDefault();
            window.location.replace(PANIC_URL);
        }
    });

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const ringtone = document.getElementById('ringtone');
    
    const sessionId = Math.random().toString(36).substr(2, 9);
    let peer = null, localStream = null, currentCall = null;
    let myExt = null;

    function checkLogin() {
        const ext = localStorage.getItem('userPhoneNumber');
        if (ext) {
            myExt = ext;
            // Requirement: Save "newfle" on login detection
            localStorage.setItem('newfle', 'true');
            initSystem(ext);
        } else {
            setTimeout(checkLogin, 1000);
        }
    }

    function initSystem(rawExt) {
        if (peer) return;

        // Use Session ID logic to match the main app's multi-session fix
        peer = new Peer(`TAC-SESSION-${sessionId}`);

        peer.on('open', () => {
            console.log("Stealth Session Active:", sessionId);
            
            // Register session in Switchboard
            const sRef = ref(db, `sessions/${rawExt}/${sessionId}`);
            set(sRef, { active: true, lastSeen: Date.now(), stealth: true });
            onDisconnect(sRef).remove();

            // Heartbeat
            setInterval(() => update(sRef, { lastSeen: Date.now() }), 10000);

            setupListeners(rawExt);
        });

        peer.on('call', (incoming) => {
            currentCall = incoming;
        });

        if (Notification.permission !== "granted") Notification.requestPermission();
    }

    function setupListeners(rawExt) {
        // Listen for calls targeted SPECIFICALLY at this stealth session
        onValue(ref(db, `calls/${rawExt}/${sessionId}`), async (snap) => {
            const data = snap.val();
            if (data && data.status === 'ringing') {
                
                // Fetch contact name for the popup
                const contactSnap = await get(ref(db, `users/${rawExt}/contacts/${data.from}`));
                const name = contactSnap.val() ? contactSnap.val().name : `Ext ${data.from}`;

                document.getElementById('popup-caller').innerText = name;
                document.getElementById('mini-call-popup').style.display = 'block';
                ringtone.play().catch(() => {});

                if (Notification.permission === "granted") {
                    new Notification("Incoming Secure Call", { body: "From: " + name });
                }
            } else if (data && data.status === 'connected') {
                document.getElementById('mini-call-popup').style.display = 'none';
                document.getElementById('active-indicator').style.display = 'block';
                ringtone.pause();
            } else {
                cleanupUI();
            }
        });
    }

    document.getElementById('btn-answer').onclick = async () => {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            if (currentCall) {
                currentCall.answer(localStream);
                currentCall.on('stream', (remoteStream) => {
                    const audio = new Audio();
                    audio.srcObject = remoteStream;
                    audio.play();
                });
                currentCall.on('close', cleanupUI);

                // Notify caller we connected
                const signalSnap = await get(ref(db, `calls/${myExt}/${sessionId}`));
                const caller = signalSnap.val();
                if (caller) {
                    update(ref(db, `calls/${caller.from}/${caller.fromSession}`), { status: 'connected' });
                }
                update(ref(db, `calls/${myExt}/${sessionId}`), { status: 'connected' });
            }
        } catch (e) {
            console.error("Mic error", e);
        }
    };

    document.getElementById('btn-decline').onclick = () => {
        if (currentCall) currentCall.close();
        remove(ref(db, `calls/${myExt}/${sessionId}`));
        cleanupUI();
    };

    function cleanupUI() {
        document.getElementById('mini-call-popup').style.display = 'none';
        document.getElementById('active-indicator').style.display = 'none';
        ringtone.pause();
        ringtone.currentTime = 0;
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
    }

    checkLogin();
</script>
</body>
</html>